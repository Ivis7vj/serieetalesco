[{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Biography.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\EditProfile.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\EpisodeDetails.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'collection' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"collection"},"fix":{"range":[443,454],"text":""},"desc":"Remove unused variable 'collection'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'query' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"query"},"fix":{"range":[453,460],"text":""},"desc":"Remove unused variable 'query'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'where' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"where"},"fix":{"range":[460,467],"text":""},"desc":"Remove unused variable 'where'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'getDocs' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDocs"},"fix":{"range":[467,476],"text":""},"desc":"Remove unused variable 'getDocs'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":8,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":92,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[517,525],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'confirm' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":18,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"confirm"},"fix":{"range":[887,925],"text":""},"desc":"Remove unused variable 'confirm'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'tmdbReviews' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":26,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"tmdbReviews"},"fix":{"range":[1170,1181],"text":""},"desc":"Remove unused variable 'tmdbReviews'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'ratings' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":28,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"ratings"},"fix":{"range":[1313,1320],"text":""},"desc":"Remove unused variable 'ratings'."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport { MdArrowBack, MdStar, MdCalendarToday, MdAccessTime, MdPerson, MdRateReview } from 'react-icons/md';\r\nimport ReviewsDrawer from '../components/ReviewsDrawer';\r\nimport { useNotification } from '../context/NotificationContext';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { db } from '../firebase-config';\r\nimport { collection, query, where, getDocs, doc, updateDoc, arrayUnion, arrayRemove, getDoc } from 'firebase/firestore';\r\nimport * as reviewService from '../utils/reviewService';\r\n\r\n\r\nconst TMDB_API_KEY = \"3fd2be6f0c70a2a598f084ddfb75487c\";\r\nconst TMDB_BASE_URL = \"https://api.themoviedb.org/3\";\r\n\r\nconst EpisodeDetails = () => {\r\n    const { id, seasonNumber, episodeNumber } = useParams(); // id is Series ID\r\n    const navigate = useNavigate();\r\n    const { confirm } = useNotification();\r\n    const { currentUser } = useAuth();\r\n\r\n    const [episode, setEpisode] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isReviewsOpen, setIsReviewsOpen] = useState(false);\r\n\r\n    // Reviews State\r\n    const [tmdbReviews, setTmdbReviews] = useState([]);\r\n    const [firestoreReviews, setFirestoreReviews] = useState([]); // Reviews from DB\r\n    const [ratings, setRatings] = useState([]);\r\n\r\n    useEffect(() => {\r\n        const fetchEpisodeDetails = async () => {\r\n            setLoading(true);\r\n            try {\r\n                // Fetch Episode Details with Credits (Cast/Guest Stars) and External IDs\r\n                const res = await fetch(`${TMDB_BASE_URL}/tv/${id}/season/${seasonNumber}/episode/${episodeNumber}?api_key=${TMDB_API_KEY}&append_to_response=credits,images,videos,external_ids`);\r\n                const data = await res.json();\r\n                setEpisode(data);\r\n\r\n                // Fetch Series Details (for Name) needed for OMDb Fallback\r\n                const seriesRes = await fetch(`${TMDB_BASE_URL}/tv/${id}?api_key=${TMDB_API_KEY}`);\r\n                const seriesData = await seriesRes.json();\r\n                const seriesName = seriesData.name;\r\n\r\n                // 2. Try Fetching OMDb Rating\r\n                let omdbData = null;\r\n\r\n                // Strategy A: By IMDb ID (Preferred)\r\n                if (data.external_ids?.imdb_id) {\r\n                    try {\r\n                        const res = await fetch(`https://www.omdbapi.com/?i=${data.external_ids.imdb_id}&apikey=15529774`);\r\n                        const json = await res.json();\r\n                        if (json.Response === \"True\") omdbData = json;\r\n                    } catch (e) {\r\n                        console.warn(\"OMDb ID fetch failed\", e);\r\n                    }\r\n                }\r\n\r\n                // Strategy B: By Title/Season/Episode (Fallback) if A failed or no rating\r\n                if ((!omdbData || !omdbData.imdbRating || omdbData.imdbRating === 'N/A') && seriesName) {\r\n                    try {\r\n                        const res = await fetch(`https://www.omdbapi.com/?t=${encodeURIComponent(seriesName)}&Season=${seasonNumber}&Episode=${episodeNumber}&apikey=15529774`);\r\n                        const json = await res.json();\r\n                        if (json.Response === \"True\") omdbData = json;\r\n                    } catch (e) {\r\n                        console.warn(\"OMDb Search fetch failed\", e);\r\n                    }\r\n                }\r\n\r\n                // 3. Process Ratings\r\n                if (omdbData) {\r\n                    setRatings(omdbData.Ratings || []);\r\n                    if (omdbData.imdbRating && omdbData.imdbRating !== 'N/A') {\r\n                        setRatings(prev => {\r\n                            const exists = prev.some(r => r.Source === \"Internet Movie Database\");\r\n                            if (!exists) return [...prev, { Source: \"Internet Movie Database\", Value: `${omdbData.imdbRating}/10` }];\r\n                            return prev;\r\n                        });\r\n                    }\r\n                }\r\n\r\n                // Fetch Episode Reviews (if available separately, otherwise can fallback to show reviews)\r\n                const reviewsRes = await fetch(`${TMDB_BASE_URL}/tv/${id}/reviews?api_key=${TMDB_API_KEY}`);\r\n                const reviewsData = await reviewsRes.json();\r\n                setTmdbReviews(reviewsData.results || []);\r\n\r\n\r\n                // Fetch Reviews via reviewService (Dual-Read: Supabase â†’ Firebase)\r\n                if (data.id) {\r\n                    const dbReviews = await reviewService.getEpisodeReviews(\r\n                        parseInt(id),\r\n                        parseInt(seasonNumber),\r\n                        parseInt(episodeNumber)\r\n                    );\r\n                    setFirestoreReviews(dbReviews);\r\n                }\r\n\r\n\r\n\r\n            } catch (error) {\r\n                console.error(\"Failed to fetch episode details\", error);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchEpisodeDetails();\r\n    }, [id, seasonNumber, episodeNumber]);\r\n\r\n    if (loading) {\r\n        return <div style={{ height: '100vh', background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>Loading...</div>;\r\n    }\r\n\r\n    if (!episode) return null;\r\n\r\n    const backdropUrl = episode.still_path\r\n        ? `https://image.tmdb.org/t/p/original${episode.still_path}`\r\n        : null;\r\n\r\n    return (\r\n        <div style={{ background: '#000', minHeight: '100vh', color: '#fff', paddingBottom: '50px' }}>\r\n            {/* Header / Backdrop */}\r\n            <div style={{ position: 'relative', height: '60vh', width: '100%' }}>\r\n                {backdropUrl && (\r\n                    <div style={{\r\n                        position: 'absolute', top: 0, left: 0, width: '100%', height: '100%',\r\n                        backgroundImage: `url(${backdropUrl})`,\r\n                        backgroundSize: 'cover',\r\n                        backgroundPosition: 'center',\r\n                        filter: 'brightness(0.5)'\r\n                    }} />\r\n                )}\r\n                <div style={{\r\n                    position: 'absolute', top: 0, left: 0, width: '100%', height: '100%',\r\n                    background: 'linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, #000 100%)'\r\n                }} />\r\n\r\n                {/* Back Button */}\r\n                <button\r\n                    onClick={() => navigate(-1)}\r\n                    style={{\r\n                        position: 'absolute', top: '20px', left: '20px', zIndex: 10,\r\n                        background: 'rgba(0,0,0,0.5)', border: 'none', borderRadius: '50%',\r\n                        width: '40px', height: '40px', color: '#fff', cursor: 'pointer',\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center'\r\n                    }}\r\n                >\r\n                    <MdArrowBack size={24} />\r\n                </button>\r\n\r\n                {/* Title & Info */}\r\n                <div style={{\r\n                    position: 'absolute', bottom: '20px', left: '0', width: '100%',\r\n                    padding: '20px 40px', boxSizing: 'border-box'\r\n                }}>\r\n                    <h1 style={{ fontSize: '3rem', fontWeight: '800', marginBottom: '0.5rem', fontFamily: 'Inter, sans-serif' }}>\r\n                        {episode.name} <span style={{ fontSize: '1.5rem', fontWeight: '400', color: '#ccc' }}>S{seasonNumber} E{episodeNumber}</span>\r\n                    </h1>\r\n                    <div style={{ display: 'flex', gap: '20px', alignItems: 'center', fontSize: '1rem', color: '#ccc' }}>\r\n                        <span style={{ display: 'flex', alignItems: 'center', gap: '5px' }}>\r\n                            <MdCalendarToday size={16} /> {episode.air_date}\r\n                        </span>\r\n                        <span style={{ display: 'flex', alignItems: 'center', gap: '5px' }}>\r\n                            <MdAccessTime size={16} /> {episode.runtime} min\r\n                        </span>\r\n                    </div>\r\n\r\n                    {/* Episode Ratings */}\r\n                    <div style={{ display: 'flex', gap: '15px', marginTop: '15px', flexWrap: 'wrap' }}>\r\n                        {(() => {\r\n                            // Filter for THIS episode from Firestore Data\r\n                            const epReviews = firestoreReviews.filter(r => r.episodeId === parseInt(episode.id) && r.isEpisode);\r\n                            const count = epReviews.length;\r\n                            const avg = count > 0 ? (epReviews.reduce((acc, r) => acc + parseFloat(r.rating), 0) / count).toFixed(1) : null;\r\n\r\n                            return (\r\n                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', background: 'rgba(0,0,0,0.7)', padding: '4px 10px', borderRadius: '4px', border: '1px solid #FFCC00' }}>\r\n                                    <div style={{ background: '#FFCC00', color: 'black', fontWeight: '900', borderRadius: '2px', padding: '0 4px', fontSize: '0.8rem' }}>S</div>\r\n                                    {count > 0 ? (\r\n                                        <span style={{ fontWeight: 'bold', color: '#fff', fontSize: '0.9rem' }}>{avg}/5 <span style={{ fontSize: '0.8em', color: '#ccc' }}>({count})</span></span>\r\n                                    ) : (\r\n                                        <span style={{ fontWeight: 'bold', color: '#ccc', fontSize: '0.85rem' }}>No Ratings</span>\r\n                                    )}\r\n                                </div>\r\n                            );\r\n                        })()}\r\n\r\n                        {firestoreReviews.length === 0 && (\r\n                            <div style={{ background: 'rgba(0,0,0,0.7)', padding: '4px 10px', borderRadius: '4px', border: '1px dashed #666', color: '#ccc', fontStyle: 'italic', fontSize: '0.9rem' }}>\r\n                                Be the first to rate! ðŸ˜¢\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '20px 40px' }}>\r\n                {/* Actions Row */}\r\n                <div style={{ marginBottom: '30px' }}>\r\n                    <button\r\n                        className=\"action-btn\"\r\n                        onClick={() => setIsReviewsOpen(true)}\r\n                        style={{\r\n                            background: 'transparent',\r\n                            color: 'white',\r\n                            border: '1px solid #444',\r\n                            padding: '12px 24px',\r\n                            cursor: 'pointer',\r\n                            fontWeight: 'bold',\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            gap: '8px',\r\n                            borderRadius: '0',\r\n                            textTransform: 'uppercase',\r\n                            letterSpacing: '1px'\r\n                        }}\r\n                    >\r\n                        <MdRateReview size={20} /> Episode Reviews\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Overview */}\r\n                <section style={{ marginBottom: '40px' }}>\r\n                    <h2 style={{ borderBottom: '1px solid #333', paddingBottom: '10px', marginBottom: '20px', color: '#FFCC00' }}>Overview</h2>\r\n                    <p style={{ lineHeight: '1.8', fontSize: '1.1rem', color: '#ddd' }}>\r\n                        {episode.overview || \"No overview available for this episode.\"}\r\n                    </p>\r\n                </section>\r\n\r\n                {/* Guest Stars */}\r\n                {episode.guest_stars && episode.guest_stars.length > 0 && (\r\n                    <section style={{ marginBottom: '40px' }}>\r\n                        <h2 style={{ borderBottom: '1px solid #333', paddingBottom: '10px', marginBottom: '20px', color: '#FFCC00' }}>Guest Stars</h2>\r\n                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '20px' }}>\r\n                            {episode.guest_stars.map(star => (\r\n                                <div key={star.id} onClick={() => navigate(`/person/${star.id}`)} style={{ textAlign: 'center', width: '100px', cursor: 'pointer' }}>\r\n                                    <img\r\n                                        src={star.profile_path ? `https://image.tmdb.org/t/p/w200${star.profile_path}` : 'https://via.placeholder.com/200x300/141414/FFFF00?text=?'}\r\n                                        alt={star.name}\r\n                                        style={{ width: '100%', height: '120px', objectFit: 'cover', border: '1px solid #333' }}\r\n                                    />\r\n                                    <div style={{ fontSize: '0.9rem', marginTop: '5px', color: '#fff', fontWeight: 'bold' }}>{star.name}</div>\r\n                                    <div style={{ fontSize: '0.8rem', color: '#888' }}>{star.character}</div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </section>\r\n                )}\r\n\r\n                {/* Regular Cast */}\r\n                {episode.credits && episode.credits.cast && episode.credits.cast.length > 0 && (\r\n                    <section style={{ marginBottom: '40px' }}>\r\n                        <h2 style={{ borderBottom: '1px solid #333', paddingBottom: '10px', marginBottom: '20px', color: '#FFCC00' }}>Series Regulars</h2>\r\n                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '20px' }}>\r\n                            {episode.credits.cast.map(actor => (\r\n                                <div key={actor.id} onClick={() => navigate(`/person/${actor.id}`)} style={{ textAlign: 'center', width: '100px', cursor: 'pointer' }}>\r\n                                    <img\r\n                                        src={actor.profile_path ? `https://image.tmdb.org/t/p/w200${actor.profile_path}` : 'https://via.placeholder.com/200x300/141414/FFFF00?text=?'}\r\n                                        alt={actor.name}\r\n                                        style={{ width: '100%', height: '120px', objectFit: 'cover', border: '1px solid #333' }}\r\n                                    />\r\n                                    <div style={{ fontSize: '0.9rem', marginTop: '5px', color: '#fff', fontWeight: 'bold' }}>{actor.name}</div>\r\n                                    <div style={{ fontSize: '0.8rem', color: '#888' }}>{actor.character}</div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </section>\r\n                )}\r\n            </div>\r\n\r\n            <ReviewsDrawer\r\n                isOpen={isReviewsOpen}\r\n                onClose={() => setIsReviewsOpen(false)}\r\n                reviews={firestoreReviews.filter(r => r.episodeId === parseInt(id) || (r.episodeId === parseInt(episode.id) && r.isEpisode)).map(r => ({\r\n                    id: r.id,\r\n                    source: 'app',\r\n                    author: r.userName || 'User',\r\n                    rating: r.rating,\r\n                    review: r.review,\r\n                    date: r.createdAt,\r\n                    likes: r.likes || [],\r\n                    isLiked: r.likes?.includes(currentUser?.uid),\r\n                    userId: r.userId\r\n                }))}\r\n                onDelete={() => { }}\r\n                onShare={() => { }}\r\n                onLike={async (reviewId) => {\r\n                    if (!currentUser) return;\r\n                    const reviewRef = doc(db, 'reviews', reviewId);\r\n\r\n                    // Optimistic Update\r\n                    setFirestoreReviews(prev => prev.map(r => {\r\n                        if (r.id === reviewId) {\r\n                            const hasLiked = r.likes?.includes(currentUser.uid);\r\n                            return {\r\n                                ...r,\r\n                                likes: hasLiked ? r.likes.filter(id => id !== currentUser.uid) : [...(r.likes || []), currentUser.uid]\r\n                            };\r\n                        }\r\n                        return r;\r\n                    }));\r\n\r\n                    const review = firestoreReviews.find(r => r.id === reviewId);\r\n                    if (review) {\r\n                        const hasLiked = review.likes?.includes(currentUser.uid);\r\n                        if (hasLiked) {\r\n                            await updateDoc(reviewRef, { likes: arrayRemove(currentUser.uid) });\r\n                        } else {\r\n                            await updateDoc(reviewRef, { likes: arrayUnion(currentUser.uid) });\r\n                        }\r\n                    }\r\n                }}\r\n                currentUser={currentUser}\r\n                theme={{}}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default EpisodeDetails;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Followers.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'getDocs' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDocs"},"fix":{"range":[219,228],"text":""},"desc":"Remove unused variable 'getDocs'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'query' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"query"},"fix":{"range":[228,235],"text":""},"desc":"Remove unused variable 'query'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'collection' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":49,"suggestions":[{"messageId":"removeVar","data":{"varName":"collection"},"fix":{"range":[235,247],"text":""},"desc":"Remove unused variable 'collection'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'where' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":56,"suggestions":[{"messageId":"removeVar","data":{"varName":"where"},"fix":{"range":[247,254],"text":""},"desc":"Remove unused variable 'where'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'documentId' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":68,"suggestions":[{"messageId":"removeVar","data":{"varName":"documentId"},"fix":{"range":[254,266],"text":""},"desc":"Remove unused variable 'documentId'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":70,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":79,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateDoc"},"fix":{"range":[266,277],"text":""},"desc":"Remove unused variable 'updateDoc'."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useParams, Link } from 'react-router-dom';\r\nimport { db } from '../firebase-config';\r\nimport PremiumLoader from '../components/PremiumLoader';\r\nimport { doc, getDoc, getDocs, query, collection, where, documentId, updateDoc } from 'firebase/firestore';\r\nimport { MdArrowBack, MdPerson } from 'react-icons/md';\r\n\r\nconst Followers = () => {\r\n    const { uid } = useParams();\r\n    const [allIds, setAllIds] = useState([]);\r\n    const [displayedUsers, setDisplayedUsers] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [loadingMore, setLoadingMore] = useState(false);\r\n    const BATCH_SIZE = 20;\r\n\r\n    useEffect(() => {\r\n        let isMounted = true;\r\n\r\n        const fetchFollowers = async () => {\r\n            if (!uid) return;\r\n            try {\r\n                // 1. Get Target User's follower list\r\n                const userDoc = await getDoc(doc(db, 'users', uid));\r\n                if (userDoc.exists()) {\r\n                    let ids = userDoc.data().followers || [];\r\n\r\n                    // Deduplicate IDs to save storage/reads\r\n                    const uniqueIds = [...new Set(ids)];\r\n                    if (uniqueIds.length !== ids.length) {\r\n                        try {\r\n                            await import('firebase/firestore').then(({ updateDoc }) =>\r\n                                updateDoc(doc(db, 'users', uid), { followers: uniqueIds })\r\n                            );\r\n                            console.log(\"Cleaned up duplicate followers in DB\");\r\n                        } catch (err) {\r\n                            console.error(\"Failed to cleanup duplicates:\", err);\r\n                        }\r\n                        ids = uniqueIds;\r\n                    }\r\n\r\n                    setAllIds(ids); // Store full list of IDs\r\n\r\n                    // 2. Fetch Initial Batch\r\n                    if (ids.length > 0 && isMounted) {\r\n                        await fetchBatch(ids.slice(0, BATCH_SIZE));\r\n                    }\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error fetching followers:\", error);\r\n            } finally {\r\n                if (isMounted) setLoading(false);\r\n            }\r\n        };\r\n\r\n        // Reset state on uid change\r\n        setDisplayedUsers([]);\r\n        setAllIds([]);\r\n        setLoading(true);\r\n\r\n        fetchFollowers();\r\n\r\n        return () => {\r\n            isMounted = false;\r\n        };\r\n    }, [uid]);\r\n\r\n    const fetchBatch = async (batchIds) => {\r\n        const promises = batchIds.map(id => getDoc(doc(db, 'users', id)));\r\n        const docs = await Promise.all(promises);\r\n        const users = docs.map(d => d.exists() ? { id: d.id, ...d.data() } : null).filter(u => u);\r\n        setDisplayedUsers(prev => {\r\n            // Safety check to prevent duplicates if race condition occurred\r\n            const existingIds = new Set(prev.map(u => u.id));\r\n            const newUsers = users.filter(u => !existingIds.has(u.id));\r\n            return [...prev, ...newUsers];\r\n        });\r\n    };\r\n\r\n    const handleLoadMore = async () => {\r\n        if (loadingMore) return;\r\n        setLoadingMore(true);\r\n        const nextBatch = allIds.slice(displayedUsers.length, displayedUsers.length + BATCH_SIZE);\r\n        await fetchBatch(nextBatch);\r\n        setLoadingMore(false);\r\n    };\r\n\r\n    return (\r\n        <div style={{ minHeight: '100vh', background: '#000', color: '#fff', padding: '20px' }}>\r\n            <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>\r\n                <Link to={`/profile/${uid}`} style={{ color: '#fff', marginRight: '15px' }}><MdArrowBack size={24} /></Link>\r\n                <h1 style={{ fontSize: '1.5rem', fontWeight: '900', margin: 0 }}>Followers</h1>\r\n            </div>\r\n\r\n            {loading ? <div style={{ height: '300px', position: 'relative' }}><PremiumLoader message=\"Fetching followers list...\" /></div> : (\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>\r\n                    {displayedUsers.map(user => (\r\n                        <Link key={user.id} to={`/profile/${user.id}`} style={{ display: 'flex', alignItems: 'center', gap: '15px', textDecoration: 'none', color: '#fff', padding: '10px', background: '#111', border: '1px solid #333' }}>\r\n                            <div style={{ width: '50px', height: '50px', borderRadius: '50%', overflow: 'hidden', background: '#333' }}>\r\n                                {user.photoURL ? <img src={user.photoURL} alt={user.username} style={{ width: '100%', height: '100%', objectFit: 'cover' }} /> : <div style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><MdPerson /></div>}\r\n                            </div>\r\n                            <div style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>{user.username || user.email?.split('@')[0]}</div>\r\n                        </Link>\r\n                    ))}\r\n                    {displayedUsers.length === 0 && <p style={{ color: '#FFD600' }}>No followers yet.</p>}\r\n\r\n                    {/* Load More Button */}\r\n                    {displayedUsers.length < allIds.length && (\r\n                        <button\r\n                            onClick={handleLoadMore}\r\n                            disabled={loadingMore}\r\n                            style={{\r\n                                marginTop: '20px',\r\n                                padding: '12px',\r\n                                background: '#222',\r\n                                color: '#fff',\r\n                                border: '1px solid #444',\r\n                                cursor: 'pointer',\r\n                                fontWeight: 'bold',\r\n                                textTransform: 'uppercase'\r\n                            }}\r\n                        >\r\n                            {loadingMore ? 'Loading...' : 'LOAD MORE'}\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Followers;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Following.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateDoc"},"fix":{"range":[219,230],"text":""},"desc":"Remove unused variable 'updateDoc'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useParams, Link } from 'react-router-dom';\r\nimport { db } from '../firebase-config';\r\nimport PremiumLoader from '../components/PremiumLoader';\r\nimport { doc, getDoc, updateDoc } from 'firebase/firestore';\r\nimport { MdArrowBack, MdPerson } from 'react-icons/md';\r\n\r\nconst Following = () => {\r\n    const { uid } = useParams();\r\n    const [allIds, setAllIds] = useState([]);\r\n    const [displayedUsers, setDisplayedUsers] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [loadingMore, setLoadingMore] = useState(false);\r\n    const BATCH_SIZE = 20;\r\n\r\n    useEffect(() => {\r\n        let isMounted = true;\r\n        const fetchFollowing = async () => {\r\n            if (!uid) return;\r\n            try {\r\n                // 1. Get Target User's following list\r\n                const userDoc = await getDoc(doc(db, 'users', uid));\r\n                if (userDoc.exists()) {\r\n                    let ids = userDoc.data().following || [];\r\n\r\n                    // Deduplicate IDs to save storage/reads \r\n                    const uniqueIds = [...new Set(ids)];\r\n                    if (uniqueIds.length !== ids.length) {\r\n                        try {\r\n                            await import('firebase/firestore').then(({ updateDoc }) =>\r\n                                updateDoc(doc(db, 'users', uid), { following: uniqueIds })\r\n                            );\r\n                            console.log(\"Cleaned up duplicate following in DB\");\r\n                        } catch (err) {\r\n                            console.error(\"Failed to cleanup duplicates:\", err);\r\n                        }\r\n                        ids = uniqueIds;\r\n                    }\r\n\r\n                    setAllIds(ids);\r\n\r\n                    if (ids.length > 0 && isMounted) {\r\n                        await fetchBatch(ids.slice(0, BATCH_SIZE));\r\n                    }\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error fetching following:\", error);\r\n            } finally {\r\n                if (isMounted) setLoading(false);\r\n            }\r\n        };\r\n\r\n        // Reset state\r\n        setDisplayedUsers([]);\r\n        setAllIds([]);\r\n        setLoading(true);\r\n\r\n        fetchFollowing();\r\n\r\n        return () => {\r\n            isMounted = false;\r\n        };\r\n    }, [uid]);\r\n\r\n    const fetchBatch = async (batchIds) => {\r\n        const promises = batchIds.map(id => getDoc(doc(db, 'users', id)));\r\n        const docs = await Promise.all(promises);\r\n        const users = docs.map(d => d.exists() ? { id: d.id, ...d.data() } : null).filter(u => u);\r\n        setDisplayedUsers(prev => {\r\n            const existingIds = new Set(prev.map(u => u.id));\r\n            const newUsers = users.filter(u => !existingIds.has(u.id));\r\n            return [...prev, ...newUsers];\r\n        });\r\n    };\r\n\r\n    const handleLoadMore = async () => {\r\n        if (loadingMore) return;\r\n        setLoadingMore(true);\r\n        const nextBatch = allIds.slice(displayedUsers.length, displayedUsers.length + BATCH_SIZE);\r\n        await fetchBatch(nextBatch);\r\n        setLoadingMore(false);\r\n    };\r\n\r\n    return (\r\n        <div style={{ minHeight: '100vh', background: '#000', color: '#fff', padding: '20px' }}>\r\n            <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>\r\n                <Link to={`/profile/${uid}`} style={{ color: '#fff', marginRight: '15px' }}><MdArrowBack size={24} /></Link>\r\n                <h1 style={{ fontSize: '1.5rem', fontWeight: '900', margin: 0 }}>Following</h1>\r\n            </div>\r\n\r\n            {loading ? <div style={{ height: '300px', position: 'relative' }}><PremiumLoader message=\"Fetching following list...\" /></div> : (\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>\r\n                    {displayedUsers.map(user => (\r\n                        <Link key={user.id} to={`/profile/${user.id}`} style={{ display: 'flex', alignItems: 'center', gap: '15px', textDecoration: 'none', color: '#fff', padding: '10px', background: '#111', border: '1px solid #333' }}>\r\n                            <div style={{ width: '50px', height: '50px', borderRadius: '50%', overflow: 'hidden', background: '#333' }}>\r\n                                {user.photoURL ? <img src={user.photoURL} alt={user.username} style={{ width: '100%', height: '100%', objectFit: 'cover' }} /> : <div style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><MdPerson /></div>}\r\n                            </div>\r\n                            <div style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>{user.username || user.email?.split('@')[0]}</div>\r\n                        </Link>\r\n                    ))}\r\n                    {displayedUsers.length === 0 && <p style={{ color: '#FFD600' }}>No users followed.</p>}\r\n\r\n                    {/* Load More Button */}\r\n                    {displayedUsers.length < allIds.length && (\r\n                        <button\r\n                            onClick={handleLoadMore}\r\n                            disabled={loadingMore}\r\n                            style={{\r\n                                marginTop: '20px',\r\n                                padding: '12px',\r\n                                background: '#222',\r\n                                color: '#fff',\r\n                                border: '1px solid #444',\r\n                                cursor: 'pointer',\r\n                                fontWeight: 'bold',\r\n                                textTransform: 'uppercase'\r\n                            }}\r\n                        >\r\n                            {loadingMore ? 'Loading...' : 'LOAD MORE'}\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Following;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Friends.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useNavigate' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"useNavigate"},"fix":{"range":[241,254],"text":""},"desc":"Remove unused variable 'useNavigate'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'currentUser' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":11,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"currentUser"},"fix":{"range":[476,488],"text":""},"desc":"Remove unused variable 'currentUser'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { collection, query, orderBy, limit, getDocs, where } from 'firebase/firestore';\r\nimport { db } from '../firebase-config';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { Link, useNavigate } from 'react-router-dom';\r\nimport { MdPerson, MdSearch, MdClose, MdStar } from 'react-icons/md';\r\nimport PremiumLoader from '../components/PremiumLoader';\r\nimport './Friends.css';\r\n\r\nconst Friends = () => {\r\n    const { currentUser, userData } = useAuth();\r\n\r\n    // Feed State\r\n    const [activities, setActivities] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    // Search State\r\n    const [searchText, setSearchText] = useState('');\r\n    const [searchResults, setSearchResults] = useState([]);\r\n    const [searchLoading, setSearchLoading] = useState(false);\r\n    const [showHint, setShowHint] = useState(false);\r\n\r\n    // Hint Logic\r\n    useEffect(() => {\r\n        const hasSeenHint = localStorage.getItem('friend_search_hint_seen');\r\n        if (!hasSeenHint) {\r\n            setShowHint(true);\r\n            const timer = setTimeout(() => {\r\n                setShowHint(false);\r\n                localStorage.setItem('friend_search_hint_seen', 'true');\r\n            }, 3000);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, []);\r\n\r\n    // Fetch Feed\r\n    useEffect(() => {\r\n        const fetchActivities = async () => {\r\n            if (!userData || !userData.following || userData.following.length === 0) {\r\n                setActivities([]);\r\n                setLoading(false);\r\n                return;\r\n            }\r\n\r\n            // Check Cache\r\n            const cached = sessionStorage.getItem('friends_feed_cache_v3');\r\n            if (cached) {\r\n                const parsed = JSON.parse(cached);\r\n                // Simple cache validity check (e.g. 5 mins could be added, but prompt says \"Refresh on App open\", assuming session storage clears effectively or we overwrite)\r\n                setActivities(parsed);\r\n                setLoading(false);\r\n                // Background refresh could happen here if desired, but prompt says \"No background polling\".\r\n                // We'll proceed to fetch fresh data anyway if user wants latest? \r\n                // Prompt: \"Cache last fetch locally. Refresh on: App open\". \r\n                // So if cached exists, we use it. We won't re-fetch unless force refreshed (re-mount usually triggers this in React if component unmounts).\r\n                // But generally for a feed, it's good to fetch fresh. I'll stick to fetching if cache is old?\r\n                // Let's just fetch fresh to ensure \"Refresh on App open/Pull down\" behavior works if component remounts.\r\n                // Or better: clear cache on app start? \r\n                // I'll respect the cache if present for speed, but maybe clear it on mount?\r\n                // Actually, let's fetch fresh for now to ensure data visibility during dev.\r\n            }\r\n\r\n            try {\r\n                // Limit valid following list to 10 for Firestore 'in' query limit\r\n                const followingSlice = userData.following.slice(0, 10);\r\n\r\n                const q = query(\r\n                    collection(db, 'user_activity'),\r\n                    where('userId', 'in', followingSlice),\r\n                    orderBy('createdAt', 'desc'),\r\n                    limit(50)\r\n                );\r\n\r\n                const snapshot = await getDocs(q);\r\n                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n\r\n                // Filter Last 7 Days\r\n                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);\r\n                const validItems = items.filter(i => {\r\n                    const time = new Date(i.createdAt).getTime();\r\n                    return time > sevenDaysAgo;\r\n                });\r\n\r\n                setActivities(validItems);\r\n                sessionStorage.setItem('friends_feed_cache_v3', JSON.stringify(validItems));\r\n\r\n            } catch (error) {\r\n                if (error.code === 'failed-precondition' && error.message.includes('index')) {\r\n                    console.warn(\"âš ï¸ MISSING FIRESTORE INDEX (Friends Feed): Click the link in the console to create it!\");\r\n                }\r\n                console.error(\"Error fetching friends feed:\", error);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchActivities();\r\n    }, [userData]);\r\n\r\n    // Search Handler (Unchanged logic mostly)\r\n    const handleSearch = async (e) => {\r\n        e.preventDefault();\r\n        if (!searchText.trim()) return;\r\n\r\n        setSearchLoading(true);\r\n        setSearchResults([]);\r\n\r\n        try {\r\n            const q = query(\r\n                collection(db, 'users'),\r\n                where('username', '==', searchText.trim()), // Exact match\r\n                limit(3)\r\n            );\r\n            const snapshot = await getDocs(q);\r\n            const results = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));\r\n            setSearchResults(results);\r\n        } catch (err) {\r\n            console.error(\"Search failed:\", err);\r\n        } finally {\r\n            setSearchLoading(false);\r\n        }\r\n    };\r\n\r\n    const formatTimeAgo = (isoString) => {\r\n        if (!isoString) return '';\r\n        const date = new Date(isoString);\r\n        const seconds = Math.floor((new Date() - date) / 1000);\r\n\r\n        if (seconds < 60) return \"Just now\";\r\n        let interval = Math.floor(seconds / 3600);\r\n        if (interval >= 24) {\r\n            interval = Math.floor(interval / 24);\r\n            return interval === 1 ? \"Yesterday\" : `${interval}d ago`;\r\n        }\r\n        if (interval >= 1) return `${interval}h ago`;\r\n        interval = Math.floor(seconds / 60);\r\n        if (interval >= 1) return `${interval}m ago`;\r\n        return \"Just now\";\r\n    };\r\n\r\n    return (\r\n        <div className=\"friends-container\" style={{ background: '#000', minHeight: '100vh', color: '#fff', paddingBottom: '70px' }}>\r\n            {/* SEARCH SECTION */}\r\n            <div className=\"friend-search-container\" style={{ padding: '20px', position: 'relative' }}>\r\n                <form onSubmit={handleSearch} className=\"search-form\" style={{ display: 'flex', gap: '10px' }}>\r\n                    <input\r\n                        type=\"text\"\r\n                        className=\"friend-search-input\"\r\n                        placeholder=\"Search username... (exact)\"\r\n                        value={searchText}\r\n                        onChange={(e) => setSearchText(e.target.value)}\r\n                        style={{ flex: 1, padding: '12px', borderRadius: '8px', border: '1px solid #333', background: '#111', color: '#fff', outline: 'none' }}\r\n                    />\r\n                    <button type=\"submit\" className=\"friend-search-btn\" style={{ background: '#333', border: 'none', borderRadius: '8px', width: '50px', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\r\n                        {searchLoading ? '...' : <MdSearch size={24} />}\r\n                    </button>\r\n                    {showHint && <div style={{ position: 'absolute', top: '100%', left: '20px', background: '#FFD600', color: '#000', padding: '5px 10px', borderRadius: '4px', fontSize: '12px', marginTop: '5px', fontWeight: 'bold' }}>Find friends</div>}\r\n                </form>\r\n\r\n                {/* SEARCH RESULTS */}\r\n                {searchResults.length > 0 && (\r\n                    <div className=\"search-results-dropdown\" style={{ position: 'absolute', top: '75px', left: '20px', right: '20px', background: '#222', borderRadius: '8px', padding: '10px', zIndex: 100, border: '1px solid #333' }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px', color: '#888', fontSize: '12px', textTransform: 'uppercase' }}>\r\n                            <span>Results</span>\r\n                            <MdClose onClick={() => setSearchResults([])} style={{ cursor: 'pointer' }} />\r\n                        </div>\r\n                        {searchResults.map(user => (\r\n                            <Link to={`/profile/${user.uid}`} key={user.uid} className=\"search-result-item\" style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '10px', textDecoration: 'none', color: '#fff', background: '#111', borderRadius: '6px', marginBottom: '5px' }}>\r\n                                <img src={user.photoURL || 'https://placehold.co/40'} alt={user.username} style={{ width: '30px', height: '30px', borderRadius: '50%', objectFit: 'cover' }} />\r\n                                <span style={{ fontWeight: 'bold' }}>{user.username}</span>\r\n                            </Link>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* FEED SECTION */}\r\n            <div className=\"activity-feed\" style={{ padding: '0 20px' }}>\r\n                {loading ? (\r\n                    <div style={{ height: '300px', position: 'relative' }}><PremiumLoader message=\"Fetching feed...\" /></div>\r\n                ) : activities.length === 0 ? (\r\n                    <div style={{ textAlign: 'center', color: '#FFD600', marginTop: '50px' }}>\r\n                        <p style={{ marginBottom: '10px' }}>No recent activity.</p>\r\n                        <p style={{ fontSize: '12px', color: '#FFD600' }}>Follow people to see what they're watching.</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"activity-list\" style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>\r\n                        {activities.map(item => {\r\n                            // UI Logic\r\n                            let actionText = \"\";\r\n                            let detailText = \"\";\r\n                            if (item.type === 'watched_episode') {\r\n                                actionText = \"watched\";\r\n                                detailText = `Season ${item.seasonNumber} Â· Episode ${item.episodeNumber}`;\r\n                            } else if (item.type === 'completed_season') {\r\n                                actionText = \"completed a season\";\r\n                                detailText = `Season ${item.seasonNumber}`;\r\n                            } else if (item.type === 'poster_updated') {\r\n                                actionText = \"updated the series poster\";\r\n                            } else if (item.type === 'rated_season') {\r\n                                actionText = \"rated\";\r\n                                detailText = (\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px', justifyContent: 'center', marginTop: '4px' }}>\r\n                                        <span>Season {item.seasonNumber}</span>\r\n                                        <div style={{ display: 'flex', gap: '1px', color: '#FFD600' }}>\r\n                                            {[...Array(5)].map((_, i) => (\r\n                                                (item.rating || 0) > i ? <MdStar key={i} size={12} /> : null\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                );\r\n                            }\r\n\r\n                            return (\r\n                                <div key={item.id} style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>\r\n                                    {/* PFP Left */}\r\n                                    <Link to={`/profile/${item.userId}`} style={{ flexShrink: 0 }}>\r\n                                        {item.userProfilePicURL ? (\r\n                                            <img src={item.userProfilePicURL} alt={item.username} style={{ width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover' }} />\r\n                                        ) : (\r\n                                            <div style={{ width: '36px', height: '36px', borderRadius: '50%', background: '#333', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\r\n                                                <MdPerson size={20} color=\"#888\" />\r\n                                            </div>\r\n                                        )}\r\n                                    </Link>\r\n\r\n                                    {/* Content Center */}\r\n                                    <div style={{ flex: 1, minWidth: 0 }}>\r\n                                        <div style={{ fontSize: '14px', lineHeight: '1.4' }}>\r\n                                            <Link to={`/profile/${item.userId}`} style={{ fontWeight: 'bold', color: '#fff', textDecoration: 'none', marginRight: '4px' }}>{item.username}</Link>\r\n                                            <span style={{ color: '#aaa' }}>{actionText}</span>\r\n                                        </div>\r\n\r\n                                        <Link to={`/tv/${item.tmdbId}`} style={{ display: 'block', marginTop: '4px', textDecoration: 'none' }}>\r\n                                            <div style={{ display: 'flex', gap: '10px', background: '#111', padding: '8px', borderRadius: '8px', alignItems: 'center' }}>\r\n                                                {/* Optional Thumbnail */}\r\n                                                {item.posterPath && (\r\n                                                    <img src={`https://image.tmdb.org/t/p/w92${item.posterPath}`} alt=\"\" style={{ width: '30px', borderRadius: '4px', aspectRatio: '2/3', objectFit: 'cover' }} />\r\n                                                )}\r\n                                                <div style={{ overflow: 'hidden' }}>\r\n                                                    <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '13px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{item.seriesName}</div>\r\n                                                    {detailText && <div style={{ color: '#888', fontSize: '12px', marginTop: '2px' }}>{detailText}</div>}\r\n                                                </div>\r\n                                            </div>\r\n                                        </Link>\r\n                                    </div>\r\n\r\n                                    {/* Time Right */}\r\n                                    <div style={{ fontSize: '11px', color: '#666', whiteSpace: 'nowrap', flexShrink: 0, marginTop: '2px' }}>\r\n                                        {formatTimeAgo(item.createdAt)}\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Friends;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Home.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'doc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"doc"},"fix":{"range":[270,274],"text":""},"desc":"Remove unused variable 'doc'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[273,281],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'db' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":12,"suggestions":[{"messageId":"removeVar","data":{"varName":"db"},"fix":{"range":[312,352],"text":""},"desc":"Remove unused variable 'db'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'starSeriesIds' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":24,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"starSeriesIds"},"fix":{"range":[1072,1085],"text":""},"desc":"Remove unused variable 'starSeriesIds'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":25,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"navigate"},"fix":{"range":[1131,1162],"text":""},"desc":"Remove unused variable 'navigate'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  29 |   useEffect(() => {\n  30 |     if (userData?.starSeries) {\n> 31 |       setStarSeriesIds(new Set(userData.starSeries.map(s => s.id)));\n     |       ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  32 |     } else {\n  33 |       setStarSeriesIds(new Set());\n  34 |     }","line":31,"column":7,"nodeType":null,"endLine":31,"endColumn":23},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'TMDB_API_KEY'. Either include it or remove the dependency array.","line":72,"column":6,"nodeType":"ArrayExpression","endLine":72,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [TMDB_API_KEY, currentUser]","fix":{"range":[2971,2984],"text":"[TMDB_API_KEY, currentUser]"}}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { MdStarBorder, MdPlayArrow } from 'react-icons/md';\r\nimport { TbTrendingUp } from 'react-icons/tb';\r\nimport { Link, useNavigate } from 'react-router-dom';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { doc, getDoc } from 'firebase/firestore';\r\nimport { db } from '../firebase-config';\r\n\r\nimport './Home.css';\r\nimport './Home_Trending.css';\r\nimport { getResolvedPosterUrl } from '../utils/globalPosterResolver';\r\nimport { tmdbApi } from '../utils/tmdbApi';\r\nimport PremiumLoader from '../components/PremiumLoader';\r\nimport HeroCarousel from '../components/HeroCarousel';\r\n\r\nconst Home = () => {\r\n  const [trendingSeries, setTrendingSeries] = useState([]);\r\n  const [topRatedSeries, setTopRatedSeries] = useState([]);\r\n  const [newSeries, setNewSeries] = useState([]);\r\n  const [heroEpisodes, setHeroEpisodes] = useState([]); // NEW STATE\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  const { currentUser, userData, globalPosters } = useAuth();\r\n  const [starSeriesIds, setStarSeriesIds] = useState(new Set());\r\n  const navigate = useNavigate();\r\n  const TMDB_API_KEY = import.meta.env.VITE_TMDB_API_KEY || '05587a49bd4890a9630d6c0e544e0f6f';\r\n  const TMDB_BASE_URL = 'https://api.themoviedb.org/3';\r\n\r\n  useEffect(() => {\r\n    if (userData?.starSeries) {\r\n      setStarSeriesIds(new Set(userData.starSeries.map(s => s.id)));\r\n    } else {\r\n      setStarSeriesIds(new Set());\r\n    }\r\n  }, [userData]);\r\n\r\n  useEffect(() => {\r\n    const fetchData = async () => {\r\n      try {\r\n        const [trendingData, topRated, newReleases, heroData] = await Promise.all([\r\n          tmdbApi.getTrending('weekly'),\r\n          fetch(`${TMDB_BASE_URL}/tv/top_rated?api_key=${TMDB_API_KEY}`).then(r => r.json()),\r\n          fetch(`${TMDB_BASE_URL}/tv/airing_today?api_key=${TMDB_API_KEY}`).then(r => r.json()),\r\n          // NEW: Parallel Fetch for Hero Carousel\r\n          fetch('http://localhost:5000/api/hero/new-episodes').then(r => r.json())\r\n        ]);\r\n\r\n        console.log('Trending:', trendingData?.length);\r\n        console.log('Top Rated:', topRated.results?.length);\r\n        console.log('New:', newReleases.results?.length);\r\n        console.log('Hero Episodes:', heroData?.length);\r\n\r\n        setTrendingSeries(trendingData?.slice(0, 12) || []);\r\n        setTopRatedSeries(topRated.results?.slice(0, 12) || []);\r\n        setNewSeries(newReleases.results?.slice(0, 12) || []);\r\n\r\n        // Process Hero Data\r\n        if (Array.isArray(heroData)) {\r\n          const validHero = heroData.filter(s => s.backdrop_path || s.poster_path);\r\n          setHeroEpisodes(validHero.slice(0, 5));\r\n        }\r\n\r\n        setLoading(false);\r\n      } catch (error) {\r\n        console.error('Error fetching series:', error);\r\n        setError('Failed to load content. Please check your connection.');\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchData();\r\n  }, [currentUser]);\r\n\r\n  const SeriesCard = ({ series }) => {\r\n    if (!series) return null;\r\n\r\n    return (\r\n      <div className=\"series-card-container\">\r\n        <Link to={`/tv/${series.id}`} className=\"series-card\">\r\n\r\n          <div className=\"series-poster-wrapper\">\r\n            <img\r\n              className=\"series-poster\"\r\n              src={getResolvedPosterUrl(series.id, series.poster_path, globalPosters, 'w500')\r\n                || (series.backdrop_path ? `https://image.tmdb.org/t/p/w500${series.backdrop_path}` : 'https://via.placeholder.com/200x300/141414/FFFF00?text=No+Image')}\r\n              alt={series.name}\r\n              draggable={false}\r\n              onError={(e) => {\r\n                e.target.src = `https://via.placeholder.com/200x300/141414/FFFF00?text=${series.name}`;\r\n              }}\r\n            />\r\n          </div>\r\n        </Link>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {loading ? (\r\n        <PremiumLoader />\r\n      ) : error ? (\r\n        <div style={{ color: '#FFD600', textAlign: 'center', marginTop: '100px', padding: '20px', fontSize: '1.1rem' }}>\r\n          {error}\r\n        </div>\r\n      ) : (\r\n        <div className=\"home-scroller\">\r\n          {/* NEW HERO CAROUSEL SECTION */}\r\n          {/* Dynamically previews Newly Released Episodes */}\r\n          <HeroCarousel episodes={heroEpisodes} />\r\n\r\n          {/* Trending Series Section */}\r\n          <section className=\"section\">\r\n            <h2 className=\"section-title\">\r\n              Trending Series\r\n            </h2>\r\n            <div className=\"series-row\">\r\n              {trendingSeries.map((series) => (\r\n                <SeriesCard key={series.id} series={series} />\r\n              ))}\r\n            </div>\r\n          </section>\r\n\r\n          {/* Top Rated Series Section */}\r\n          <section className=\"section\">\r\n            <h2 className=\"section-title\">\r\n              Highest Rated Series\r\n            </h2>\r\n            <div className=\"series-row\">\r\n              {topRatedSeries.map((series) => (\r\n                <SeriesCard key={series.id} series={series} />\r\n              ))}\r\n            </div>\r\n          </section>\r\n\r\n          {/* New Releases Section */}\r\n          <section className=\"section\">\r\n            <h2 className=\"section-title\">New This Month</h2>\r\n            <div className=\"series-row\">\r\n              {newSeries.map((series) => (\r\n                <SeriesCard key={series.id} series={series} />\r\n              ))}\r\n            </div>\r\n          </section>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default Home;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Login.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Maintenance.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\MovieDetails.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'query' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":19,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":95,"suggestions":[{"messageId":"removeVar","data":{"varName":"query"},"fix":{"range":[1415,1422],"text":""},"desc":"Remove unused variable 'query'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'where' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":19,"column":97,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":102,"suggestions":[{"messageId":"removeVar","data":{"varName":"where"},"fix":{"range":[1422,1429],"text":""},"desc":"Remove unused variable 'where'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'getDocs' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":19,"column":104,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":111,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDocs"},"fix":{"range":[1429,1438],"text":""},"desc":"Remove unused variable 'getDocs'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":19,"column":113,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":120,"suggestions":[{"messageId":"removeVar","data":{"varName":"orderBy"},"fix":{"range":[1438,1447],"text":""},"desc":"Remove unused variable 'orderBy'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'onSnapshot' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":19,"column":122,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":132,"suggestions":[{"messageId":"removeVar","data":{"varName":"onSnapshot"},"fix":{"range":[1447,1459],"text":""},"desc":"Remove unused variable 'onSnapshot'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'limit' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":19,"column":134,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":139,"suggestions":[{"messageId":"removeVar","data":{"varName":"limit"},"fix":{"range":[1459,1466],"text":""},"desc":"Remove unused variable 'limit'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'isTv' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":37,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"isTv"},"fix":{"range":[2256,2274],"text":""},"desc":"Remove unused variable 'isTv'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'ratings' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":44,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"ratings"},"fix":{"range":[2507,2514],"text":""},"desc":"Remove unused variable 'ratings'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'trailer' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":45,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"trailer"},"fix":{"range":[2556,2563],"text":""},"desc":"Remove unused variable 'trailer'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'showEditHint' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":120,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":120,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"showEditHint"},"fix":{"range":[5359,5371],"text":""},"desc":"Remove unused variable 'showEditHint'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'completedSeasonInfo' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":217,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":217,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"completedSeasonInfo"},"fix":{"range":[8939,8958],"text":""},"desc":"Remove unused variable 'completedSeasonInfo'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setCompletedSeasonInfo' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":217,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":217,"endColumn":55,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCompletedSeasonInfo"},"fix":{"range":[8958,8982],"text":""},"desc":"Remove unused variable 'setCompletedSeasonInfo'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'reviewLikes' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":251,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":251,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"reviewLikes"},"fix":{"range":[10344,10355],"text":""},"desc":"Remove unused variable 'reviewLikes'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'toggleReviewLike' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":581,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":581,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"toggleReviewLike"},"fix":{"range":[24196,25332],"text":""},"desc":"Remove unused variable 'toggleReviewLike'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchSeasonEpisodes' and 'seasonNumber'. Either include them or remove the dependency array.","line":690,"column":8,"nodeType":"ArrayExpression","endLine":690,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [fetchSeasonEpisodes, id, seasonNumber]","fix":{"range":[29271,29275],"text":"[fetchSeasonEpisodes, id, seasonNumber]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'showStoryPrompt' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":750,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":750,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"showStoryPrompt"},"fix":{"range":[31662,31677],"text":""},"desc":"Remove unused variable 'showStoryPrompt'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setShowStoryPrompt' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":750,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":750,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setShowStoryPrompt"},"fix":{"range":[31677,31697],"text":""},"desc":"Remove unused variable 'setShowStoryPrompt'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'storyPromptData' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":751,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":751,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"storyPromptData"},"fix":{"range":[31730,31745],"text":""},"desc":"Remove unused variable 'storyPromptData'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setStoryPromptData' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":751,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":751,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setStoryPromptData"},"fix":{"range":[31745,31765],"text":""},"desc":"Remove unused variable 'setStoryPromptData'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'data' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":773,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":773,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"data"},"fix":{"range":[32483,32505],"text":""},"desc":"Remove unused variable 'data'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'tmdbId' is defined but never used.","line":854,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":854,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"tmdbId"},"fix":{"range":[36937,36943],"text":""},"desc":"Remove unused variable 'tmdbId'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'tmdbId' is defined but never used.","line":954,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":954,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"tmdbId"},"fix":{"range":[40658,40664],"text":""},"desc":"Remove unused variable 'tmdbId'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'toggleWatched' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":958,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":958,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"toggleWatched"},"fix":{"range":[40730,47861],"text":""},"desc":"Remove unused variable 'toggleWatched'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'seasonPoster' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":965,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":965,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"seasonPoster"},"fix":{"range":[41194,41265],"text":""},"desc":"Remove unused variable 'seasonPoster'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkEpisodeWatched'. Either include it or remove the dependency array.","line":1143,"column":8,"nodeType":"ArrayExpression","endLine":1143,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [checkEpisodeWatched, episodeWatchedIDs, seasonDetails]","fix":{"range":[49884,49918],"text":"[checkEpisodeWatched, episodeWatchedIDs, seasonDetails]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleSeasonCompletedFlow'. Either include it or remove the dependency array.","line":1157,"column":8,"nodeType":"ArrayExpression","endLine":1157,"endColumn":54,"suggestions":[{"desc":"Update the dependencies array to be: [isWatched, details, userData, selectedSeason, handleSeasonCompletedFlow]","fix":{"range":[50479,50525],"text":"[isWatched, details, userData, selectedSeason, handleSeasonCompletedFlow]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleSeasonReview' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1423,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1423,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleSeasonReview"},"fix":{"range":[61873,62325],"text":""},"desc":"Remove unused variable 'handleSeasonReview'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'targetId' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1454,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1454,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"targetId"},"fix":{"range":[63119,63151],"text":""},"desc":"Remove unused variable 'targetId'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'result' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1498,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":1498,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"result"},"fix":{"range":[65823,66296],"text":""},"desc":"Remove unused variable 'result'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'result' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1512,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":1512,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"result"},"fix":{"range":[66732,67264],"text":""},"desc":"Remove unused variable 'result'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'seasonEpIds' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1734,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":1734,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"seasonEpIds"},"fix":{"range":[78269,78336],"text":""},"desc":"Remove unused variable 'seasonEpIds'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'date' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1991,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1991,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"date"},"fix":{"range":[90098,90134],"text":""},"desc":"Remove unused variable 'date'."}]}],"suppressedMessages":[],"errorCount":29,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react';\r\nimport { useParams, Link, useNavigate } from 'react-router-dom';\r\nimport { MdStar, MdAdd, MdRemove, MdCreate, MdFavorite, MdFavoriteBorder, MdVisibility, MdVisibilityOff, MdKeyboardArrowDown, MdClose, MdShare, MdCheck, MdIosShare, MdRateReview, MdArrowBack, MdPlayArrow, MdEdit, MdSentimentSatisfiedAlt, MdSentimentNeutral, MdSentimentVeryDissatisfied, MdHeartBroken, MdCelebration, MdMovie } from 'react-icons/md';\r\nimport { FaArrowLeft } from 'react-icons/fa';\r\nimport ReviewsDrawer from '../components/ReviewsDrawer';\r\nimport ReviewModal from '../components/ReviewModal';\r\nimport PosterUnlockPopup from '../components/PosterUnlockPopup';\r\n\r\nimport StorySticker from '../components/StorySticker';\r\nimport ShareModal from '../components/ShareModal';\r\nimport LoadingPopup from '../components/LoadingPopup';\r\nimport MobileIndicator from '../components/MobileIndicator';\r\nimport PremiumLoader from '../components/PremiumLoader';\r\nimport { useNotification } from '../context/NotificationContext';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { getWatchedEpisodes, markEpisodeWatched, unmarkEpisodeWatched, markSeasonWatched } from '../utils/watchedService';\r\nimport * as watchlistService from '../utils/watchlistService';\r\nimport html2canvas from 'html2canvas';\r\nimport { doc, deleteDoc, updateDoc, arrayUnion, arrayRemove, getDoc, collection, addDoc, query, where, getDocs, orderBy, onSnapshot, limit } from 'firebase/firestore';\r\nimport { db } from '../firebase-config';\r\n\r\nimport { logActivity } from '../utils/activityLogger';\r\nimport { getResolvedPosterUrl, resolvePoster } from '../utils/globalPosterResolver';\r\nimport * as reviewService from '../utils/reviewService';\r\nimport * as ratingsService from '../utils/ratingsService';\r\nimport * as diaryService from '../utils/diaryService';\r\nimport { likesService } from '../utils/likesService';\r\nimport { tmdbApi } from '../utils/tmdbApi';\r\nimport gsap from 'gsap';\r\nimport './Home.css';\r\n\r\nconst MovieDetails = () => {\r\n    const { id, seasonNumber } = useParams();\r\n    const navigate = useNavigate();\r\n    const { currentUser, userData, globalPosters } = useAuth(); // Get Access to Auth\r\n    const { confirm } = useNotification();\r\n    const isTv = true;\r\n    const type = 'tv';\r\n\r\n    const [details, setDetails] = useState(null);\r\n    const [cast, setCast] = useState([]);\r\n    const [crew, setCrew] = useState([]);\r\n    const [reviewsData, setReviewsData] = useState([]);\r\n    const [ratings, setRatings] = useState([]);\r\n    const [trailer, setTrailer] = useState(null);\r\n\r\n    const [loading, setLoading] = useState(true);\r\n    const [inWatchlist, setInWatchlist] = useState(false);\r\n    const [isLiked, setIsLiked] = useState(false);\r\n    const [limitPopupVisible, setLimitPopupVisible] = useState(false);\r\n\r\n    // Animation Ref\r\n    const heartRef = useRef(null);\r\n    const brokenHeartRef = useRef(null);\r\n\r\n    // Double Tap Logic\r\n    const lastTapRef = useRef(0);\r\n    const handlePosterClick = (e) => {\r\n        const currentTime = new Date().getTime();\r\n        const tapLength = currentTime - lastTapRef.current;\r\n        if (tapLength < 300 && tapLength > 0) {\r\n            handlePosterDoubleTap(e);\r\n        }\r\n        lastTapRef.current = currentTime;\r\n    };\r\n\r\n    const handlePosterDoubleTap = async (e) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        if (!(await checkAuth())) return;\r\n\r\n        const wasLiked = isLiked; // Capture state BEFORE toggle\r\n\r\n        // Trigger Like Logic\r\n        toggleLike();\r\n\r\n        // GSAP Animation\r\n        const targetRef = wasLiked ? brokenHeartRef : heartRef;\r\n        const scaleVal = 1.0; // \"Medium Small\" (Reduced from 2.5)\r\n\r\n        if (targetRef.current) {\r\n            const tl = gsap.timeline();\r\n            if (!wasLiked) {\r\n                // LIKE ANIMATION (Pop)\r\n                tl.fromTo(targetRef.current,\r\n                    { scale: 0, opacity: 0, rotation: -45 },\r\n                    { scale: scaleVal, opacity: 1, rotation: 0, duration: 0.5, ease: \"elastic.out(1, 0.3)\" }\r\n                )\r\n                    .to(targetRef.current, { scale: 0, opacity: 0, duration: 0.3, delay: 0.2, ease: \"power2.in\" });\r\n            } else {\r\n                // UNLIKE ANIMATION (Break)\r\n                tl.fromTo(targetRef.current,\r\n                    { scale: 0, opacity: 0, rotation: 0 },\r\n                    { scale: scaleVal, opacity: 1, rotation: 0, duration: 0.4, ease: \"back.out(1.7)\" }\r\n                )\r\n                    .to(targetRef.current, { rotation: -15, duration: 0.1, yoyo: true, repeat: 3 }) // Shake\r\n                    .to(targetRef.current, { scale: 0, opacity: 0, y: 50, duration: 0.4, ease: \"power2.in\" }); // Drop\r\n            }\r\n        }\r\n    };\r\n\r\n\r\n\r\n    const TMDB_API_KEY = import.meta.env.VITE_TMDB_API_KEY || '05587a49bd4890a9630d6c0e544e0f6f';\r\n    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';\r\n\r\n\r\n\r\n\r\n    const [seasonDetails, setSeasonDetails] = useState(null);\r\n    const [isWatched, setIsWatched] = useState(false);\r\n\r\n    // Popup State\r\n    const [showPosterUnlockPopup, setShowPosterUnlockPopup] = useState(false);\r\n    const [posterUnlockData, setPosterUnlockData] = useState(null);\r\n\r\n    // Poster Edit & Scroll State\r\n    const posterContainerRef = useRef(null);\r\n    const [showEditHint, setShowEditHint] = useState(false);\r\n    const [isEditButtonGlowing, setIsEditButtonGlowing] = useState(false);\r\n\r\n    // Selected Season (must be declared before useEffect that uses it)\r\n    const [selectedSeason, setSelectedSeason] = useState(seasonNumber ? parseInt(seasonNumber) : 1);\r\n\r\n    // Derived Season Progress\r\n    const [seasonProgress, setSeasonProgress] = useState({\r\n        completed: false,\r\n        rated: false,\r\n        selectedPoster: null\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (userData && details && selectedSeason) {\r\n            const completedKey = String(details.id);\r\n            const completedSeasons = userData.completedSeasons?.[completedKey] || [];\r\n            const isCompleted = completedSeasons.includes(Number(selectedSeason));\r\n            const selectedPosterKey = `${details.id}_${selectedSeason}`;\r\n            const selectedPoster = userData.selectedPosters?.[selectedPosterKey];\r\n\r\n            // DEBUG: Log completion status\r\n            console.log('ðŸ” Season Progress Check:', {\r\n                seriesId: details.id,\r\n                selectedSeason,\r\n                completedKey,\r\n                completedSeasons,\r\n                isCompleted,\r\n                hasUserData: !!userData\r\n            });\r\n\r\n            setSeasonProgress({\r\n                completed: !!isCompleted,\r\n                rated: false,\r\n                selectedPoster: selectedPoster\r\n            });\r\n        }\r\n    }, [userData, details, selectedSeason]);\r\n\r\n    const handlePopupClose = () => {\r\n        setShowPosterUnlockPopup(false);\r\n        // Trigger Auto-Scroll flow\r\n        triggerAutoScroll();\r\n    };\r\n\r\n    const handleSeasonCompletionClose = () => {\r\n        setShowSeasonCompletion(false);\r\n        triggerAutoScroll(); // Reuse the same logic\r\n    };\r\n\r\n    const triggerAutoScroll = () => {\r\n        if (posterContainerRef.current) {\r\n            // 1. Scroll to poster (Always scroll when triggered)\r\n            posterContainerRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n\r\n            // 2. Highlight button (Only if completed)\r\n            if (seasonProgress.completed) {\r\n                setIsEditButtonGlowing(true);\r\n                setShowEditHint(true);\r\n\r\n                // 3. Timer to remove glow/hint\r\n                setTimeout(() => {\r\n                    setIsEditButtonGlowing(false);\r\n                    setShowEditHint(false);\r\n                }, 5000);\r\n            }\r\n        }\r\n    };\r\n\r\n    const canEditPoster = () => {\r\n        if (!userData?.lastPosterEditAt) return true;\r\n\r\n        const lastEdit = new Date(userData.lastPosterEditAt).getTime();\r\n        const now = new Date().getTime();\r\n        const twentyFourHours = 24 * 60 * 60 * 1000;\r\n\r\n        return (now - lastEdit) >= twentyFourHours;\r\n    };\r\n\r\n    const handleEditClick = () => {\r\n        if (!canEditPoster()) {\r\n            setLimitPopupVisible(true);\r\n            return;\r\n        }\r\n        navigate(`/tv/${details.id}/season/${selectedSeason}/poster`);\r\n    };\r\n\r\n\r\n    // Review Modal State\r\n    const [isReviewOpen, setIsReviewOpen] = useState(false);\r\n    const [reviewingItem, setReviewingItem] = useState(null);\r\n    const [existingReviewData, setExistingReviewData] = useState(null);\r\n\r\n    // Episode Tracking\r\n    const [episodeWatchedIDs, setEpisodeWatchedIDs] = useState(new Set()); // Use Set for efficient lookup\r\n    const [episodeWatchlistIDs, setEpisodeWatchlistIDs] = useState([]);\r\n    const [showSeasonCompletion, setShowSeasonCompletion] = useState(false);\r\n    const [completedSeasonInfo, setCompletedSeasonInfo] = useState(null);\r\n\r\n\r\n\r\n    // Fetch Watched Status from Supabase (SSOT)\r\n    useEffect(() => {\r\n        const fetchWatched = async () => {\r\n            // Clear state if no user or id\r\n            if (!currentUser || !details?.id) {\r\n                if (!currentUser) setEpisodeWatchedIDs(new Set());\r\n                return;\r\n            }\r\n\r\n            const watchedList = await getWatchedEpisodes(currentUser.uid, details.id);\r\n            const newSet = new Set(watchedList.map(w => `${w.season}-${w.episode}`));\r\n            setEpisodeWatchedIDs(newSet);\r\n        };\r\n        fetchWatched();\r\n    }, [currentUser, details?.id]);\r\n\r\n\r\n\r\n    // Filter User Series Review (for Action Button State) - Keeping Series Level\r\n    const userSeriesReview = reviewsData.find(r => r.tmdbId === parseInt(id || 0) && r.userId === currentUser?.uid && !r.isEpisode && !r.isSeason);\r\n    // Find User Season Review\r\n    const userSeasonReview = reviewsData.find(r => r.tmdbId === parseInt(id || 0) && r.userId === currentUser?.uid && r.isSeason && r.seasonNumber === selectedSeason);\r\n\r\n    const [isSeasonOpen, setIsSeasonOpen] = useState(false);\r\n    const [episodes, setEpisodes] = useState([]);\r\n    const [seasonsValues, setSeasonsValues] = useState([]);\r\n\r\n    const [watchProviders, setWatchProviders] = useState(null);\r\n\r\n    // Review Likes State\r\n    const [reviewLikes, setReviewLikes] = useState({});\r\n    const [isReviewsOpen, setIsReviewsOpen] = useState(false);\r\n    const [shareModal, setShareModal] = useState({ isOpen: false, imageUrl: '' });\r\n\r\n    // Helper Functions (need to be defined before computed values)\r\n    const getSeasonName = (seasonNum) => {\r\n        const season = seasonsValues.find(s => s.season_number === seasonNum);\r\n        return season && season.name ? season.name : `Season ${seasonNum}`;\r\n    };\r\n\r\n    const getCurrentSeasonRating = () => {\r\n        const seasonReviews = reviewsData.filter(r => r.tmdbId === parseInt(id) && r.seasonNumber === selectedSeason && r.isEpisode);\r\n        if (seasonReviews.length === 0) return { avg: \"0.0\", count: 0 };\r\n        const sum = seasonReviews.reduce((acc, r) => acc + (parseFloat(r.rating) || 0), 0);\r\n        return { avg: (sum / seasonReviews.length).toFixed(1), count: seasonReviews.length };\r\n    };\r\n\r\n    // Computed Values\r\n    const getEnglishTitle = () => {\r\n        if (!details) return 'Loading...';\r\n        if (details.translations?.translations) {\r\n            const enTranslation = details.translations.translations.find(t => t.iso_639_1 === 'en');\r\n            if (enTranslation && enTranslation.data?.name) return enTranslation.data.name;\r\n        }\r\n        return details.name;\r\n    };\r\n\r\n    const getEnglishLogo = () => {\r\n        if (!details?.images?.logos) return null;\r\n        // Priority 1: English logos\r\n        const enLogos = details.images.logos.filter(l => l.iso_639_1 === 'en');\r\n        if (enLogos.length > 0) return enLogos[0].file_path;\r\n        // Priority 2: Logos with no language (often stylized English)\r\n        const noLangLogos = details.images.logos.filter(l => !l.iso_639_1);\r\n        if (noLangLogos.length > 0) return noLangLogos[0].file_path;\r\n        // Priority 3: Fallback to first available logo\r\n        return details.images.logos[0]?.file_path;\r\n    };\r\n\r\n    const title = getEnglishTitle();\r\n    const logoFilePath = getEnglishLogo();\r\n    const seasonStats = getCurrentSeasonRating();\r\n\r\n\r\n\r\n    // Sticker Logic\r\n    const [stickerModalOpen, setStickerModalOpen] = useState(false);\r\n    const [stickerStatus, setStickerStatus] = useState('idle'); // idle, preparing, ready\r\n    const [stickerData, setStickerData] = useState(null);\r\n    const [generatedStickerImage, setGeneratedStickerImage] = useState(null);\r\n    const stickerRef = useRef(null);\r\n\r\n    const generateSticker = async () => {\r\n        if (!stickerRef.current) return;\r\n        setStickerStatus('preparing');\r\n\r\n        // CRITICAL FIX: Wait for images to load before capture\r\n        // This prevents black/empty stickers on mobile\r\n\r\n        // Step 1: Small delay for DOM to settle\r\n        await new Promise(r => setTimeout(r, 100));\r\n\r\n        // Step 2: Wait for BOTH images to finish loading\r\n        const waitForImages = async () => {\r\n            const maxWait = 8000; // INCREASED: 8 second timeout for mobile/slow networks\r\n            const startTime = Date.now();\r\n\r\n            while (Date.now() - startTime < maxWait) {\r\n                const posterLoaded = stickerRef.current?.getAttribute('data-poster-loaded') === 'true';\r\n                const pfpLoaded = stickerRef.current?.getAttribute('data-pfp-loaded') === 'true';\r\n\r\n                // Safety: Also check naturalWidth (browser boolean might be flaky)\r\n                const posterImg = stickerRef.current?.querySelector('img[alt=\"Poster\"]');\r\n                const isPosterReallyLoaded = posterImg ? posterImg.complete && posterImg.naturalWidth > 0 : false;\r\n\r\n                // For PFP, it might be hidden or default, so focus on Poster primarily\r\n                // But relying on attributes is safer if we control the onLoad events.\r\n\r\n                if ((posterLoaded || isPosterReallyLoaded) && pfpLoaded) {\r\n                    return true; // Both loaded\r\n                }\r\n\r\n                // Check every 100ms\r\n                await new Promise(r => setTimeout(r, 100));\r\n            }\r\n\r\n            console.warn('Image load timeout - proceeding anyway (best effort)');\r\n            return false;\r\n        };\r\n\r\n        await waitForImages();\r\n\r\n        // Step 3: Additional delay for fonts/layout (mobile-critical)\r\n        await new Promise(r => setTimeout(r, 400));\r\n\r\n        try {\r\n            const canvas = await html2canvas(stickerRef.current, {\r\n                useCORS: true,\r\n                scale: 2,\r\n                backgroundColor: null,\r\n                width: 1080,\r\n                height: 1920,\r\n                logging: false,\r\n                allowTaint: false,\r\n                onclone: (clonedDoc) => {\r\n                    const el = clonedDoc.getElementById('story-sticker-element');\r\n                    if (el) {\r\n                        el.style.display = 'flex';\r\n                        el.style.position = 'relative';\r\n                        el.style.top = '0';\r\n                        el.style.left = '0';\r\n                        el.style.transform = 'none';\r\n                    }\r\n                }\r\n            });\r\n\r\n            canvas.toBlob((blob) => {\r\n                if (!blob) {\r\n                    console.error(\"Blob generation failed\");\r\n                    setStickerStatus('idle');\r\n                    return;\r\n                }\r\n                const url = URL.createObjectURL(blob);\r\n                setGeneratedStickerImage(url);\r\n                setStickerStatus('ready');\r\n            }, 'image/png');\r\n\r\n        } catch (e) {\r\n            console.error(\"Sticker Gen Error:\", e);\r\n            setStickerStatus('idle');\r\n        }\r\n    };\r\n\r\n    // Auto-trigger generation whenever data is set for the modal\r\n    useEffect(() => {\r\n        if (stickerModalOpen && stickerData && stickerStatus === 'idle') {\r\n            generateSticker();\r\n        }\r\n    }, [stickerModalOpen, stickerData, stickerStatus]);\r\n\r\n    const handleShareSticker = async () => {\r\n        if (!generatedStickerImage) return;\r\n        try {\r\n            const blob = await fetch(generatedStickerImage).then(r => r.blob());\r\n            const file = new File([blob], `SERIEE_Share_${Date.now()}.png`, { type: 'image/png' });\r\n\r\n            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {\r\n                await navigator.share({\r\n                    files: [file]\r\n                });\r\n            } else {\r\n                // Fallback: Download logic if share not supported (Desktop) calls the same blob logic or shows prompt\r\n                const a = document.createElement('a');\r\n                a.href = generatedStickerImage;\r\n                a.download = file.name;\r\n                document.body.appendChild(a);\r\n                a.click();\r\n                document.body.removeChild(a);\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Native Share Error\", e);\r\n        }\r\n    };\r\n\r\n    // Check if all episodes in a season are completed\r\n    const checkSeasonCompletion = (seasonNumber) => {\r\n        if (!seasonNumber || !episodes || !userData) return false;\r\n\r\n        // Get all episode IDs for this season\r\n        const seasonEpisodeIds = episodes\r\n            .filter(ep => ep.season_number === seasonNumber)\r\n            .map(ep => ep.id);\r\n\r\n        if (seasonEpisodeIds.length === 0) return false;\r\n\r\n        // Check if all are in userData.watched\r\n        const watchedEpisodeIds = (userData.watched || [])\r\n            .filter(w => w.isEpisode && w.seasonNumber === seasonNumber)\r\n            .map(w => w.episodeId || w.id);\r\n\r\n        // Season is complete if all episode IDs are in watched\r\n        return seasonEpisodeIds.every(id => watchedEpisodeIds.includes(id));\r\n    };\r\n\r\n    // Handle season completion flow - unlock posters\r\n    const handleSeasonCompletedFlow = async (seasonNumber) => {\r\n        if (!currentUser || !details) return;\r\n\r\n        try {\r\n            const userRef = doc(db, 'users', currentUser.uid);\r\n            const userSnap = await getDoc(userRef);\r\n\r\n            if (!userSnap.exists()) return;\r\n\r\n            const data = userSnap.data();\r\n            const completedKey = String(details.id);\r\n            const completedSeasons = data.completedSeasons?.[completedKey] || [];\r\n            const seasonNum = Number(seasonNumber); // Ensure it's a number\r\n\r\n            console.log('âœ… Marking season complete:', {\r\n                seriesId: details.id,\r\n                seasonNumber: seasonNum,\r\n                completedKey,\r\n                existingCompletedSeasons: completedSeasons,\r\n                alreadyCompleted: completedSeasons.includes(seasonNum)\r\n            });\r\n\r\n            // Check if already marked as completed\r\n            if (!completedSeasons.includes(seasonNum)) {\r\n                // Mark as completed (ALWAYS store as number)\r\n                await updateDoc(userRef, {\r\n                    [`completedSeasons.${completedKey}`]: arrayUnion(seasonNum)\r\n                });\r\n\r\n                console.log('ðŸ’¾ Saved to Firestore:', { completedKey, seasonNum });\r\n\r\n                // CRITICAL: Update local state immediately so Edit button appears\r\n                setSeasonProgress(prev => ({\r\n                    ...prev,\r\n                    completed: true\r\n                }));\r\n\r\n                // Show unlock popup (New Design)\r\n                setShowSeasonCompletion(true);\r\n                // We can still set this for data if needed, but new popup is static text\r\n                setPosterUnlockData({\r\n                    seriesId: details.id,\r\n                    seasonNumber: seasonNumber,\r\n                    seriesName: details.name\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.error('Error handling season completion:', error);\r\n        }\r\n    };\r\n\r\n    const closeStickerModal = () => {\r\n        setStickerModalOpen(false);\r\n        setStickerStatus('idle');\r\n        setGeneratedStickerImage(null);\r\n        setStickerData(null);\r\n    };\r\n\r\n    const handleShare = (reviewItem, isEpisodeArg = false, isSeasonArg = false) => {\r\n        // CRITICAL: Reset cached image to force fresh generation\r\n        setGeneratedStickerImage(null);\r\n        setStickerStatus('idle');\r\n\r\n        // Fallback to reviewItem properties if arguments are not provided (e.g. from ReviewsDrawer)\r\n        const isEpisode = isEpisodeArg || reviewItem.isEpisode;\r\n        const isSeason = isSeasonArg || reviewItem.isSeason;\r\n\r\n        // Resolve Poster Path & Season Info\r\n        let seasonEpisodeText = null;\r\n\r\n        const targetSeasonNum = Number(reviewItem.seasonNumber || (isSeason ? seasonNumber : null));\r\n\r\n        // Use Global Resolution Utility - resolvePoster now comes from globalPosterResolver\r\n        let posterPathToUse = resolvePoster(details.id, details.poster_path, globalPosters);\r\n\r\n        const foundSeason = targetSeasonNum ? seasonsValues.find(s => s.season_number === targetSeasonNum) : null;\r\n\r\n        // Fallback Logic if resolvePoster returned default but we have a season-specific TMDB poster\r\n        if (posterPathToUse === details.poster_path && foundSeason && foundSeason.poster_path) {\r\n            posterPathToUse = foundSeason.poster_path;\r\n        }\r\n\r\n        // Try to use Season Poster if available (more specific)\r\n        if (foundSeason && foundSeason.poster_path) {\r\n            posterPathToUse = foundSeason.poster_path;\r\n        } else if (isSeason && seasonDetails?.poster_path) {\r\n            // Fallback to seasonDetails if it matches\r\n            posterPathToUse = seasonDetails.poster_path;\r\n        }\r\n\r\n        // Set Label Text\r\n        if (isEpisode) {\r\n            seasonEpisodeText = `S${reviewItem.seasonNumber} E${reviewItem.episodeNumber}`;\r\n        } else if (isSeason) {\r\n            seasonEpisodeText = `S${reviewItem.seasonNumber}`;\r\n        }\r\n\r\n        setStickerData({\r\n            movie: {\r\n                name: details.name,\r\n                poster_path: posterPathToUse,\r\n                seasonEpisode: seasonEpisodeText\r\n            },\r\n            // Fix: Store rating as 0-10 (StorySticker divides by 2).\r\n            // Normalizing: If rating is 0-5, convert to 0-10.\r\n            rating: reviewItem?.rating ? (parseFloat(reviewItem.rating) <= 5 ? parseFloat(reviewItem.rating) * 2 : parseFloat(reviewItem.rating)) : 0,\r\n            user: {\r\n                // Fix: Prioritize explicit userName or current user's username over 'author' (which is often email)\r\n                username: reviewItem.userName || userData?.username || reviewItem.author || 'User',\r\n                photoURL: reviewItem.photoURL || currentUser?.photoURL,\r\n                uid: reviewItem.userId || currentUser?.uid\r\n            },\r\n            isEpisodes: isEpisode,\r\n            seasonCompleted: isSeason ? checkSeasonCompletion(reviewItem.seasonNumber) : false\r\n        });\r\n        setStickerModalOpen(true);\r\n    };\r\n\r\n    useEffect(() => {\r\n        try {\r\n            const savedReviewLikes = JSON.parse(localStorage.getItem('reviewLikes') || '{}');\r\n            setReviewLikes(savedReviewLikes);\r\n        } catch (e) {\r\n            console.error(\"Error parsing reviewLikes from localStorage:\", e);\r\n            setReviewLikes({});\r\n            localStorage.setItem('reviewLikes', '{}');\r\n        }\r\n    }, []);\r\n\r\n    // Reviews Fetch (Dual-Read: Supabase â†’ Firebase Fallback)\r\n    useEffect(() => {\r\n        if (!id) return;\r\n\r\n        const fetchReviews = async () => {\r\n            const reviews = await reviewService.getSeriesReviews(parseInt(id));\r\n            setReviewsData(reviews);\r\n        };\r\n\r\n        fetchReviews();\r\n\r\n        // Poll for updates every 10 seconds (replace real-time listener)\r\n        const interval = setInterval(fetchReviews, 10000);\r\n        return () => clearInterval(interval);\r\n    }, [id, seasonNumber]);\r\n\r\n    const toggleReviewLike = async (reviewId) => {\r\n        if (!currentUser) return;\r\n        const reviewRef = doc(db, 'reviews', reviewId);\r\n\r\n        // Optimistic update locally\r\n        setReviewsData(prev => prev.map(r => {\r\n            if (r.id === reviewId) {\r\n                const hasLiked = r.likes?.includes(currentUser.uid);\r\n                return {\r\n                    ...r,\r\n                    likes: hasLiked ? r.likes.filter(id => id !== currentUser.uid) : [...(r.likes || []), currentUser.uid]\r\n                };\r\n            }\r\n            return r;\r\n        }));\r\n\r\n        // Fire and forget (or handle error logic, but for UI speed we optimistically update)\r\n        const reviewDoc = await getDoc(reviewRef);\r\n        if (reviewDoc.exists()) {\r\n            const data = reviewDoc.data();\r\n            const hasLiked = data.likes?.includes(currentUser.uid);\r\n            if (hasLiked) {\r\n                await updateDoc(reviewRef, { likes: arrayRemove(currentUser.uid) });\r\n            } else {\r\n                await updateDoc(reviewRef, { likes: arrayUnion(currentUser.uid) });\r\n            }\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        const fetchData = async () => {\r\n            setLoading(true);\r\n            try {\r\n                // Phase 3: Use Backend Cache Service (Aggregated Data)\r\n                const data = await tmdbApi.getSeriesDetails(id);\r\n\r\n                const detailsData = data;\r\n                const creditsData = data.credits || {};\r\n                const providersData = data['watch/providers'] || {};\r\n                const externalIdsData = data.external_ids || {};\r\n                const videosData = data.videos || {};\r\n\r\n                // Fetch OMDb Ratings if IMDb ID exists\r\n                if (externalIdsData.imdb_id) {\r\n                    try {\r\n                        const controller = new AbortController();\r\n                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout\r\n\r\n                        const omdbRes = await fetch(`https://www.omdbapi.com/?i=${externalIdsData.imdb_id}&apikey=15529774`, {\r\n                            signal: controller.signal\r\n                        });\r\n                        clearTimeout(timeoutId);\r\n\r\n                        const omdbData = await omdbRes.json();\r\n                        setRatings(omdbData.Ratings || []);\r\n                        if (omdbData.imdbRating) {\r\n                            setRatings(prev => {\r\n                                // dedup if imdb already in Ratings array (sometimes it is, sometimes not)\r\n                                const exists = prev.some(r => r.Source === \"Internet Movie Database\");\r\n                                if (!exists) return [...prev, { Source: \"Internet Movie Database\", Value: `${omdbData.imdbRating}/10` }];\r\n                                return prev;\r\n                            });\r\n                        }\r\n                    } catch (e) {\r\n                        console.warn(\"OMDb Fetch Error (Skipped):\", e.name === 'AbortError' ? 'Timeout' : e.message);\r\n                    }\r\n                }\r\n\r\n                // Set Watch Providers (Prioritize IN, then US)\r\n                setWatchProviders(providersData.results?.IN || providersData.results?.US || null);\r\n\r\n                setDetails(detailsData);\r\n                setCast(creditsData.cast?.slice(0, 10) || []); // Top 10 cast\r\n\r\n                // Get creators or executive producers for \"Director\" equivalent in TV\r\n                const creators = detailsData.created_by || [];\r\n                setCrew(creators);\r\n\r\n                if (videosData?.results) {\r\n                    const trailerVideo = videosData.results.find(vid => vid.type === 'Trailer' && vid.site === 'YouTube');\r\n                    setTrailer(trailerVideo || null);\r\n                }\r\n\r\n                setCrew(creators);\r\n\r\n                // Fetch Reviews from Firestore - Handled by Real-time Listener now\r\n                // setReviewsData(firestoreReviews);\r\n\r\n\r\n                if (detailsData.seasons) {\r\n                    setSeasonsValues(detailsData.seasons.filter(s => s.season_number > 0)); // Skip Specials (S0) usually\r\n                }\r\n\r\n                checkUser(detailsData.id);\r\n                // Don't set loading false yet if we want to wait for episodes, but for perceived perf, maybe separate?\r\n                // Let's just fetch season 1 default immediately if exists\r\n                if (detailsData.seasons && detailsData.seasons.length > 0) {\r\n                    const seasonToFetch = seasonNumber ? parseInt(seasonNumber) : 1;\r\n                    setSelectedSeason(seasonToFetch); // Ensure state sync\r\n                    fetchSeasonEpisodes(detailsData.id, seasonToFetch, detailsData.name);\r\n                } else {\r\n                    setLoading(false);\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Failed to fetch details\", error);\r\n                setLoading(false);\r\n            }\r\n        };\r\n        fetchData();\r\n    }, [id]);\r\n\r\n\r\n\r\n    const fetchSeasonEpisodes = async (seriesId, seasonNum, seriesNameOverride = null) => {\r\n        try {\r\n            // Phase 3: Backend Cache\r\n            const data = await tmdbApi.getSeasonDetails(seriesId, seasonNum);\r\n            const videosData = data.videos || {};\r\n            // const data = await res.json(); // Replaced\r\n            // const videosData = await videosRes.json(); // Replaced\r\n\r\n            let episodes = data.episodes || [];\r\n\r\n            // OMDb Integration for Season Ratings\r\n            const nameToUse = seriesNameOverride || details?.name;\r\n            if (nameToUse) {\r\n                try {\r\n                    const controller = new AbortController();\r\n                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout\r\n\r\n                    const omdbRes = await fetch(`https://www.omdbapi.com/?t=${encodeURIComponent(nameToUse)}&Season=${seasonNum}&apikey=15529774`, {\r\n                        signal: controller.signal\r\n                    });\r\n                    clearTimeout(timeoutId);\r\n\r\n                    const omdbData = await omdbRes.json();\r\n\r\n                    if (omdbData.Response === \"True\" && omdbData.Episodes) {\r\n                        // Merge ratings\r\n                        episodes = episodes.map(ep => {\r\n                            const omdbEp = omdbData.Episodes.find(o => o.Episode === String(ep.episode_number));\r\n                            return omdbEp ? { ...ep, omdbRating: omdbEp.imdbRating } : ep;\r\n                        });\r\n                    }\r\n                } catch (e) {\r\n                    console.warn(\"OMDb Season fetch failed (Skipped):\", e.name === 'AbortError' ? 'Timeout' : e.message);\r\n                }\r\n            }\r\n\r\n            setEpisodes(episodes);\r\n            setSeasonDetails({ ...data, videos: videosData });\r\n\r\n            // Set Season Trailer if available\r\n            if (videosData?.results) {\r\n                const trailerVideo = videosData.results.find(vid => vid.type === 'Trailer' && vid.site === 'YouTube');\r\n                setTrailer(trailerVideo || null);\r\n            } else {\r\n                setTrailer(null);\r\n            }\r\n\r\n            setLoading(false);\r\n        } catch (err) {\r\n            console.error(\"Failed to fetch episodes\", err);\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    const [showStoryPrompt, setShowStoryPrompt] = useState(false);\r\n    const [storyPromptData, setStoryPromptData] = useState(null);\r\n\r\n    const checkAuth = async () => {\r\n        if (!currentUser) {\r\n            const isConfirmed = await confirm(\"You need to sign in to perform this action. Go to Sign In?\", \"Sign In Required\", \"Sign In\", \"Cancel\");\r\n            if (isConfirmed) {\r\n                navigate('/login');\r\n            }\r\n            return false;\r\n        }\r\n        return true;\r\n    };\r\n\r\n    const handleSeasonChange = (e) => {\r\n        const newSeason = parseInt(e.target.value);\r\n        setSelectedSeason(newSeason);\r\n        fetchSeasonEpisodes(id, newSeason);\r\n    };\r\n\r\n    // Sync User State from Firestore & Supabase\r\n    useEffect(() => {\r\n        if (currentUser && details && userData) {\r\n            const data = userData;\r\n\r\n            // 1. Sync Watchlist State (Supabase SSOT with Firebase Fallback)\r\n            const syncWatchlist = async () => {\r\n                const currentWatchlist = await watchlistService.getWatchlist(currentUser.uid);\r\n\r\n                // Set InWatchlist for current Season\r\n                const isInWatch = currentWatchlist.some(i =>\r\n                    i.seriesId === details.id &&\r\n                    i.isSeason &&\r\n                    i.seasonNumber === selectedSeason\r\n                );\r\n                setInWatchlist(isInWatch);\r\n\r\n                // Sync Episode States\r\n                const watchlistEps = currentWatchlist\r\n                    .filter(i => i.seriesId === details.id && i.isEpisode)\r\n                    .map(i => i.id || i.tmdb_id);\r\n                setEpisodeWatchlistIDs(watchlistEps);\r\n            };\r\n            syncWatchlist();\r\n\r\n            // 2. Like Status (Using SSOT Service)\r\n            const checkLikeStatus = async () => {\r\n                // Check if SERIES is liked (since current UI seems to be Series or Season like? \r\n                // The toggleLike logic I replaced was SERIES or SEASON?\r\n                // Wait, previous toggleLike logic (lines 846-856) used `selectedSeason` and `isSeason: true`. \r\n                // So the button handles SEASON likes??\r\n                // \"id: `${details.id}-S${selectedSeason}`\"\r\n                // The prompt said \"likeSeries / unlikeSeries\".\r\n                // I need to be careful. The User Request said \"Series / Season / Episode\".\r\n                // Does the UI distinguish?\r\n                // The Heart button in header usually means Series.\r\n                // But the code I'm replacing was explicitly constructing a SEASON item.\r\n                // \"isSeason: true, seasonNumber: selectedSeason\".\r\n\r\n                // If I change this to Series only, I change behavior.\r\n                // However, usually the main heart is Series. The code I saw looked like Season.\r\n                // BUT `toggleLike` triggers `handlePosterDoubleTap` on the POSTER.\r\n                // If I am on Season page, maybe it likes the Season?\r\n                // The prompt says: \"likesService.likeSeries(), likeSeason(), likeEpisode()\".\r\n                // I should probably check which one to use.\r\n                // If `seasonNumber` is present, maybe it's Season Like?\r\n                // But typically users 'Like' a Show.\r\n                // Let's look at `toggleLike` context again. \r\n                // It used `userData.likes` ... `isSeason && seasonNumber === selectedSeason`.\r\n                // So it was DEFINITELY liking the SEASON inside this component.\r\n\r\n                // Okay, if the component logic was liking the SEASON, I should use `likesService.likeSeason`.\r\n                // BUT, looking at `MovieDetails` ... it seems to handle Season selection.\r\n                // If I like S1, do I like the Series?\r\n                // The Prompt says: \"User liked X -> Supabase likes table ... Item (series / season / episode)\".\r\n\r\n                // I will maintain existing behavior: If `selectedSeason` is set, we are liking the SEASON.\r\n                // Wait, if I am on the main movie page (`/tv/:id`), `seasonNumber` might be undefined or 1.\r\n                // The current code defaults `selectedSeason` to 1 if not param.\r\n\r\n                // If the user treats this as \"Liking the Show\", then implementation was bugged or specific.\r\n                // Most apps: Heart = Like Show.\r\n                // Letterboard seems to have granular likes.\r\n                // I will use `likeSeason` if that's what the old code did. \r\n                // Old code: `id: ...-S${selectedSeason}`, `item_type: season`.\r\n\r\n                // SO: `likesService.likeSeason` is the correct replacement.\r\n\r\n                const isSeasonLiked = await likesService.isLiked(\r\n                    currentUser.uid,\r\n                    details.id,\r\n                    'SEASON',\r\n                    selectedSeason\r\n                );\r\n                setIsLiked(isSeasonLiked);\r\n            };\r\n            checkLikeStatus();\r\n\r\n            // 3. Ep States - Likes (Firebase)\r\n            // (Wait, are there episode likes? Not explicitly tracked here, but logic is similar)\r\n        }\r\n    }, [currentUser, details, selectedSeason, userData]);\r\n\r\n    // Legacy checkUser removed as it used localStorage\r\n    const checkUser = (tmdbId) => {\r\n        // Kept empty to prevent errors if called elsewhere in legacy code flow\r\n    };\r\n\r\n    const toggleWatchlist = async () => {\r\n        if (!currentUser) return;\r\n\r\n        // Define Season Item (Using numeric IDs for Supabase BIGINT tmdb_id)\r\n        const seasonId = seasonDetails?.id || Number(`${details.id}${selectedSeason}`); // Best effort numeric ID\r\n        const seasonItem = {\r\n            id: seasonId,\r\n            seriesId: details.id,\r\n            name: `${details.name} (Season ${selectedSeason})`,\r\n            poster_path: seasonDetails?.poster_path || details.poster_path,\r\n            vote_average: details.vote_average,\r\n            first_air_date: seasonDetails?.air_date || details.first_air_date,\r\n            type: 'season',\r\n            isSeason: true,\r\n            seasonNumber: selectedSeason,\r\n        };\r\n\r\n        // Define Episode Items for Bulk Add/Remove\r\n        const seasonPoster = seasonDetails?.poster_path || details.poster_path;\r\n        const episodeItems = episodes.map(ep => ({\r\n            id: ep.id,\r\n            name: `${details.name} - S${ep.season_number}E${ep.episode_number}: ${ep.name}`,\r\n            poster_path: details.poster_path, // Series Poster\r\n            seasonPoster: seasonPoster,\r\n            still_path: ep.still_path,\r\n            vote_average: ep.vote_average,\r\n            first_air_date: ep.air_date,\r\n            type: 'episode',\r\n            isEpisode: true,\r\n            seriesId: details.id,\r\n            seasonNumber: ep.season_number,\r\n            episodeNumber: ep.episode_number,\r\n        }));\r\n\r\n        if (inWatchlist) {\r\n            // REMOVE FROM SUPABASE\r\n            const idsToRemove = [seasonItem.id, ...episodes.map(e => e.id)];\r\n            const success = await watchlistService.removeFromWatchlistBulk(currentUser.uid, idsToRemove);\r\n\r\n            if (success) {\r\n                // Update Local State\r\n                setEpisodeWatchlistIDs(prev => prev.filter(id => !episodes.some(e => e.id === id)));\r\n                setInWatchlist(false);\r\n            }\r\n        } else {\r\n            // ADD TO SUPABASE\r\n            const itemsToAdd = [seasonItem, ...episodeItems];\r\n            const success = await watchlistService.addToWatchlist(currentUser.uid, itemsToAdd);\r\n\r\n            if (success) {\r\n                // Update Local State\r\n                setEpisodeWatchlistIDs(prev => [...new Set([...prev, ...episodes.map(e => e.id)])]);\r\n                setInWatchlist(true);\r\n\r\n                // LOG ACTIVITY (Using Firebase Auth Context for user object)\r\n                logActivity(userData || currentUser, 'watchlist', {\r\n                    id: details.id,\r\n                    name: details.name,\r\n                    poster_path: details.poster_path,\r\n                    seasonNumber: selectedSeason\r\n                });\r\n            }\r\n        }\r\n    };\r\n\r\n    const toggleLike = async () => {\r\n        if (!currentUser) {\r\n            navigate('/login');\r\n            return;\r\n        }\r\n\r\n        const newStatus = !isLiked;\r\n        // Optimistic UI Update\r\n        setIsLiked(newStatus);\r\n\r\n        try {\r\n            if (newStatus) {\r\n                await likesService.likeSeason(currentUser.uid, details.id, selectedSeason);\r\n            } else {\r\n                await likesService.unlikeSeason(currentUser.uid, details.id, selectedSeason);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Like toggle failed\", error);\r\n            setIsLiked(!newStatus); // Revert on error\r\n        }\r\n    };\r\n\r\n    // Watched Logic\r\n\r\n\r\n    useEffect(() => {\r\n        if (details) {\r\n            checkWatched(details.id);\r\n        }\r\n    }, [details]);\r\n\r\n    const checkWatched = (tmdbId) => {\r\n        // Handled by syncUserState effect\r\n    };\r\n\r\n    const toggleWatched = async () => {\r\n        if (!currentUser || !seasonDetails || !seasonDetails.episodes) return;\r\n        const userRef = doc(db, 'users', currentUser.uid);\r\n\r\n        // Define Episode Items for Bulk Add (Derived from seasonDetails.episodes)\r\n        // Note: We use seasonDetails.episodes because 'episodes' state might be partial or filtered in some contexts, \r\n        // but 'seasonDetails' is what we fetched for the season view.\r\n        const seasonPoster = seasonDetails?.poster_path || details.poster_path;\r\n        const episodeItems = seasonDetails.episodes.map(ep => ({\r\n            id: ep.id,\r\n            episodeId: ep.id,\r\n            seriesId: details.id,\r\n            name: details.name,\r\n            episodeName: ep.name,\r\n            poster_path: details.poster_path, // Series Poster\r\n            // seasonPoster: seasonPoster, // Optional validation\r\n            still_path: ep.still_path,\r\n            vote_average: ep.vote_average,\r\n            first_air_date: ep.air_date,\r\n            type: 'episode',\r\n            date: new Date().toISOString(),\r\n            isEpisode: true,\r\n            seasonNumber: ep.season_number,\r\n            episodeNumber: ep.episode_number\r\n        }));\r\n\r\n        if (isWatched) {\r\n            // UNMARK SEASON WATCHED\r\n            // Action: Remove ALL episodes of this season from 'watched'\r\n            if (userData) {\r\n                const newWatched = (userData.watched || []).filter(i =>\r\n                    !(i.seriesId === details.id && i.seasonNumber === selectedSeason)\r\n                );\r\n                await updateDoc(userRef, { watched: newWatched });\r\n\r\n                // Update Local State\r\n                const seasonEpIds = seasonDetails.episodes.map(e => e.id);\r\n                setEpisodeWatchedIDs(prev => prev.filter(id => !seasonEpIds.includes(id)));\r\n            }\r\n        } else {\r\n            // MARK SEASON WATCHED\r\n            // Action: Add ALL episodes to 'watched' AND Remove ALL from 'watchlist'\r\n            if (userData) {\r\n                const data = userData;\r\n                const currentWatched = data.watched || [];\r\n                const currentWatchlist = data.watchlist || [];\r\n\r\n                // 1. Remove from Watchlist (Strict Rule)\r\n                const seasonEpIds = new Set(seasonDetails.episodes.map(e => e.id));\r\n                const newWatchlist = currentWatchlist.filter(i => {\r\n                    // Remove if it matches a Season Episode\r\n                    if (seasonEpIds.has(i.id)) return false;\r\n                    // Remove if it matches the Series ID (Series Item)\r\n                    // \"remove that series if user watchlisted he watched series one season\"\r\n                    if ((i.id === details.id || i.seriesId === details.id) && !i.episodeNumber && !i.seasonNumber) return false;\r\n                    return true;\r\n                });\r\n\r\n                // 2. Add to Watched (Avoid Duplicates)\r\n                const existingWatchedIds = new Set(currentWatched.map(i => i.id));\r\n                const itemsToAdd = episodeItems.filter(item => !existingWatchedIds.has(item.id));\r\n\r\n                // If any items are added, check for completion logic\r\n                let newAchievements = [];\r\n                let newStarSeries = [];\r\n                const updatedWatched = [...currentWatched, ...itemsToAdd];\r\n\r\n                // Check Season Completion (should be true by definition involved here)\r\n                const achievementId = `${details.id}-S${selectedSeason}-COMPLETED`;\r\n                const currentAchievements = data.achievements || [];\r\n                if (!currentAchievements.some(a => a.id === achievementId)) {\r\n                    newAchievements.push({\r\n                        id: achievementId,\r\n                        seriesId: details.id,\r\n                        name: details.name,\r\n                        seasonNumber: selectedSeason,\r\n                        type: 'season_finish',\r\n                        date: new Date().toISOString(),\r\n                        poster_path: details.poster_path\r\n                    });\r\n                    // Unlock Poster\r\n                    await handleSeasonCompletedFlow(selectedSeason);\r\n                }\r\n\r\n                // Check Series Completion\r\n                const uniqueWatchedIDs = new Set(updatedWatched.filter(w => w.seriesId === details.id).map(w => w.id));\r\n                if (uniqueWatchedIDs.size >= details.number_of_episodes) {\r\n                    const seriesAchievementId = `${details.id}-SERIES-COMPLETED`;\r\n                    if (!currentAchievements.some(a => a.id === seriesAchievementId)) {\r\n                        newAchievements.push({\r\n                            id: seriesAchievementId,\r\n                            seriesId: details.id,\r\n                            name: details.name,\r\n                            type: 'series_finish',\r\n                            date: new Date().toISOString(),\r\n                            poster_path: details.poster_path\r\n                        });\r\n                        const currentStarSeries = data.starSeries || [];\r\n                        if (!currentStarSeries.some(s => s.id === details.id)) {\r\n                            newStarSeries.push({\r\n                                id: details.id,\r\n                                name: details.name,\r\n                                poster_path: details.poster_path,\r\n                                date: new Date().toISOString()\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n\r\n                const updatePayload = {\r\n                    watched: arrayUnion(...itemsToAdd),\r\n                    watchlist: newWatchlist\r\n                };\r\n                if (newAchievements.length > 0) updatePayload.achievements = arrayUnion(...newAchievements);\r\n                if (newStarSeries.length > 0) updatePayload.starSeries = arrayUnion(...newStarSeries);\r\n\r\n                await updateDoc(userRef, updatePayload);\r\n\r\n                // Update Local State\r\n                const allSeasonIpIds = seasonDetails.episodes.map(e => e.id);\r\n                setEpisodeWatchedIDs(prev => [...new Set([...prev, ...allSeasonIpIds])]);\r\n                setEpisodeWatchlistIDs(prev => prev.filter(id => !allSeasonIpIds.includes(id)));\r\n\r\n                // LOG ACTIVITY (Smart Season Log)\r\n                // This will auto-delete any individual 'watched_episode' logs for this season\r\n                logActivity(userData || currentUser, 'watched_season', {\r\n                    id: details.id,\r\n                    seriesId: details.id,\r\n                    name: details.name,\r\n                    seriesName: details.name,\r\n                    poster_path: details.poster_path, // Series Poster usually preferred for activity\r\n                    seasonNumber: selectedSeason,\r\n                    seasonPoster: seasonDetails?.poster_path\r\n                });\r\n            }\r\n        }\r\n        // Optimistic UI update (will be consistent with effect on next render)\r\n        setIsWatched(!isWatched);\r\n    };\r\n\r\n    // Removed addToWatched helper as it's merged or unnecessary with direct FS calls\r\n\r\n    // Episode Watchlist Logic\r\n\r\n\r\n    // Initialize Watchlist from LocalStorage (Legacy/Guest?) - Keeping Watchlist logic but removing Watched\r\n    useEffect(() => {\r\n        const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');\r\n        setEpisodeWatchlistIDs(watchlist.filter(i => i.isEpisode).map(i => i.id));\r\n    }, []);\r\n\r\n    const checkEpisodeWatched = (ep) => {\r\n        // Updated to use S-E composite key from Set\r\n        // Accepts either an episode object { season_number, episode_number } OR just the IDs if we refactor callers.\r\n        // Existing callers pass `ep.id`. We need to handle that.\r\n        // If passed an ID (number/string), we must find the episode object from `episodes` state (if available).\r\n\r\n        let sNum, eNum;\r\n\r\n        if (typeof ep === 'object' && ep !== null && ep.season_number !== undefined) {\r\n            sNum = ep.season_number;\r\n            eNum = ep.episode_number;\r\n        } else {\r\n            // It's an ID. Try to find in `episodes` list (for current season)\r\n            const found = episodes.find(e => e.id === ep);\r\n            if (found) {\r\n                sNum = found.season_number;\r\n                eNum = found.episode_number;\r\n            } else {\r\n                // If not found in current season list, we can't verify watched status easily with just ID \r\n                // unless we have a full map. But usually we only render current season.\r\n                return false;\r\n            }\r\n        }\r\n        return episodeWatchedIDs.has(`${sNum}-${eNum}`);\r\n    };\r\n\r\n    // Effect to update `isWatched` (Season Completion) based on `episodeWatchedIDs`\r\n    useEffect(() => {\r\n        if (seasonDetails?.episodes && seasonDetails.episodes.length > 0) {\r\n            const allWatched = seasonDetails.episodes.every(ep =>\r\n                checkEpisodeWatched(ep)\r\n            );\r\n            setIsWatched(allWatched);\r\n        }\r\n    }, [episodeWatchedIDs, seasonDetails]);\r\n\r\n    // Centralized Season Completion Trigger\r\n    useEffect(() => {\r\n        if (isWatched && details && userData) {\r\n            const completedKey = String(details.id);\r\n            const completedSeasons = userData.completedSeasons?.[completedKey] || [];\r\n            const isCompleted = completedSeasons.includes(Number(selectedSeason));\r\n\r\n            // Trigger flow only if not already recorded as completed in Firestore\r\n            if (!isCompleted) {\r\n                handleSeasonCompletedFlow(selectedSeason);\r\n            }\r\n        }\r\n    }, [isWatched, details, userData, selectedSeason]);\r\n\r\n    const checkEpisodeInWatchlist = (epId) => {\r\n        return episodeWatchlistIDs.includes(epId);\r\n    };\r\n\r\n    const toggleEpisodeWatched = async (episode) => {\r\n        if (!currentUser) return;\r\n\r\n        // Composite Key\r\n        const key = `${episode.season_number}-${episode.episode_number}`;\r\n        const isCurrentlyWatched = episodeWatchedIDs.has(key);\r\n\r\n        // Optimistic Update\r\n        setEpisodeWatchedIDs(prev => {\r\n            const next = new Set(prev);\r\n            if (isCurrentlyWatched) next.delete(key);\r\n            else next.add(key);\r\n            return next;\r\n        });\r\n\r\n        // Backend Call (Supabase Only)\r\n        let success = false;\r\n        if (isCurrentlyWatched) {\r\n            success = await unmarkEpisodeWatched(currentUser.uid, details.id, episode.season_number, episode.episode_number);\r\n        } else {\r\n            success = await markEpisodeWatched(currentUser.uid, details.id, episode.season_number, episode.episode_number);\r\n\r\n            if (success) {\r\n                // NEW: Remove from Watchlist (Supabase)\r\n                watchlistService.removeFromWatchlist(currentUser.uid, episode.id);\r\n            }\r\n        }\r\n\r\n        if (!success) {\r\n            // Revert\r\n            setEpisodeWatchedIDs(prev => {\r\n                const next = new Set(prev);\r\n                if (isCurrentlyWatched) next.add(key);\r\n                else next.delete(key);\r\n                return next;\r\n            });\r\n            alert(\"Failed to update status.\");\r\n        }\r\n    };\r\n\r\n    const toggleSeasonWatched = async () => {\r\n        if (!currentUser || !seasonDetails || !seasonDetails.episodes) return;\r\n\r\n        const episodesToToggle = seasonDetails.episodes;\r\n        const shouldMarkWatched = !isWatched;\r\n\r\n        try {\r\n            if (shouldMarkWatched) {\r\n                // MARK ALL - Use markSeasonWatched service (triggers migration if needed)\r\n                const success = await markSeasonWatched(\r\n                    currentUser.uid,\r\n                    details.id,\r\n                    selectedSeason,\r\n                    episodesToToggle.length\r\n                );\r\n\r\n                if (success) {\r\n                    const allKeys = episodesToToggle.map(ep => `${ep.season_number}-${ep.episode_number}`);\r\n                    setEpisodeWatchedIDs(prev => new Set([...prev, ...allKeys]));\r\n                    setIsWatched(true);\r\n\r\n                    // NEW: Remove from Watchlist (Supabase)\r\n                    const idsToRemove = [seasonDetails?.id || Number(`${details.id}${selectedSeason}`), ...episodesToToggle.map(e => e.id)];\r\n                    watchlistService.removeFromWatchlistBulk(currentUser.uid, idsToRemove);\r\n\r\n                    // Update Local Watchlist State\r\n                    setInWatchlist(false);\r\n                    setEpisodeWatchlistIDs(prev => prev.filter(id => !episodesToToggle.some(e => e.id === id)));\r\n\r\n                    // DIARY MIGRATION: Log Season Completed\r\n                    diaryService.addSeasonCompletedEntry(\r\n                        currentUser.uid,\r\n                        details.id,\r\n                        selectedSeason,\r\n                        details.name,\r\n                        seasonDetails.poster_path || details.poster_path\r\n                    );\r\n\r\n                    // CHECK SERIES COMPLETION\r\n                    if (details.seasons) {\r\n                        const releasedSeasons = details.seasons.filter(s => s.season_number > 0 && s.air_date && new Date(s.air_date) <= new Date());\r\n                        let allSeasonsWatched = true;\r\n\r\n                        for (const s of releasedSeasons) {\r\n                            if (s.season_number === Number(selectedSeason)) continue;\r\n\r\n                            if (s.episode_count) {\r\n                                for (let i = 1; i <= s.episode_count; i++) {\r\n                                    if (!episodeWatchedIDs.has(`${s.season_number}-${i}`)) {\r\n                                        allSeasonsWatched = false;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                            if (!allSeasonsWatched) break;\r\n                        }\r\n\r\n                        if (allSeasonsWatched) {\r\n                            diaryService.addSeriesCompletedEntry(currentUser.uid, details.id, details.name, details.poster_path);\r\n                        }\r\n                    }\r\n                } else {\r\n                    throw new Error('Failed to mark season watched');\r\n                }\r\n            } else {\r\n                // UNMARK ALL\r\n                await Promise.all(episodesToToggle.map(ep =>\r\n                    unmarkEpisodeWatched(currentUser.uid, details.id, ep.season_number, ep.episode_number)\r\n                ));\r\n                const allKeys = new Set(episodesToToggle.map(ep => `${ep.season_number}-${ep.episode_number}`));\r\n                setEpisodeWatchedIDs(prev => {\r\n                    const next = new Set(prev);\r\n                    for (const k of allKeys) next.delete(k);\r\n                    return next;\r\n                });\r\n                setIsWatched(false);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error toggling season watched:\", error);\r\n            setIsWatched(!shouldMarkWatched);\r\n        }\r\n    };\r\n\r\n    const toggleEpisodeWatchlist = async (episode) => {\r\n        if (!currentUser) return;\r\n\r\n        // Find correct season poster\r\n        const seasonPoster = (seasonDetails && seasonDetails.season_number === episode.season_number)\r\n            ? seasonDetails.poster_path\r\n            : null;\r\n\r\n        const itemToSave = {\r\n            id: episode.id,\r\n            name: `${details.name} - S${episode.season_number}E${episode.episode_number}: ${episode.name}`,\r\n            poster_path: details.poster_path,\r\n            seasonPoster: seasonPoster,\r\n            still_path: episode.still_path,\r\n            vote_average: episode.vote_average,\r\n            first_air_date: episode.air_date,\r\n            type: 'episode',\r\n            isEpisode: true,\r\n            seriesId: details.id,\r\n            seasonNumber: episode.season_number,\r\n            episodeNumber: episode.episode_number,\r\n        };\r\n\r\n        if (checkEpisodeInWatchlist(episode.id)) {\r\n            // REMOVE FROM WATCHLIST (Supabase)\r\n            const success = await watchlistService.removeFromWatchlist(currentUser.uid, episode.id);\r\n            if (success) {\r\n                setEpisodeWatchlistIDs(prev => prev.filter(id => id !== episode.id));\r\n            }\r\n        } else {\r\n            // ADD TO WATCHLIST (Supabase)\r\n            const success = await watchlistService.addToWatchlist(currentUser.uid, itemToSave);\r\n\r\n            if (success) {\r\n                // STRICT RULE: Reset Watched State\r\n                setEpisodeWatchedIDs(prev => {\r\n                    const next = new Set(prev);\r\n                    next.delete(`${episode.season_number}-${episode.episode_number}`);\r\n                    return next;\r\n                });\r\n                setEpisodeWatchlistIDs(prev => [...new Set([...prev, episode.id])]);\r\n\r\n                // Also unmark in Supabase\r\n                unmarkEpisodeWatched(currentUser.uid, details.id, episode.season_number, episode.episode_number);\r\n            }\r\n        }\r\n    };\r\n\r\n\r\n\r\n    const handleReviewLike = async (reviewId) => {\r\n        if (!currentUser) return;\r\n\r\n        const review = reviewsData.find(r => r.id === reviewId);\r\n        if (!review) return;\r\n\r\n        const hasUserLikedReview = review.likes && review.likes.includes(currentUser.uid);\r\n        const userRef = doc(db, 'users', currentUser.uid);\r\n        const reviewRef = doc(db, 'reviews', reviewId);\r\n\r\n        try {\r\n            if (hasUserLikedReview) {\r\n                // Unlike: Remove UID from review.likes\r\n                await updateDoc(reviewRef, { likes: arrayRemove(currentUser.uid) });\r\n\r\n                // Remove from User Activity (Read-Modify-Write for safe object removal)\r\n                if (userData) {\r\n                    const newLikes = (userData.likes || []).filter(l => !(l.type === 'like_review' && l.reviewId === reviewId));\r\n                    await updateDoc(userRef, { likes: newLikes });\r\n                }\r\n\r\n                // Update Local State\r\n                setReviewsData(prev => prev.map(r => {\r\n                    if (r.id === reviewId) {\r\n                        return { ...r, likes: (r.likes || []).filter(uid => uid !== currentUser.uid) };\r\n                    }\r\n                    return r;\r\n                }));\r\n\r\n            } else {\r\n                // Like: Add UID to review.likes\r\n                await updateDoc(reviewRef, { likes: arrayUnion(currentUser.uid) });\r\n\r\n                // Add to User Activity\r\n                const activityItem = {\r\n                    type: 'like_review',\r\n                    reviewId: review.id,\r\n                    targetUserId: review.userId,\r\n                    targetUsername: review.userName || review.author || 'User',\r\n                    seriesId: details.id,\r\n                    name: details.name, // Series Name\r\n                    seasonNumber: review.seasonNumber,\r\n                    episodeNumber: review.episodeNumber,\r\n                    poster_path: details.poster_path,\r\n                    seasonPoster: seasonDetails?.poster_path,\r\n                    date: new Date().toISOString()\r\n                };\r\n                await updateDoc(userRef, { likes: arrayUnion(activityItem) });\r\n\r\n                // Update Local State\r\n                setReviewsData(prev => prev.map(r => {\r\n                    if (r.id === reviewId) {\r\n                        return { ...r, likes: [...(r.likes || []), currentUser.uid] };\r\n                    }\r\n                    return r;\r\n                }));\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error toggling review like:\", error);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    // Get existing review for an item\r\n    // Get existing review for an item\r\n    const getExistingReview = (itemId, isEpisode = false, isSeason = false, seasonNum = null, episodeNum = null) => {\r\n        if (!currentUser) return null;\r\n        if (isEpisode) {\r\n            // Fix: Lookup by Season/Episode Number which is reliable (database doesn't always store unique TMDB episode ID)\r\n            // itemId in this context is treated as seriesId if we switch usage, OR we just ignore itemId and use scope 'details.id'\r\n            // Let's use details.id (context) + seasonNum + episodeNum\r\n            return reviewsData.find(r =>\r\n                r.tmdbId === parseInt(details.id) &&\r\n                r.seasonNumber === seasonNum &&\r\n                r.episodeNumber === episodeNum &&\r\n                r.isEpisode &&\r\n                r.userId === currentUser.uid\r\n            );\r\n        } else if (isSeason) {\r\n            return reviewsData.find(r => r.tmdbId === itemId && r.isSeason && r.seasonNumber === seasonNum && r.userId === currentUser.uid);\r\n        } else {\r\n            // Series (Default)\r\n            return reviewsData.find(r => r.tmdbId === itemId && !r.isEpisode && !r.isSeason && r.userId === currentUser.uid);\r\n        }\r\n    };\r\n\r\n    const handleSeasonReview = (seasonNum) => {\r\n        const existing = getExistingReview(details.id, false, true, seasonNum); // itemId, isEpisode, isSeason, seasonNum\r\n        setExistingReviewData(existing || null);\r\n        setReviewingItem({\r\n            type: 'season',\r\n            id: details.id,\r\n            name: `${details.name} (Season ${seasonNum})`,\r\n            seasonNumber: seasonNum\r\n        });\r\n        setIsReviewOpen(true);\r\n    };\r\n\r\n    const handleEditReview = (review) => {\r\n        setExistingReviewData(review);\r\n        setReviewingItem({\r\n            type: review.isEpisode ? 'episode' : (review.isSeason ? 'season' : 'series'),\r\n            id: review.isEpisode ? review.episodeId : review.tmdbId,\r\n            name: review.topicName || details.name, // generic fallback\r\n            seasonNumber: review.seasonNumber,\r\n            episodeNumber: review.episodeNumber\r\n        });\r\n        setIsReviewOpen(true);\r\n    }\r\n\r\n    // Review Submit Logic (Common for Series, Season, Episode)\r\n    const handleReviewSubmit = async (data) => {\r\n        if (!currentUser) return;\r\n        console.log(\"ðŸš€ handleReviewSubmit STARTED\", data);\r\n        const { rating, review } = data;\r\n\r\n        // Determine Targets\r\n        let targetId = reviewingItem.id;\r\n        let isEpisode = reviewingItem.type === 'episode';\r\n        let isSeason = reviewingItem.type === 'season';\r\n\r\n        console.log(\"ðŸ” DEBUG: reviewingItem =\", reviewingItem);\r\n        console.log(\"ðŸ” DEBUG: isEpisode =\", isEpisode, \"| isSeason =\", isSeason);\r\n        console.log(\"ðŸ” DEBUG: existingReviewData =\", existingReviewData);\r\n\r\n        let newReview = null; // Fix: Declare here for function-wide scope\r\n\r\n        // Define Doc Ref (Update if exists, Add if new)\r\n        // We can't use setDoc with custom ID easily unless we enforce ID gen.\r\n        // But we have 'existingReviewData' which contains the ID if editing.\r\n\r\n        try {\r\n            if (existingReviewData && existingReviewData.id) {\r\n                console.log(\"âœ… ENTERING UPDATE BLOCK\");\r\n                // UPDATE / EDIT FLOW\r\n                console.log(\"ðŸ“ Editing Review...\", existingReviewData);\r\n\r\n                if (existingReviewData.source === 'supabase') {\r\n                    // Update in Supabase\r\n                    console.log(\"ðŸ”„ Updating Supabase Review...\");\r\n                    if (isSeason) {\r\n                        await reviewService.updateSeasonReview(existingReviewData.id, review, rating ? parseFloat(rating) : null);\r\n                        // Update Rating Table too? usually create handles it. Update logic for rating separate?\r\n                        // ratingsService.setSeasonRating uses upsert, so we can call it.\r\n                        if (rating) await ratingsService.setSeasonRating(currentUser.uid, parseInt(details.id), reviewingItem.seasonNumber, parseFloat(rating));\r\n                    } else if (isEpisode) {\r\n                        await reviewService.updateEpisodeReview(existingReviewData.id, review, rating ? parseFloat(rating) : null);\r\n                        if (rating) await ratingsService.setEpisodeRating(currentUser.uid, parseInt(details.id), reviewingItem.seasonNumber, reviewingItem.episodeNumber, parseFloat(rating));\r\n                    }\r\n\r\n                    // Local state update\r\n                    setReviewsData(prev => prev.map(r => r.id === existingReviewData.id ? { ...r, rating: rating.toString(), review, updatedAt: new Date().toISOString() } : r));\r\n\r\n                } else {\r\n                    // Source is Firebase (Legacy) -> MIGRATE TO SUPABASE\r\n                    // effectively a CREATE in Supabase\r\n                    console.log(\"ðŸš€ Migrating Legacy Review to Supabase...\");\r\n\r\n                    // We treat it as a new creation in Supabase\r\n                    if (isSeason) {\r\n                        // Call Create Logic (copied from below or extracted)\r\n                        const result = await reviewService.createSeasonReview(\r\n                            currentUser.uid,\r\n                            parseInt(details.id),\r\n                            reviewingItem.seasonNumber,\r\n                            review,\r\n                            rating ? parseFloat(rating) : null,\r\n                            currentUser.displayName || currentUser.email || 'User',\r\n                            currentUser.photoURL\r\n                        );\r\n                        if (rating) await ratingsService.setSeasonRating(currentUser.uid, parseInt(details.id), reviewingItem.seasonNumber, parseFloat(rating));\r\n\r\n                        // We should probably remove the Firebase one to avoid duplicates?\r\n                        // deleteDoc(doc(db, 'reviews', existingReviewData.id)); // Optional: Delete legacy\r\n                    } else if (isEpisode) {\r\n                        const result = await reviewService.createEpisodeReview(\r\n                            currentUser.uid,\r\n                            parseInt(details.id),\r\n                            reviewingItem.seasonNumber,\r\n                            reviewingItem.episodeNumber,\r\n                            review,\r\n                            rating ? parseFloat(rating) : null,\r\n                            currentUser.displayName || currentUser.email || 'User',\r\n                            currentUser.photoURL\r\n                        );\r\n                        if (rating) await ratingsService.setEpisodeRating(currentUser.uid, parseInt(details.id), reviewingItem.seasonNumber, reviewingItem.episodeNumber, parseFloat(rating));\r\n                    }\r\n\r\n                    // Force refresh or local update?\r\n                    // Ideally we replace the firebase item in local state with the new supabase one.\r\n                    // But simpler is to allow local state to wait for refresh or just update the object values.\r\n                    setReviewsData(prev => prev.map(r => r.id === existingReviewData.id ? { ...r, rating: rating.toString(), review, source: 'supabase', updatedAt: new Date().toISOString() } : r));\r\n                }\r\n\r\n            } else {\r\n\r\n                console.log(\"âœ… ENTERING CREATE BLOCK\");\r\n                // CREATE - Use Supabase via reviewService\r\n                // newReview is already declared at top scope\r\n                if (isEpisode) {\r\n                    const result = await reviewService.createEpisodeReview(\r\n                        currentUser.uid,\r\n                        parseInt(details.id),\r\n                        reviewingItem.seasonNumber,\r\n                        reviewingItem.episodeNumber,\r\n                        review,\r\n                        rating ? parseFloat(rating) : null,\r\n                        userData?.username || currentUser.displayName || currentUser.email?.split('@')[0] || 'User',\r\n                        currentUser.photoURL\r\n                    );\r\n                    if (!result.success) {\r\n                        console.error('Failed to create episode review:', result.error);\r\n                        return;\r\n                    }\r\n                    newReview = result.data;\r\n\r\n                    // PHASE 2.2: ALSO write rating separately to episode_ratings table\r\n                    if (rating) {\r\n                        await ratingsService.setEpisodeRating(\r\n                            currentUser.uid,\r\n                            parseInt(details.id),\r\n                            reviewingItem.seasonNumber,\r\n                            reviewingItem.episodeNumber,\r\n                            parseFloat(rating)\r\n                        );\r\n                    }\r\n                } else if (isSeason) {\r\n                    console.log(\"ðŸ“ Creating Season Review via Supabase...\");\r\n                    const result = await reviewService.createSeasonReview(\r\n                        currentUser.uid,\r\n                        parseInt(details.id),\r\n                        reviewingItem.seasonNumber,\r\n                        review,\r\n                        rating ? parseFloat(rating) : null,\r\n                        userData?.username || currentUser.displayName || currentUser.email?.split('@')[0] || 'User',\r\n                        currentUser.photoURL\r\n                    );\r\n                    console.log(\"ðŸ“¡ Supabase Response:\", result);\r\n\r\n                    if (!result.success) {\r\n                        console.error('Failed to create season review:', result.error);\r\n                        return;\r\n                    }\r\n                    newReview = result.data;\r\n\r\n                    // PHASE 2.2: ALSO write rating separately to season_ratings table\r\n                    if (rating) {\r\n                        try {\r\n                            await ratingsService.setSeasonRating(\r\n                                currentUser.uid,\r\n                                parseInt(details.id),\r\n                                reviewingItem.seasonNumber,\r\n                                parseFloat(rating)\r\n                            );\r\n\r\n                            // DIARY MIGRATION: Log Season Rated\r\n                            await diaryService.addSeasonRatedEntry(\r\n                                currentUser.uid,\r\n                                parseInt(details.id),\r\n                                reviewingItem.seasonNumber,\r\n                                parseFloat(rating),\r\n                                details.name,\r\n                                seasonDetails?.poster_path || details.poster_path\r\n                            );\r\n\r\n                        } catch (err) {\r\n                            console.error('Error writing to season_ratings or diary:', err);\r\n                        }\r\n                    }\r\n                } else {\r\n                    // SERIES REVIEW (Previously Unhandled Fallthrough)\r\n                    // We continue using Firestore for Series reviews as they don't have a dedicated Supabase table yet (or based on legacy).\r\n                    const reviewDataPayload = {\r\n                        userId: currentUser.uid,\r\n                        userName: currentUser.displayName || currentUser.email?.split('@')[0] || 'User',\r\n                        tmdbId: parseInt(details.id),\r\n                        name: details.name,\r\n                        poster_path: details.poster_path,\r\n                        rating: parseFloat(rating),\r\n                        review: review,\r\n                        updatedAt: new Date().toISOString(),\r\n                        type: 'series',\r\n                        isEpisode: false,\r\n                        isSeason: false,\r\n                        seasonNumber: null,\r\n                        episodeNumber: null,\r\n                        createdAt: new Date().toISOString(),\r\n                        likes: []\r\n                    };\r\n\r\n                    try {\r\n                        const newDocRef = await addDoc(collection(db, 'reviews'), reviewDataPayload);\r\n                        newReview = { ...reviewDataPayload, id: newDocRef.id, source: 'firebase' };\r\n\r\n                        // Success badge logic for Series (Silent)\r\n                        const userRef = doc(db, 'users', currentUser.uid);\r\n                        await updateDoc(userRef, {\r\n                            starSeries: arrayUnion({\r\n                                id: details.id,\r\n                                name: details.name,\r\n                                poster_path: details.poster_path,\r\n                                date: new Date().toISOString()\r\n                            })\r\n                        });\r\n                    } catch (e) {\r\n                        console.error(\"Error creating series review:\", e);\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                // Mark as Watched Logic (Firestore) - Only for Series/Season reviews, not individual episodes\r\n                if (!isEpisode) {\r\n                    const userRef = doc(db, 'users', currentUser.uid);\r\n                    const userSnap = await getDoc(userRef);\r\n                    if (userSnap.exists()) {\r\n                        const data = userSnap.data();\r\n\r\n                        // Robust Duplication Check: Check by ID\r\n                        const isAlreadyInWatched = data.watched?.some(w => String(w.id) === String(details.id));\r\n\r\n                        if (!isAlreadyInWatched) {\r\n                            const itemToSave = {\r\n                                id: details.id,\r\n                                name: details.name,\r\n                                poster_path: details.poster_path,\r\n                                vote_average: details.vote_average,\r\n                                first_air_date: details.first_air_date,\r\n                                type: type,\r\n                                date: new Date().toISOString()\r\n                            };\r\n                            await updateDoc(userRef, {\r\n                                watched: arrayUnion(itemToSave)\r\n                            });\r\n                            setIsWatched(true);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Safety check: Only update local state if review was created successfully\r\n                if (!newReview) {\r\n                    console.error('Review creation failed - newReview is undefined. Debug Info:', {\r\n                        isEpisode,\r\n                        isSeason,\r\n                        reviewingItemType: reviewingItem?.type,\r\n                        resultData: 'Supabase returned undefined data or Series creation failed'\r\n                    });\r\n                    // Show a visual warning to user via console or alert if preferred, but for now log is improved.\r\n                    setIsReviewOpen(false);\r\n                    return;\r\n                }\r\n\r\n                // Update Local - Format Supabase data to match expected structure\r\n                setReviewsData(prev => [...prev, {\r\n                    id: newReview.id,\r\n                    userId: newReview.user_id,\r\n                    userName: userData?.username || currentUser.displayName || currentUser.email?.split('@')[0] || 'User',\r\n                    author: currentUser.email,\r\n                    photoURL: currentUser.photoURL,\r\n                    tmdbId: newReview.tmdb_id,\r\n                    seriesId: details.id,\r\n                    isEpisode: isEpisode,\r\n                    isSeason: isSeason,\r\n                    episodeId: isEpisode ? reviewingItem.id : null,\r\n                    episodeNumber: newReview.episode_number,\r\n                    seasonNumber: newReview.season_number,\r\n                    rating: newReview.rating?.toString(),\r\n                    review: newReview.review_text,\r\n                    createdAt: newReview.created_at,\r\n                    updatedAt: newReview.updated_at,\r\n                    likes: [],\r\n                    source: 'supabase',\r\n                    topicName: reviewingItem.name,\r\n                    poster_path: details.poster_path\r\n                }]);\r\n\r\n                if (!isEpisode) {\r\n                    const userRef = doc(db, 'users', currentUser.uid);\r\n\r\n                    // STRICT RULE: Remove Season Episodes from Watchlist (Supabase)\r\n                    if (seasonDetails && seasonDetails.episodes) {\r\n                        const seasonEpIds = seasonDetails.episodes.map(e => e.id);\r\n                        const seasonId = seasonDetails.id || Number(`${details.id}${selectedSeason}`);\r\n                        watchlistService.removeFromWatchlistBulk(currentUser.uid, [seasonId, ...seasonEpIds]);\r\n\r\n                        // Local Update\r\n                        setEpisodeWatchlistIDs(prev => prev.filter(id => !seasonEpIds.includes(id)));\r\n                    }\r\n\r\n                    // For Achievements and Star Series (STILL FIREBASE)\r\n                    let updates = {};\r\n                    const userSnap = await getDoc(userRef);\r\n                    if (userSnap.exists()) {\r\n                        const data = userSnap.data();\r\n\r\n                        // Mark as Watched Logic (Sync with Supabase via Service)\r\n                        if (seasonDetails && seasonDetails.episodes) {\r\n                            const currentWatched = data.watched || [];\r\n                            const seasonEpIds = new Set(seasonDetails.episodes.map(e => e.id));\r\n                            const existingWatchedIds = new Set(currentWatched.map(i => i.id));\r\n                            const episodeItems = seasonDetails.episodes.filter(ep => !existingWatchedIds.has(ep.id)).map(ep => ({\r\n                                id: ep.id,\r\n                                episodeId: ep.id,\r\n                                seriesId: details.id,\r\n                                name: details.name,\r\n                                episodeName: ep.name,\r\n                                poster_path: details.poster_path, // Series Poster\r\n                                still_path: ep.still_path,\r\n                                vote_average: ep.vote_average,\r\n                                first_air_date: ep.air_date,\r\n                                type: 'episode',\r\n                                date: new Date().toISOString(),\r\n                                isEpisode: true,\r\n                                seasonNumber: ep.season_number,\r\n                                episodeNumber: ep.episode_number\r\n                            }));\r\n\r\n                            if (episodeItems.length > 0) {\r\n                                // Don't use arrayUnion for watched episodes anymore, use Supabase Service for watched status\r\n                                // updates.watched = arrayUnion(...episodeItems); // REMOVED LEGACY WRITE\r\n\r\n                                // Call Mark Service for each\r\n                                await Promise.all(episodeItems.map(ep =>\r\n                                    markEpisodeWatched(currentUser.uid, details.id, ep.seasonNumber, ep.episodeNumber)\r\n                                ));\r\n\r\n                                setEpisodeWatchedIDs(prev => {\r\n                                    const next = new Set(prev);\r\n                                    episodeItems.forEach(ep => next.add(`${ep.seasonNumber}-${ep.episodeNumber}`));\r\n                                    return next;\r\n                                });\r\n                            }\r\n                        }\r\n\r\n                        // Legacy Season Item Logic (Optional check, but we are moving away)\r\n                        // ... Skipping Legacy Season Item Check to avoid mixed states ...\r\n\r\n                        // Star Series Logic\r\n                        const isAlreadyStar = data.starSeries?.some(s => s.id === details.id);\r\n                        if (!isAlreadyStar) {\r\n                            updates.starSeries = arrayUnion({\r\n                                id: details.id,\r\n                                name: details.name,\r\n                                poster_path: details.poster_path,\r\n                                date: new Date().toISOString()\r\n                            });\r\n                        }\r\n                    }\r\n\r\n                    if (Object.keys(updates).length > 0) {\r\n                        await updateDoc(userRef, updates);\r\n                        if (updates.watched) setIsWatched(true);\r\n                    }\r\n                } else {\r\n                    // IS EPISODE REVIEW\r\n                    // STRICT RULE: Remove from Watchlist (Supabase)\r\n                    const epId = reviewingItem.id;\r\n                    watchlistService.removeFromWatchlist(currentUser.uid, epId);\r\n                    setEpisodeWatchlistIDs(prev => prev.filter(id => id !== epId));\r\n                }\r\n                if (!existingReviewData) {\r\n                    const reviewId = newReview ? newReview.id : 'temp-id-' + Date.now();\r\n                    const ratingVal = parseFloat(rating);\r\n                    const freshReviewItem = {\r\n                        id: reviewId,\r\n                        tmdbId: parseInt(details.id),\r\n                        isEpisode, isSeason,\r\n                        seasonNumber: reviewingItem.seasonNumber,\r\n                        episodeNumber: reviewingItem.episodeNumber,\r\n                        rating: ratingVal <= 5 ? ratingVal * 2 : ratingVal,\r\n                        review: review,\r\n                        userId: currentUser.uid,\r\n                        userName: userData?.username || currentUser.displayName || currentUser.email?.split('@')[0] || 'User',\r\n                        photoURL: currentUser.photoURL,\r\n                        topicName: reviewingItem.name,\r\n                    };\r\n                    if (!isEpisode) {\r\n                        handleShare(freshReviewItem, isEpisode, isSeason);\r\n                    }\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error saving review\", e);\r\n        }\r\n        setIsReviewOpen(false);\r\n    };\r\n\r\n    const openEpisodeReview = (ep) => {\r\n        // Fix: Pass correct arguments for new getExistingReview(seriesId, isEp, isSeason, sNum, eNum)\r\n        const existing = getExistingReview(details.id, true, false, ep.season_number, ep.episode_number);\r\n        setExistingReviewData(existing || null);\r\n        setReviewingItem({\r\n            type: 'episode',\r\n            id: ep.id,\r\n            name: `${details.name} S${ep.season_number}E${ep.episode_number}`,\r\n            seasonNumber: ep.season_number,\r\n            episodeNumber: ep.episode_number\r\n        });\r\n        setIsReviewOpen(true);\r\n    };\r\n\r\n\r\n\r\n    const handleAction = async (actionFn) => {\r\n        await actionFn();\r\n    };\r\n\r\n    // The old handleReviewSubmit logic is replaced by the new one above.\r\n    // This section is now removed as per the diff.\r\n    /*\r\n    const handleReviewSubmit = async ({ rating, review }) => {\r\n        if (!currentUser) return;\r\n     \r\n        const isEpisode = reviewingItem !== 'series' && !!reviewingItem?.episode_number;\r\n     \r\n        // NEW FLOW: Removed Popup Interception as requested.\r\n        // Direct Save.\r\n     \r\n        const episodeIdTarget = isEpisode ? reviewingItem.id : null;\r\n     \r\n        // Construct Review Data\r\n        const reviewDataPayload = {\r\n            userId: currentUser.uid,\r\n            userName: currentUser.email?.split('@')[0] || 'User',\r\n            tmdbId: parseInt(id),\r\n            name: isEpisode ? `${details.name} (S${reviewingItem.season_number}E${reviewingItem.episode_number})` : details.name,\r\n            poster_path: details.poster_path, // Series poster usually used\r\n            rating: parseFloat(rating),\r\n            review: review,\r\n            updatedAt: new Date().toISOString(),\r\n            type: type,\r\n            isEpisode: isEpisode,\r\n            seasonNumber: isEpisode ? reviewingItem.season_number : null,\r\n            episodeNumber: isEpisode ? reviewingItem.episode_number : null,\r\n            episodeId: episodeIdTarget\r\n        };\r\n     \r\n        try {\r\n            // Check for existing review explicitly\r\n            let existingDocId = null;\r\n            const existingReview = reviewsData.find(r =>\r\n                r.userId === currentUser.uid &&\r\n                r.tmdbId === parseInt(id) &&\r\n                r.isEpisode === isEpisode &&\r\n                (isEpisode ? r.episodeId === episodeIdTarget : true)\r\n            );\r\n     \r\n            if (existingReview) {\r\n                existingDocId = existingReview.id;\r\n            } else {\r\n                // Double check Firestore if not found in local state (paranoid check)\r\n                const q = query(\r\n                    collection(db, 'reviews'),\r\n                    where('userId', '==', currentUser.uid),\r\n                    where('tmdbId', '==', parseInt(id)),\r\n                    where('isEpisode', '==', isEpisode)\r\n                );\r\n                const snap = await getDocs(q);\r\n                const match = snap.docs.find(d => isEpisode ? d.data().episodeId === episodeIdTarget : true);\r\n                if (match) existingDocId = match.id;\r\n            }\r\n     \r\n            if (existingDocId) {\r\n                // Update\r\n                const reviewRef = doc(db, 'reviews', existingDocId);\r\n                await updateDoc(reviewRef, {\r\n                    ...reviewDataPayload,\r\n                    // Preserve createdAt, likes\r\n                });\r\n     \r\n                // Update Local\r\n                setReviewsData(prev => prev.map(r => r.id === existingDocId ? { ...r, ...reviewDataPayload } : r));\r\n     \r\n                setIsReviewOpen(false);\r\n     \r\n                // SUCCESS FLOW (Silent Badge Add)\r\n                if (!isEpisode) {\r\n                    const userRef = doc(db, 'users', currentUser.uid);\r\n                    await updateDoc(userRef, {\r\n                        starSeries: arrayUnion({\r\n                            id: details.id,\r\n                            name: details.name,\r\n                            poster_path: details.poster_path,\r\n                            date: new Date().toISOString()\r\n                        })\r\n                    });\r\n                    // setShowStarBadge(true); // Removed\r\n                }\r\n     \r\n            } else {\r\n                // Create New\r\n                const newDocRef = await addDoc(collection(db, 'reviews'), {\r\n                    ...reviewDataPayload,\r\n                    createdAt: new Date().toISOString(),\r\n                    likes: []\r\n                });\r\n     \r\n                // Mark as Watched Logic (Firestore)\r\n                if (!isEpisode) {\r\n                    const userRef = doc(db, 'users', currentUser.uid);\r\n                    const userSnap = await getDoc(userRef);\r\n                    if (userSnap.exists()) {\r\n                        const data = userSnap.data();\r\n     \r\n                        // Robust Duplication Check: Check by ID\r\n                        const isAlreadyInWatched = data.watched?.some(w => String(w.id) === String(details.id));\r\n     \r\n                        if (!isAlreadyInWatched) {\r\n                            const itemToSave = {\r\n                                id: details.id,\r\n                                name: details.name,\r\n                                poster_path: details.poster_path,\r\n                                vote_average: details.vote_average,\r\n                                first_air_date: details.first_air_date,\r\n                                type: type,\r\n                                date: new Date().toISOString()\r\n                            };\r\n                            await updateDoc(userRef, {\r\n                                watched: arrayUnion(itemToSave)\r\n                            });\r\n                            setIsWatched(true);\r\n                        }\r\n                    }\r\n                }\r\n     \r\n                // Update Local\r\n                setReviewsData(prev => [...prev, { ...reviewDataPayload, id: newDocRef.id, likes: [], createdAt: new Date().toISOString() }]);\r\n     \r\n                setIsReviewOpen(false);\r\n     \r\n                // SUCCESS FLOW (Silent Badge Add)\r\n                if (!isEpisode) {\r\n                    const userRef = doc(db, 'users', currentUser.uid);\r\n                    await updateDoc(userRef, {\r\n                        starSeries: arrayUnion({\r\n                            id: details.id,\r\n                            name: details.name,\r\n                            poster_path: details.poster_path,\r\n                            date: new Date().toISOString()\r\n                        })\r\n                    });\r\n                    // setShowStarBadge(true); // Removed\r\n                }\r\n            }\r\n     \r\n        } catch (error) {\r\n            console.error(\"Error saving review: \", error);\r\n        }\r\n    };\r\n    */\r\n\r\n    if (loading) return <PremiumLoader message=\"Fetching series details...\" />;\r\n    if (!details) return <div className=\"loading\" style={{ color: '#FFD600', textAlign: 'center', marginTop: '100px' }}>Series not found</div>;\r\n\r\n\r\n    const date = details.first_air_date;\r\n\r\n    const backdropUrl = `https://image.tmdb.org/t/p/original${details.backdrop_path}`;\r\n    // Use Season Poster if seasonDetails exists (and matches selectedSeason, implicit via fetch)\r\n    const rawPosterPath = seasonDetails?.poster_path || details.poster_path;\r\n    // GLOBAL FIX: Resolve from globalPosters > Fallback to TMDB\r\n    const resolvedPath = resolvePoster(details.id, rawPosterPath, globalPosters);\r\n    const posterUrl = resolvedPath ? `https://image.tmdb.org/t/p/w500${resolvedPath}` : null;\r\n\r\n\r\n\r\n\r\n    const getEmoji = (val) => {\r\n        const iconStyle = { color: 'black', fontSize: '1.4rem' }; // Black drawing\r\n        const bgStyle = {\r\n            background: '#FFCC00', // Yellow face\r\n            borderRadius: '4px', // SQUARE BORDER\r\n            width: '28px',\r\n            height: '28px',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            // border: '2px solid black' // Removed border as simple yellow circle with black face looks cleaner like emoji\r\n        };\r\n\r\n        // Custom Logic based on Image (Happy, Neutral, Sad)\r\n        // 5 faces in image? user asked for \"emojies like that photo\".\r\n        // I will stick to 3 for now, mapped to 0-10 scale.\r\n        // >= 7: Happy\r\n        // 4-6: Neutral\r\n        // < 4: Sad\r\n\r\n        let Icon = MdSentimentVeryDissatisfied;\r\n        if (val >= 7) Icon = MdSentimentSatisfiedAlt;\r\n        else if (val >= 4) Icon = MdSentimentNeutral;\r\n\r\n        return (\r\n            <div style={bgStyle}>\r\n                <Icon style={iconStyle} />\r\n            </div>\r\n        );\r\n    };\r\n\r\n\r\n\r\n    return (\r\n        <div className=\"movie-details-container\">\r\n            <div\r\n                className=\"backdrop-overlay\"\r\n                style={{\r\n                    backgroundImage: `linear-gradient(to top, #000000 10%, transparent 90%), url(${backdropUrl})`,\r\n                    position: 'absolute',\r\n                    top: 0,\r\n                    left: 0,\r\n                    width: '100%',\r\n                    height: '60vh',\r\n                    backgroundSize: 'cover',\r\n                    backgroundPosition: 'center',\r\n                    zIndex: -1,\r\n                    opacity: 0.3\r\n                }}\r\n            />\r\n\r\n            <div className=\"details-content\" style={{ marginTop: '5vh', width: '100%', maxWidth: '1000px', margin: '5vh auto 0', padding: '0 1rem', display: 'flex', flexDirection: 'column', alignItems: 'center', color: '#fff', position: 'relative', zIndex: 1 }}>\r\n\r\n                {/* VISUAL TITLE CARD BOX (Backdrop) with Logo & Fade */}\r\n                <div style={{\r\n                    width: '100%',\r\n                    maxWidth: '1000px', // Increased width (though 100% might be too wide, sticking to large container width)\r\n                    aspectRatio: '16/9',\r\n                    marginBottom: '-4rem', // Overlap effect\r\n                    position: 'relative',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    background: '#000', // Pure Black\r\n                    borderRadius: '0px',\r\n                    overflow: 'hidden'\r\n                }}>\r\n\r\n                    {/* LOGO OVERLAY (Only Logo, No Backdrop) */}\r\n                    <div style={{ zIndex: 2, display: 'flex', justifyContent: 'center', alignItems: 'center', width: '100%', height: '100%' }}>\r\n                        {logoFilePath ? (\r\n                            <img\r\n                                src={`https://image.tmdb.org/t/p/original${logoFilePath}`}\r\n                                alt=\"Series Logo\"\r\n                                style={{ width: '70%', maxHeight: '70%', objectFit: 'contain', filter: 'drop-shadow(0 0 20px rgba(255,255,255,0.1))' }}\r\n                            />\r\n                        ) : (\r\n                            // Fallback if no logo\r\n                            <h2 style={{ fontSize: '4rem', fontFamily: 'Impact, sans-serif', textTransform: 'uppercase', color: '#333', textAlign: 'center', padding: '0 20px' }}>\r\n                                {title}\r\n                            </h2>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* POSTER (Refined: Card Style) */}\r\n                <div className=\"poster-wrapper\" style={{ flexShrink: 0, zIndex: 3, marginBottom: '2rem' }}>\r\n                    <div\r\n                        onClick={handlePosterClick}\r\n                        style={{ position: 'relative', filter: 'none', display: 'flex', flexDirection: 'column', alignItems: 'center', cursor: 'pointer' }}\r\n                    >\r\n                        {/* Watchlist Button Overlay */}\r\n\r\n\r\n                        {/* Star Badge if Earned (Prioritize Star Badge over just Review, or show Star Badge if user has it) */}\r\n\r\n\r\n                        {/* Animated Heart */}\r\n                        <div style={{\r\n                            position: 'absolute',\r\n                            top: '50%',\r\n                            left: '50%',\r\n                            transform: 'translate(-50%, -50%)',\r\n                            zIndex: 10,\r\n                            pointerEvents: 'none' // Click through\r\n                        }}>\r\n                            <MdFavorite\r\n                                ref={heartRef}\r\n                                size={120}\r\n                                color=\"#FF0000\"\r\n                                style={{ opacity: 0, position: 'absolute', transform: 'translate(-50%, -50%)' }}\r\n                            />\r\n                            <MdHeartBroken\r\n                                ref={brokenHeartRef}\r\n                                size={120}\r\n                                color=\"#FFFFFF\"\r\n                                style={{ opacity: 0, position: 'absolute', transform: 'translate(-50%, -50%)' }}\r\n                            />\r\n                        </div>\r\n\r\n\r\n                        {/* POSTER CONTAINER REF */}\r\n                        <div ref={posterContainerRef} style={{ position: 'relative', display: 'inline-block' }}>\r\n                            <img\r\n                                src={posterUrl}\r\n                                alt={title}\r\n                                className=\"movie-poster\"\r\n                                style={{\r\n                                    width: 'auto',\r\n                                    maxWidth: '90vw',\r\n                                    height: '55vh', // REDUCED HEIGHT (User Req: ~55-60%)\r\n                                    maxHeight: '600px',\r\n                                    objectFit: 'cover',\r\n                                    borderRadius: '12px', // ROUNDED\r\n                                    boxShadow: '0 20px 60px rgba(0,0,0,0.5)', // Subtle shadow, no drop-shadow\r\n                                    border: 'none', // NO BORDER\r\n                                }}\r\n                            />\r\n\r\n                            {/* EDIT POSTER BUTTON - Only show if season is fully watched */}\r\n                            {isWatched && (\r\n                                <>\r\n                                    <div\r\n                                        onClick={(e) => {\r\n                                            e.preventDefault();\r\n                                            e.stopPropagation();\r\n                                            handleEditClick();\r\n                                        }}\r\n                                        style={{\r\n                                            position: 'absolute',\r\n                                            top: '10px',\r\n                                            right: '10px',\r\n                                            background: isEditButtonGlowing ? '#FFD600' : 'rgba(0, 0, 0, 0.7)',\r\n                                            color: isEditButtonGlowing ? '#000' : '#fff',\r\n                                            border: isEditButtonGlowing ? '2px solid #FFD600' : '1px solid rgba(255, 255, 255, 0.3)',\r\n                                            borderRadius: '50%',\r\n                                            width: '40px',\r\n                                            height: '40px',\r\n                                            display: 'flex',\r\n                                            alignItems: 'center',\r\n                                            justifyContent: 'center',\r\n                                            cursor: 'pointer',\r\n                                            backdropFilter: 'blur(4px)',\r\n                                            transition: 'all 0.3s ease',\r\n                                            boxShadow: isEditButtonGlowing ? '0 0 20px rgba(255, 214, 0, 0.6)' : 'none',\r\n                                            zIndex: 10\r\n                                        }}\r\n                                        title=\"Edit Season Poster\"\r\n                                    >\r\n                                        <MdEdit size={20} />\r\n                                    </div>\r\n\r\n                                    {/* HINT TEXT REPLACED WITH MOBILE INDICATOR */}\r\n                                    <MobileIndicator id=\"edit-poster-tip\" message=\"Customize your vibe ðŸŽ¨\" position=\"bottom\" />\r\n\r\n                                    {/* Like Tip (On Poster) */}\r\n                                    <MobileIndicator\r\n                                        id=\"like-tip\"\r\n                                        message=\"Mark as favourite â¤ï¸\"\r\n                                        position=\"bottom\"\r\n                                        style={{ bottom: '20px' }}\r\n                                    />\r\n                                </>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* INFO ROW: Title/Watch (Left) ---- Ratings (Right) */}\r\n                <div style={{\r\n                    display: 'flex',\r\n                    justifyContent: 'space-between',\r\n                    alignItems: 'flex-start',\r\n                    width: '100%',\r\n                    maxWidth: '1000px', // Match top box width\r\n                    marginBottom: '2rem',\r\n                    flexWrap: 'wrap',\r\n                    gap: '30px'\r\n                }}>\r\n\r\n                    {/* LEFT: Title & Where to Watch */}\r\n                    <div style={{ flex: 1, minWidth: '350px', textAlign: 'left' }}>\r\n                        <h1 style={{ fontSize: '4.5rem', textTransform: 'uppercase', fontWeight: '400', margin: '0 0 1rem 0', fontFamily: 'Anton, Impact, sans-serif', letterSpacing: '1px', lineHeight: '0.9' }}>\r\n                            {title}\r\n                        </h1>\r\n\r\n                        {/* Where to Watch */}\r\n                        <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap', marginTop: '15px', alignItems: 'center' }}>\r\n                            <span style={{ fontSize: '1rem', fontWeight: 'bold', color: '#888', textTransform: 'uppercase', marginRight: '10px' }}>Where to Watch:</span>\r\n                            {watchProviders?.flatrate || watchProviders?.rent || watchProviders?.buy ? (\r\n                                (watchProviders.flatrate || watchProviders.rent || watchProviders.buy || []).slice(0, 3).map(provider => (\r\n                                    <div key={provider.provider_id} title={provider.provider_name}>\r\n                                        <img\r\n                                            src={`https://image.tmdb.org/t/p/original${provider.logo_path}`}\r\n                                            alt={provider.provider_name}\r\n                                            style={{ width: '45px', height: '45px', borderRadius: '8px', border: '1px solid #444' }}\r\n                                        />\r\n                                    </div>\r\n                                ))\r\n                            ) : (\r\n                                <span style={{ fontSize: '1rem', color: '#555', alignSelf: 'center' }}>Unavailable</span>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* RIGHT: Ratings Pill -> Emoji Badge */}\r\n                    <div style={{ flexShrink: 0, alignSelf: 'center' }}>\r\n                        <div\r\n                            onClick={() => setIsReviewsOpen(true)}\r\n                            style={{\r\n                                display: 'flex', alignItems: 'center', gap: '10px',\r\n                                background: 'rgba(0,0,0,0.6)', padding: '8px 20px',\r\n                                borderRadius: '50px', border: '1px solid #333',\r\n                                cursor: 'pointer'\r\n                            }}>\r\n                            <span style={{ fontSize: '2rem', lineHeight: 1 }}>\r\n                                {seasonStats.count === 0 ? getEmoji(0) : getEmoji(parseFloat(seasonStats.avg))}\r\n                            </span>\r\n                            <span style={{ color: '#46d369', fontSize: '1.5rem', fontWeight: '900', fontFamily: 'Inter, sans-serif' }}>\r\n                                {seasonStats.avg}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n\r\n                </div>\r\n\r\n                {/* Action Bar (Redesigned) */}\r\n                <div className=\"action-bar\" style={{\r\n                    display: 'flex',\r\n                    gap: '0',\r\n                    borderTop: '2px solid #555',\r\n                    borderBottom: '2px solid #555',\r\n                    padding: '20px 0', // Increased padding\r\n                    width: '100%',\r\n                    justifyContent: 'center',\r\n                    flexWrap: 'wrap',\r\n                    background: '#000',\r\n                    marginBottom: '3rem'\r\n                }}>\r\n                    <div style={{ display: 'flex', gap: '20px', justifyContent: 'center', flexWrap: 'nowrap', overflowX: 'auto' }}>\r\n                        {/* REVIEW */}\r\n                        <button\r\n                            className=\"action-btn-responsive\"\r\n                            onClick={() => {\r\n                                // Fix: Use selectedSeason (state) instead of seasonNumber (URL param)\r\n                                // selectedSeason is always set when viewing a season\r\n                                if (selectedSeason && selectedSeason > 0) {\r\n                                    setExistingReviewData(userSeasonReview || null);\r\n                                    setReviewingItem({\r\n                                        type: 'season',\r\n                                        id: details.id,\r\n                                        name: details.name,\r\n                                        seasonNumber: Number(selectedSeason)\r\n                                    });\r\n                                } else {\r\n                                    setExistingReviewData(userSeriesReview || null);\r\n                                    setReviewingItem({ type: 'series', id: details.id, name: details.name });\r\n                                }\r\n                                setIsReviewOpen(true);\r\n                            }}\r\n                            style={{\r\n                                background: (selectedSeason > 0 ? userSeasonReview : userSeriesReview) ? '#fff' : '#FFCC00',\r\n                                color: '#000',\r\n                                border: `2px solid ${(selectedSeason > 0 ? userSeasonReview : userSeriesReview) ? '#fff' : '#FFCC00'}`,\r\n                                padding: '12px 30px',\r\n                                fontSize: '1.1rem',\r\n                                fontWeight: '900',\r\n                                cursor: 'pointer',\r\n                                textTransform: 'uppercase',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '10px',\r\n                                borderRadius: '0px',\r\n                                outline: 'none',\r\n                                position: 'relative',\r\n                                overflow: 'hidden',\r\n                                zIndex: 1,\r\n                                transition: 'all 0.3s ease'\r\n                            }}\r\n                        >\r\n                            <MdRateReview size={20} /> {(selectedSeason > 0 ? userSeasonReview : userSeriesReview) ? `Rated (${(selectedSeason > 0 ? userSeasonReview : userSeriesReview).rating})` : 'Review'}\r\n                            <MobileIndicator id=\"review-tip\" message=\"Rate the season â­\" position=\"top\" />\r\n                        </button>\r\n\r\n\r\n                        {/* Star Badge Popup */}\r\n\r\n\r\n                        {/* SHARE (Only if Reviewed) */}\r\n                        {(selectedSeason > 0 ? userSeasonReview : userSeriesReview) && (\r\n                            <button\r\n                                className=\"action-btn-responsive\"\r\n                                onClick={() => handleAction(async () => {\r\n                                    handleShare((selectedSeason > 0 ? userSeasonReview : userSeriesReview), false, selectedSeason > 0);\r\n                                })}\r\n                                style={{\r\n                                    background: '#FFCC00',\r\n                                    color: '#000',\r\n                                    border: '2px solid #FFCC00',\r\n                                    padding: '12px 30px',\r\n                                    fontSize: '1.1rem',\r\n                                    fontWeight: '900',\r\n                                    cursor: 'pointer',\r\n                                    textTransform: 'uppercase',\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    gap: '10px',\r\n                                    borderRadius: '0px',\r\n                                    outline: 'none',\r\n                                    position: 'relative',\r\n                                    overflow: 'hidden',\r\n                                    zIndex: 1,\r\n                                    transition: 'all 0.3s ease'\r\n                                }}\r\n                            >\r\n                                <MdIosShare size={20} /> SHARE\r\n                                <MobileIndicator id=\"share-tip\" message=\"Share your taste ðŸ“¤\" position=\"top\" />\r\n                            </button>\r\n                        )}\r\n\r\n\r\n\r\n                        {/* SEASON REVIEW REMOVED */}\r\n\r\n                        {/* WATCHED */}\r\n                        <button\r\n                            className=\"action-btn-responsive\"\r\n                            onClick={() => handleAction(async () => {\r\n                                if (!(await checkAuth())) return;\r\n                                toggleSeasonWatched();\r\n                            })}\r\n                            style={{\r\n                                background: isWatched ? '#fff' : '#FFCC00',\r\n                                color: '#000',\r\n                                border: `2px solid ${isWatched ? '#fff' : '#FFCC00'}`,\r\n                                padding: '12px 30px',\r\n                                fontSize: '1.1rem',\r\n                                fontWeight: '900',\r\n                                cursor: 'pointer',\r\n                                textTransform: 'uppercase',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '10px',\r\n                                borderRadius: '0px',\r\n                                outline: 'none',\r\n                                position: 'relative',\r\n                                overflow: 'hidden',\r\n                                zIndex: 1,\r\n                                transition: 'all 0.3s ease'\r\n                            }}\r\n                        >\r\n\r\n                            {isWatched ? <MdVisibility size={20} /> : <MdVisibilityOff size={20} />} WATCHED\r\n                            <MobileIndicator id=\"watched-tip\" message=\"Finished watching? âœ”ï¸\" position=\"top\" />\r\n                        </button>\r\n\r\n                        <button\r\n                            className=\"action-btn-responsive\"\r\n                            onClick={() => handleAction(async () => {\r\n                                if (!(await checkAuth())) return;\r\n                                toggleWatchlist();\r\n                            })}\r\n                            style={{\r\n                                background: inWatchlist ? '#fff' : '#FFCC00',\r\n                                color: '#000',\r\n                                border: `2px solid ${inWatchlist ? '#fff' : '#FFCC00'}`,\r\n                                padding: '12px 30px',\r\n                                fontSize: '1.1rem',\r\n                                fontWeight: '900',\r\n                                cursor: 'pointer',\r\n                                textTransform: 'uppercase',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '10px',\r\n                                borderRadius: '0px',\r\n                                outline: 'none',\r\n                                position: 'relative',\r\n                                overflow: 'hidden',\r\n                                zIndex: 1,\r\n                                transition: 'all 0.3s ease'\r\n                            }}\r\n                        >\r\n\r\n                            {inWatchlist ? <MdCheck size={20} /> : <MdAdd size={20} />} WATCHLIST\r\n                            <MobileIndicator id=\"watchlist-tip\" message=\"Save for later â³\" position=\"top\" />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Overview (Redesigned) */}\r\n                <div className=\"overview\" style={{ textAlign: 'center', maxWidth: '800px', margin: '0 auto 2rem' }}>\r\n                    <h3 style={{ borderBottom: '1px solid #333', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#FFCC00' }}>\r\n                        {seasonDetails && seasonDetails.name ? seasonDetails.name : 'Overview'}\r\n                    </h3>\r\n                    <p style={{ lineHeight: '1.6', fontSize: '1.1rem', color: '#ddd' }}>\r\n                        {seasonDetails?.overview || details.overview || \"No overview available.\"}\r\n                    </p>\r\n                </div>\r\n\r\n\r\n            </div >\r\n\r\n            {/* Episodes List - Full Width below? Or Sidebar? User image showed list. Let's put it full width below content OR in the main column. \r\n                    Actually, let's put it in a separate container below the top section.\r\n                */}\r\n\r\n            < div className=\"episodes-wrapper\" style={{ width: '100%', maxWidth: '1000px', margin: '0 auto' }}>\r\n\r\n\r\n\r\n                {/* Episodes List - Integrated in Info Column */}\r\n                < div style={{ marginTop: '2rem', marginBottom: '2rem' }}>\r\n                    <h3 style={{ color: '#FFCC00', borderBottom: '1px solid #333', paddingBottom: '0.5rem', marginBottom: '1.5rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                        Episodes\r\n                        {seasonsValues.length > 0 && (\r\n                            <div style={{ display: 'flex', gap: '20px', alignItems: 'center', marginRight: '10px' }}>\r\n\r\n                                {/* Season Rating - IMDb Style Badge REMOVED */}\r\n                                {/*\r\n                                        (seasonDetails?.vote_average > 0 || getCurrentSeasonRating() > 0) && (\r\n                                            <div style={{ display: 'flex', alignItems: 'center', background: '#000', border: '1px solid #F5C518', borderRadius: '4px', padding: '4px 8px', marginRight: '15px' }}>\r\n                                                <span style={{ background: '#F5C518', color: 'black', fontWeight: '900', padding: '2px 4px', borderRadius: '2px', marginRight: '6px', fontSize: '0.8rem' }}>IMDb</span>\r\n                                                <span style={{ color: 'white', fontWeight: 'bold', fontSize: '1rem' }}>\r\n                                                    {(seasonDetails?.vote_average || getCurrentSeasonRating()).toFixed(1)}/10\r\n                                                </span>\r\n                                            </div>\r\n                                        )\r\n                                    */}\r\n\r\n                                <div style={{ position: 'relative' }}>\r\n                                    <button\r\n                                        onClick={() => setIsSeasonOpen(!isSeasonOpen)}\r\n                                        style={{\r\n                                            background: '#333', // Grey button bg\r\n                                            color: 'white', // White text\r\n                                            border: 'none',\r\n                                            padding: '8px 20px',\r\n                                            borderRadius: '4px',\r\n                                            fontSize: '1rem',\r\n                                            cursor: 'pointer',\r\n                                            outline: 'none',\r\n                                            fontWeight: 'bold', // \"Amazon Prime Bold\"\r\n                                            textTransform: 'uppercase',\r\n                                            display: 'flex',\r\n                                            alignItems: 'center',\r\n                                            gap: '12px',\r\n                                            width: 'auto', // Auto width\r\n                                            minWidth: '150px', // Increased width\r\n                                            height: '40px',\r\n                                            justifyContent: 'space-between',\r\n                                            whiteSpace: 'nowrap' // No Newline\r\n                                        }}\r\n                                    >\r\n                                        {getSeasonName(selectedSeason)}\r\n                                        <MdKeyboardArrowDown\r\n                                            size={24}\r\n                                            style={{\r\n                                                transform: isSeasonOpen ? 'rotate(180deg)' : 'rotate(0deg)',\r\n                                                transition: 'transform 0.3s ease'\r\n                                            }}\r\n                                        />\r\n                                    </button>\r\n\r\n\r\n\r\n                                    {/* Dropdown / Overlay */}\r\n                                    <div\r\n                                        style={{\r\n                                            position: 'absolute',\r\n                                            top: 'calc(100% + 5px)', // Tighter spacing\r\n                                            left: 0,\r\n                                            width: '100%', // Match button width\r\n                                            minWidth: '150px',\r\n                                            background: '#000', // Pure Black\r\n                                            border: '1px solid #333',\r\n                                            borderRadius: '4px', // Slight rounding\r\n                                            boxShadow: '0 10px 40px rgba(0,0,0,0.8)',\r\n                                            zIndex: 100,\r\n                                            opacity: isSeasonOpen ? 1 : 0,\r\n                                            transform: isSeasonOpen ? 'translateY(0)' : 'translateY(-10px)',\r\n                                            pointerEvents: isSeasonOpen ? 'auto' : 'none',\r\n                                            transition: 'all 0.2s ease-out',\r\n                                            overflow: 'hidden',\r\n                                            maxHeight: '300px',\r\n                                            overflowY: 'auto'\r\n                                        }}\r\n                                    >\r\n                                        {seasonsValues.map(s => (\r\n                                            <div\r\n                                                key={s.id}\r\n                                                onClick={() => {\r\n                                                    handleSeasonChange({ target: { value: s.season_number } });\r\n                                                    setIsSeasonOpen(false);\r\n                                                }}\r\n                                                className=\"season-item\"\r\n                                                style={{\r\n                                                    padding: '10px 20px',\r\n                                                    color: 'white',\r\n                                                    cursor: 'pointer',\r\n                                                    borderBottom: '1px solid #222',\r\n                                                    background: selectedSeason === s.season_number ? '#333' : 'transparent', // Grey for selected\r\n                                                    fontWeight: 'bold', // Bold Text\r\n                                                    textTransform: 'uppercase', // Full Capital\r\n                                                    transition: 'background 0.2s',\r\n                                                    whiteSpace: 'nowrap',\r\n                                                    fontSize: '0.9rem'\r\n                                                }}\r\n                                                onMouseEnter={(e) => {\r\n                                                    if (selectedSeason !== s.season_number) e.currentTarget.style.background = '#1a1a1a';\r\n                                                }}\r\n                                                onMouseLeave={(e) => {\r\n                                                    if (selectedSeason !== s.season_number) e.currentTarget.style.background = 'transparent';\r\n                                                }}\r\n                                            >\r\n                                                {s.name || `SEASON ${s.season_number}`}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </h3>\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>\r\n                        {/* Season Action Buttons */}\r\n\r\n                        {episodes.map((ep, index) => {\r\n                            const epReviews = reviewsData.filter(r => r.tmdbId === parseInt(id) && r.seasonNumber === selectedSeason && r.episodeNumber === ep.episode_number && r.isEpisode);\r\n                            const epCount = epReviews.length;\r\n                            const epAvg = epCount > 0\r\n                                ? (epReviews.reduce((acc, r) => acc + (parseFloat(r.rating) || 0), 0) / epCount).toFixed(1)\r\n                                : \"0.0\";\r\n\r\n                            // User Rating (if any)\r\n                            // Fix: Use correct lookup arguments\r\n                            const userReview = getExistingReview(details.id, true, false, ep.season_number, ep.episode_number);\r\n\r\n                            return (\r\n                                <div\r\n                                    key={ep.id}\r\n                                    onClick={() => navigate(`/tv/${id}/season/${selectedSeason}/episode/${ep.episode_number}`)}\r\n                                    style={{\r\n                                        display: 'flex',\r\n                                        flexDirection: 'column',\r\n                                        gap: '10px',\r\n                                        padding: '20px 0',\r\n                                        borderBottom: '1px solid #333',\r\n                                        cursor: 'pointer',\r\n                                        transition: 'background 0.2s',\r\n                                    }}\r\n                                    onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.05)'}\r\n                                    onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}\r\n                                >\r\n                                    <div style={{ display: 'flex', gap: '25px', alignItems: 'flex-start', flexWrap: 'wrap' }}>\r\n                                        {/* Poster Section with Centered Buttons */}\r\n                                        <div className=\"responsive-episode-img\" style={{ width: '178px', minWidth: '178px', position: 'relative', flexShrink: 0 }}>\r\n                                            {ep.still_path ? (\r\n                                                <img\r\n                                                    src={`https://image.tmdb.org/t/p/w300${ep.still_path}`}\r\n                                                    alt={ep.name}\r\n                                                    style={{ width: '100%', borderRadius: '4px', height: '100px', objectFit: 'cover' }}\r\n                                                />\r\n                                            ) : (\r\n                                                <div style={{ width: '100%', height: '100px', borderRadius: '4px', border: '1px solid #333', background: '#111', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\r\n                                                </div>\r\n                                            )}\r\n                                            <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', display: 'flex', gap: '8px', zIndex: 5 }}>\r\n                                                <button\r\n                                                    onClick={async (e) => {\r\n                                                        e.stopPropagation();\r\n                                                        if (!(await checkAuth())) return;\r\n                                                        toggleEpisodeWatchlist(ep);\r\n                                                    }}\r\n                                                    style={{\r\n                                                        background: 'rgba(0,0,0,0.7)',\r\n                                                        color: checkEpisodeInWatchlist(ep.id) ? '#FFCC00' : 'white',\r\n                                                        border: '1px solid rgba(255,255,255,0.2)',\r\n                                                        padding: '0',\r\n                                                        cursor: 'pointer',\r\n                                                        borderRadius: '50%',\r\n                                                        display: 'flex',\r\n                                                        alignItems: 'center',\r\n                                                        justifyContent: 'center',\r\n                                                        width: '36px',\r\n                                                        height: '36px',\r\n                                                        transition: 'all 0.2s'\r\n                                                    }}\r\n                                                    title={checkEpisodeInWatchlist(ep.id) ? \"Remove from Watchlist\" : \"Add to Watchlist\"}\r\n                                                >\r\n                                                    {checkEpisodeInWatchlist(ep.id) ? <MdRemove size={18} /> : <MdAdd size={18} />}\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={async (e) => {\r\n                                                        e.stopPropagation();\r\n                                                        if (!(await checkAuth())) return;\r\n                                                        toggleEpisodeWatched(ep);\r\n                                                    }}\r\n                                                    style={{\r\n                                                        background: 'rgba(0,0,0,0.7)',\r\n                                                        // Fix: checkEpisodeWatched now looks up via find(id) internally or we update signature?\r\n                                                        // I updated checkEpisodeWatched above to find by ID.\r\n                                                        color: checkEpisodeWatched(ep.id) ? '#00e054' : 'white',\r\n                                                        border: '1px solid rgba(255,255,255,0.2)',\r\n                                                        padding: '0',\r\n                                                        cursor: 'pointer',\r\n                                                        borderRadius: '50%',\r\n                                                        display: 'flex',\r\n                                                        alignItems: 'center',\r\n                                                        justifyContent: 'center',\r\n                                                        width: '36px',\r\n                                                        height: '36px',\r\n                                                        transition: 'all 0.2s',\r\n                                                        position: 'relative'\r\n                                                    }}\r\n                                                    title={checkEpisodeWatched(ep.id) ? \"Mark as Unwatched\" : \"Mark as Watched\"}\r\n                                                >\r\n                                                    {checkEpisodeWatched(ep.id) ? <MdVisibility size={18} /> : <MdVisibilityOff size={18} />}\r\n                                                    {index === 0 && (\r\n                                                        <MobileIndicator id=\"ep-watched-tip\" message=\"Tap to mark watched ðŸ‘€\" position=\"top\" />\r\n                                                    )}\r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* Content Column: Info, Overview, Actions */}\r\n                                        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '8px', minWidth: '200px' }}>\r\n                                            {/* Header Info */}\r\n                                            <div>\r\n                                                <h4 style={{ margin: 0, fontSize: '1.4rem', color: '#fff', fontWeight: 'bold' }}>\r\n                                                    {ep.episode_number}. {ep.name}\r\n                                                </h4>\r\n                                                <div style={{ color: '#999', fontSize: '0.95rem', marginTop: '4px', fontWeight: '500' }}>\r\n                                                    {ep.runtime ? `${Math.floor(ep.runtime / 60)}h ${ep.runtime % 60}m` : ''}\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {/* Overview */}\r\n                                            <p style={{ color: '#ccc', fontSize: '1.1rem', lineHeight: '1.5', margin: '0', display: '-webkit-box', WebkitLineClamp: 3, WebkitBoxOrient: 'vertical', overflow: 'hidden' }}>\r\n                                                {ep.overview || \"No overview available.\"}\r\n                                            </p>\r\n\r\n                                            {/* Bottom Actions Row */}\r\n                                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px', marginTop: '5px', flexWrap: 'wrap' }}>\r\n\r\n                                                {/* Episode Rating Badge */}\r\n                                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', background: '#000', padding: '4px 10px', borderRadius: '4px', border: '1px solid #333' }}>\r\n                                                    <span style={{ fontSize: '1.2rem', lineHeight: 1 }}>{getEmoji(parseFloat(epAvg))}</span>\r\n                                                    <span style={{ color: '#46d369', fontWeight: 'bold', fontSize: '1rem' }}>{epAvg}</span>\r\n                                                </div>\r\n\r\n                                                {/* Review Button */}\r\n                                                <button\r\n                                                    onClick={(e) => {\r\n                                                        e.stopPropagation();\r\n                                                        openEpisodeReview(ep);\r\n                                                    }}\r\n                                                    className=\"btn-secondary episode-review-btn-mobile\"\r\n                                                    style={{\r\n                                                        background: 'transparent',\r\n                                                        color: '#46d369',\r\n                                                        border: 'none',\r\n                                                        padding: '0',\r\n                                                        cursor: 'pointer',\r\n                                                        fontSize: '0.9rem',\r\n                                                        display: 'flex',\r\n                                                        alignItems: 'center',\r\n                                                        gap: '6px',\r\n                                                        fontWeight: 'bold',\r\n                                                        textTransform: 'uppercase'\r\n                                                    }}\r\n                                                >\r\n                                                    <MdRateReview size={16} /> {userReview ? `Rated (${userReview.rating})` : 'Review'}\r\n                                                </button>\r\n\r\n                                                {userReview && (\r\n                                                    <button\r\n                                                        onClick={(e) => {\r\n                                                            e.stopPropagation();\r\n                                                            handleShare(userReview, true);\r\n                                                        }}\r\n                                                        style={{\r\n                                                            background: 'transparent',\r\n                                                            color: 'white',\r\n                                                            border: 'none',\r\n                                                            padding: '0',\r\n                                                            cursor: 'pointer',\r\n                                                            display: 'flex',\r\n                                                            alignItems: 'center',\r\n                                                            fontSize: '0.85rem',\r\n                                                            gap: '6px',\r\n                                                            fontWeight: 'bold',\r\n                                                            textTransform: 'uppercase'\r\n                                                        }}\r\n                                                    >\r\n                                                        <MdIosShare size={16} /> Share\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div >\r\n            </div >\r\n\r\n            {/* CAST & CREW */}\r\n            < div style={{ marginTop: '2rem' }}>\r\n                <h3 style={{ borderBottom: '1px solid #333', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#FFCC00' }}>Cast & Crew</h3>\r\n                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '15px', marginBottom: '1rem' }}>\r\n                    {cast.map(actor => (\r\n                        <div key={actor.id} onClick={() => navigate(`/person/${actor.id}`)} style={{ textAlign: 'center', width: '80px', cursor: 'pointer' }}>\r\n                            <img\r\n                                src={actor.profile_path ? `https://image.tmdb.org/t/p/w200${actor.profile_path}` : 'https://via.placeholder.com/200x300/141414/FFFF00?text=?'}\r\n                                alt={actor.name}\r\n                                style={{ width: '100%', borderRadius: '0', border: '1px solid #333', height: '100px', objectFit: 'cover' }}\r\n                            />\r\n                            <div style={{ fontSize: '0.8rem', marginTop: '5px', color: '#ccc' }}>{actor.name}</div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n                {\r\n                    crew.length > 0 && (\r\n                        <div style={{ fontSize: '0.9rem', color: '#bbb' }}>\r\n                            <strong>Created by:</strong> {crew.map(c => c.name).join(', ')}\r\n                        </div>\r\n                    )\r\n                }\r\n            </div >\r\n\r\n            {/* RELATED SERIES */}\r\n            {details.recommendations?.results?.length > 0 && (() => {\r\n                // Logic: Prioritize Shared Genres & Popularity\r\n                const related = details.recommendations.results\r\n                    .filter(rec => {\r\n                        if (!rec.poster_path) return false;\r\n                        if (!details.genres) return true; // Keep if we have no genre info to compare\r\n                        const myGenres = details.genres.map(g => g.id);\r\n                        return rec.genre_ids?.some(id => myGenres.includes(id));\r\n                    })\r\n                    .slice(0, 10); // Limit to top 10 relevant\r\n\r\n                if (related.length === 0) return null;\r\n\r\n                return (\r\n                    <div style={{ marginTop: '3rem', marginBottom: '2rem' }}>\r\n                        <h3 style={{ borderBottom: '1px solid #333', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#FFCC00' }}>Related Series</h3>\r\n                        <div style={{ display: 'flex', overflowX: 'auto', gap: '15px', paddingBottom: '10px' }} className=\"hide-scrollbar\">\r\n                            {related.map(series => (\r\n                                <div\r\n                                    key={series.id}\r\n                                    onClick={() => {\r\n                                        navigate(`/tv/${series.id}`);\r\n                                        window.scrollTo(0, 0);\r\n                                    }}\r\n                                    style={{ flex: '0 0 auto', width: '140px', cursor: 'pointer' }}\r\n                                >\r\n                                    <img\r\n                                        src={getResolvedPosterUrl(series.id, series.poster_path, globalPosters, 'w300')}\r\n                                        alt={series.name}\r\n                                        style={{ width: '100%', borderRadius: '6px', height: '210px', objectFit: 'cover', transition: 'transform 0.2s' }}\r\n                                        onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}\r\n                                        onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}\r\n                                    />\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                );\r\n            })()}\r\n\r\n\r\n\r\n\r\n            {/* --- NEW STORY STICKER MODAL --- */}\r\n            {stickerModalOpen && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',\r\n                    background: 'rgba(0,0,0,0.95)', zIndex: 10000,\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                    flexDirection: 'column'\r\n                }}>\r\n\r\n\r\n                    {stickerStatus === 'preparing' && <LoadingPopup />}\r\n\r\n\r\n                    {stickerStatus === 'ready' && generatedStickerImage && (\r\n                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', width: '100%', height: '100%' }}>\r\n                            {/* Preview Image (Scaled Down for Viewport) */}\r\n                            <div style={{\r\n                                flex: 1,\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                justifyContent: 'center',\r\n                                padding: '20px',\r\n                                width: '100%',\r\n                                maxWidth: '400px' // Limit width to simulate phone screen\r\n                            }}>\r\n                                <img\r\n                                    src={generatedStickerImage}\r\n                                    alt=\"Sticker Preview\"\r\n                                    style={{\r\n                                        width: '100%',\r\n                                        height: 'auto',\r\n                                        borderRadius: '16px',\r\n                                        boxShadow: '0 0 40px rgba(0,0,0,0.5)',\r\n                                        border: '1px solid #333'\r\n                                    }}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* Actions */}\r\n                            <div style={{\r\n                                padding: '30px',\r\n                                display: 'flex',\r\n                                gap: '20px',\r\n                                width: '100%',\r\n                                justifyContent: 'center',\r\n                                background: '#000',\r\n                                borderTop: '1px solid #222'\r\n                            }}>\r\n                                <button\r\n                                    onClick={closeStickerModal}\r\n                                    style={{\r\n                                        background: '#333', color: 'white',\r\n                                        padding: '16px 32px', borderRadius: '50px',\r\n                                        fontSize: '16px', fontWeight: 'bold', border: 'none'\r\n                                    }}\r\n                                >\r\n                                    Close\r\n                                </button>\r\n                                <button\r\n                                    onClick={handleShareSticker}\r\n                                    style={{\r\n                                        background: '#FFD600', color: 'black',\r\n                                        padding: '16px 32px', borderRadius: '50px',\r\n                                        fontSize: '16px', fontWeight: 'bold', border: 'none',\r\n                                        display: 'flex', alignItems: 'center', gap: '10px'\r\n                                    }}\r\n                                >\r\n                                    <MdIosShare size={20} />\r\n                                    Share\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Hidden Render Target (Using opacity 0 to ensure images load, visibility:hidden can block loading) */}\r\n                    <div style={{ position: 'absolute', top: 0, left: 0, opacity: 0, pointerEvents: 'none', zIndex: -1000, width: '1080px', height: '1920px', overflow: 'hidden' }}>\r\n                        {stickerData && (\r\n                            <StorySticker\r\n                                ref={stickerRef}\r\n                                movie={stickerData.movie}\r\n                                rating={stickerData.rating}\r\n                                user={stickerData.user}\r\n                                isEpisodes={stickerData.isEpisodes}\r\n                                globalPosters={globalPosters} // Reactive sync\r\n                            />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <ReviewModal\r\n                isOpen={isReviewOpen}\r\n                onClose={() => setIsReviewOpen(false)}\r\n                onSubmit={handleReviewSubmit}\r\n                initialRating={existingReviewData ? existingReviewData.rating : 5}\r\n                initialReview={existingReviewData ? existingReviewData.review : ''}\r\n                movieName={reviewingItem === 'series' ? title : (reviewingItem ? `${title}: Season ${selectedSeason} Episode ${reviewingItem.episode_number}` : title)}\r\n                modalTitle={reviewingItem !== 'series' && reviewingItem ? 'EPISODE REVIEW' : 'SERIES REVIEW'}\r\n            />\r\n\r\n            <ReviewsDrawer\r\n                isOpen={isReviewsOpen}\r\n                onClose={() => setIsReviewsOpen(false)}\r\n                reviews={[...reviewsData]\r\n                    .filter(r => {\r\n                        const isSeriesLevel = !r.isSeason && !r.isEpisode;\r\n                        const isCurrentSeason = r.isSeason && r.seasonNumber === selectedSeason;\r\n                        const isEpisodeInSeason = r.isEpisode && r.seasonNumber === selectedSeason;\r\n                        return isSeriesLevel || isCurrentSeason || isEpisodeInSeason;\r\n                    })\r\n                    .sort((a, b) => {\r\n                        const amIAuthor = a.userId === currentUser?.uid;\r\n                        const bmIAuthor = b.userId === currentUser?.uid;\r\n                        if (amIAuthor && !bmIAuthor) return -1;\r\n                        if (!amIAuthor && bmIAuthor) return 1;\r\n                        const aLikes = a.likes?.length || 0;\r\n                        const bLikes = b.likes?.length || 0;\r\n                        return bLikes - aLikes;\r\n                    })\r\n                    .map(r => ({\r\n                        id: r.id,\r\n                        source: 'app',\r\n                        author: r.userName || 'User',\r\n                        rating: r.rating,\r\n                        review: r.review,\r\n                        date: r.createdAt,\r\n                        likes: r.likes || [],\r\n                        isLiked: r.likes?.includes(currentUser?.uid),\r\n                        userId: r.userId,\r\n                        photoURL: r.photoURL || null,\r\n                        episodeNumber: r.episodeNumber,\r\n                        isEpisode: r.isEpisode,\r\n                        isSeason: r.isSeason,\r\n                        seasonNumber: r.seasonNumber,\r\n                        tmdbId: r.tmdbId,\r\n                        episodeId: r.episodeId,\r\n                        topicName: r.topicName || details.name\r\n                    }))}\r\n                onDelete={async (id) => {\r\n                    if (!currentUser) return;\r\n                    try {\r\n                        const reviewToDelete = reviewsData.find(r => r.id === id);\r\n                        if (!reviewToDelete) return;\r\n                        await deleteDoc(doc(db, 'reviews', id));\r\n                        if (!reviewToDelete.isEpisode) {\r\n                            const userRef = doc(db, 'users', currentUser.uid);\r\n                            const userSnap = await getDoc(userRef);\r\n                            if (userSnap.exists()) {\r\n                                const data = userSnap.data();\r\n                                const updatedStars = (data.starSeries || []).filter(s => String(s.id) !== String(details.id));\r\n                                await updateDoc(userRef, { starSeries: updatedStars });\r\n                            }\r\n                        }\r\n                        setReviewsData(prev => prev.filter(r => r.id !== id));\r\n                    } catch (error) {\r\n                        console.error(\"Error deleting review:\", error);\r\n                    }\r\n                }}\r\n                onShare={handleShare}\r\n                onLike={handleReviewLike}\r\n                onEdit={handleEditReview}\r\n                theme={{}}\r\n            />\r\n\r\n            {/* Hidden Share Modal for Fallback (if kept) - but we use Sticker Modal now. Keeping for safety if other logic calls it, but likely redundant. */}\r\n            <ShareModal\r\n                isOpen={shareModal.isOpen}\r\n                onClose={() => setShareModal({ ...shareModal, isOpen: false })}\r\n                imageUrl={shareModal.imageUrl}\r\n            />\r\n\r\n            {/* SEASON COMPLETION OVERLAY */}\r\n            {/* SEASON COMPLETION OVERLAY (Pure Black Premium Design) */}\r\n            {showSeasonCompletion && (\r\n                <div\r\n                    className=\"popup-overlay\"\r\n                    onClick={handleSeasonCompletionClose}\r\n                    style={{\r\n                        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n                        zIndex: 10000,\r\n                        background: 'rgba(0,0,0,0.8)',\r\n                        backdropFilter: 'blur(10px)',\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                        animation: 'fadeIn 0.3s ease'\r\n                    }}\r\n                >\r\n                    <div\r\n                        onClick={(e) => e.stopPropagation()}\r\n                        style={{\r\n                            background: '#000000',\r\n                            border: '1px solid #333',\r\n                            borderRadius: '16px',\r\n                            padding: '40px 30px',\r\n                            width: '85%',\r\n                            maxWidth: '320px',\r\n                            textAlign: 'center',\r\n                            boxShadow: '0 20px 60px rgba(0,0,0,0.9)',\r\n                            animation: 'scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'\r\n                        }}\r\n                    >\r\n                        <MdCelebration style={{ fontSize: '3rem', marginBottom: '15px', color: '#FFD600' }} />\r\n                        <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fff', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '1px' }}>\r\n                            Season Completed\r\n                        </h2>\r\n                        <p style={{ fontSize: '1rem', color: '#ccc', lineHeight: '1.5', marginBottom: '25px' }}>\r\n                            You unlocked poster customization\r\n                        </p>\r\n                        <button\r\n                            onClick={handleSeasonCompletionClose}\r\n                            style={{\r\n                                background: '#fff',\r\n                                color: '#000',\r\n                                border: 'none',\r\n                                borderRadius: '8px',\r\n                                padding: '12px 0',\r\n                                fontSize: '1rem',\r\n                                fontWeight: 'bold',\r\n                                cursor: 'pointer',\r\n                                width: '100%',\r\n                                textTransform: 'uppercase',\r\n                                transition: 'transform 0.1s'\r\n                            }}\r\n                            onMouseDown={e => e.currentTarget.style.transform = 'scale(0.96)'}\r\n                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}\r\n                        >\r\n                            OK\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Daily Limit Popup */}\r\n            {limitPopupVisible && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\r\n                    zIndex: 10000,\r\n                    background: 'rgba(0,0,0,0.8)',\r\n                    backdropFilter: 'blur(8px)',\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                    animation: 'fadeIn 0.3s ease'\r\n                }}>\r\n                    <div style={{\r\n                        background: '#000000',\r\n                        border: '1px solid #333',\r\n                        borderRadius: '16px',\r\n                        padding: '30px',\r\n                        maxWidth: '90%',\r\n                        width: '320px',\r\n                        textAlign: 'center',\r\n                        boxShadow: '0 20px 50px rgba(0,0,0,0.5)'\r\n                    }}>\r\n                        <MdMovie style={{ fontSize: '3rem', marginBottom: '15px', color: '#FFD600' }} />\r\n                        <div style={{ fontSize: '1.2rem', lineHeight: '1.4', color: '#fff', marginBottom: '20px', fontWeight: 'bold' }}>\r\n                            Take it slow\r\n                        </div>\r\n                        <p style={{ color: '#aaa', fontSize: '0.95rem', marginBottom: '25px' }}>\r\n                            You can change one poster per day.\r\n                        </p>\r\n                        <button\r\n                            onClick={() => setLimitPopupVisible(false)}\r\n                            style={{\r\n                                background: '#FFD600',\r\n                                color: '#000',\r\n                                border: 'none',\r\n                                borderRadius: '8px',\r\n                                padding: '12px 30px',\r\n                                fontSize: '16px',\r\n                                fontWeight: 'bold',\r\n                                cursor: 'pointer',\r\n                                width: '100%'\r\n                            }}\r\n                        >\r\n                            OK\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Poster Unlock Popup */}\r\n            <PosterUnlockPopup\r\n                isOpen={showPosterUnlockPopup}\r\n                onClose={handlePopupClose}\r\n                seriesId={posterUnlockData?.seriesId}\r\n                seasonNumber={posterUnlockData?.seasonNumber}\r\n                seriesName={posterUnlockData?.seriesName}\r\n            />\r\n\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default MovieDetails;\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\PosterSelection.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'collection' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"collection"},"fix":{"range":[229,241],"text":""},"desc":"Remove unused variable 'collection'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"setDoc"},"fix":{"range":[241,249],"text":""},"desc":"Remove unused variable 'setDoc'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'serverTimestamp' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":61,"suggestions":[{"messageId":"removeVar","data":{"varName":"serverTimestamp"},"fix":{"range":[249,266],"text":""},"desc":"Remove unused variable 'serverTimestamp'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":27,"column":8,"nodeType":"ArrayExpression","endLine":27,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [fetchData, id]","fix":{"range":[1215,1219],"text":"[fetchData, id]"}}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { db } from '../firebase-config';\r\nimport { doc, updateDoc, collection, setDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { MdLock, MdCheck, MdArrowBack } from 'react-icons/md';\r\nimport { supabase } from '../supabase-config';\r\nimport { logActivity } from '../utils/activityLogger';\r\n\r\nconst PosterSelection = () => {\r\n    const { id, seasonNumber } = useParams(); // seasonNumber still in URL for navigation context\r\n    const navigate = useNavigate();\r\n    const { currentUser, userData } = useAuth();\r\n\r\n    const [posters, setPosters] = useState([]);\r\n    const [unlockCount, setUnlockCount] = useState(1);\r\n    const [selectedPoster, setSelectedPoster] = useState(null);\r\n    const [seriesName, setSeriesName] = useState('');\r\n    const [loading, setLoading] = useState(true);\r\n    const [saving, setSaving] = useState(false);\r\n    const [showSuccess, setShowSuccess] = useState(false); // Success Popup State\r\n\r\n    const TMDB_API_KEY = '05587a49bd4890a9630d6c0e544e0f6f';\r\n\r\n    useEffect(() => {\r\n        fetchData();\r\n    }, [id]);\r\n\r\n    const fetchData = async () => {\r\n        setLoading(true);\r\n        try {\r\n            // 1. Fetch Series Info & Images\r\n            // Fetch series details to count total seasons\r\n            const seriesRes = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}`);\r\n            const seriesData = await seriesRes.json();\r\n            setSeriesName(seriesData.name);\r\n\r\n            // Filter out Specials (Season 0) and unreleased if needed, but number_of_seasons is usually the metric.\r\n            // Prompt: \"Do NOT count unreleased seasons\". 'number_of_seasons' comes from TMDB.\r\n            // A clearer way: filter seasons array.\r\n            const releasedSeasons = (seriesData.seasons || []).filter(s => s.season_number > 0 && s.air_date && new Date(s.air_date) <= new Date());\r\n            const totalSeasons = releasedSeasons.length || seriesData.number_of_seasons || 1;\r\n\r\n            // Fetch ALL Series Posters\r\n            const imagesRes = await fetch(`https://api.themoviedb.org/3/tv/${id}/images?api_key=${TMDB_API_KEY}`);\r\n            const imagesData = await imagesRes.json();\r\n            const allPosters = imagesData.posters || [];\r\n\r\n            setPosters(allPosters);\r\n\r\n            // 2. Calculate Unlock Status\r\n            // Count watched seasons from Firestore\r\n            let watchedSeasonsCount = 0;\r\n            if (userData?.watched) {\r\n                const watchedSet = new Set();\r\n                userData.watched.forEach(w => {\r\n                    if ((w.seriesId === Number(id) || w.id === Number(id)) && w.seasonNumber > 0) {\r\n                        watchedSet.add(w.seasonNumber);\r\n                    }\r\n                });\r\n                watchedSeasonsCount = watchedSet.size;\r\n            }\r\n\r\n            const totalPosters = allPosters.length;\r\n            let unlocked = 1;\r\n\r\n            if (watchedSeasonsCount >= totalSeasons) {\r\n                unlocked = totalPosters; // Unlock ALL if all seasons watched\r\n            } else {\r\n                // Formula: floor((watchedSeasons / totalSeasons) * totalPosters)\r\n                unlocked = Math.floor((watchedSeasonsCount / totalSeasons) * totalPosters);\r\n                unlocked = Math.max(1, Math.min(unlocked, totalPosters)); // Clamp\r\n            }\r\n\r\n            setUnlockCount(unlocked);\r\n\r\n            // 3. Get Current Global Selection (From globalPosters context if available, or just fetch if needed)\r\n            // But we can listen or just read once. Since AuthContext has it, better to use that if we passed it?\r\n            // But here we might not have it in context easily if we didn't update posterResolution call in THIS file.\r\n            // Let's use userData for now as we did before, OR use the collection if we want strict consistency.\r\n            // Since AuthContext exposes globalPosters, we should probably use that.\r\n            // But let's stick to reading userData.customPosters map OR the context map.\r\n            // The prompt says \"DB STRUCTURE: One document per user+series\".\r\n            // AuthContext *reads* this connection.\r\n            // So we can assume AuthContext has the latest if it's subscribed.\r\n            // But we didn't import globalPosters here.\r\n\r\n            // NOTE: To be safe and fast, I will rely on the fact that we are writing to the collection.\r\n            // And AuthContext reads it. \r\n            // BUT for initial render here, checking local prop logic is fine.\r\n            // Wait, we need to show which one is selected.\r\n            // I'll leave the currentGlobal default logic but maybe we should use useAuth().globalPosters?\r\n            // I will update Step 1 imports to include globalPosters if I want to be cleaner.\r\n            // But let's just proceed with the save logic first.\r\n            const currentGlobal = userData?.customPosters?.[id];\r\n            setSelectedPoster(currentGlobal || null);\r\n\r\n        } catch (error) {\r\n            console.error('Error fetching poster data:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handlePosterSelect = async (posterPath) => {\r\n        if (!currentUser || saving) return;\r\n\r\n        setSaving(true);\r\n        try {\r\n            const userRef = doc(db, 'users', currentUser.uid);\r\n\r\n            // 1. SAVE TO user_posters TABLE (Supabase)\r\n            const { error: supabaseError } = await supabase\r\n                .from('user_posters')\r\n                .upsert({\r\n                    user_id: currentUser.uid,\r\n                    series_id: Number(id),\r\n                    poster_path: posterPath,\r\n                    updated_at: new Date().toISOString()\r\n                });\r\n\r\n            if (supabaseError) throw supabaseError;\r\n\r\n            // 2. UPDATE USER: lastPosterEditAt (Firestore - to enforce 24h lock)\r\n            await updateDoc(userRef, {\r\n                lastPosterEditAt: new Date().toISOString()\r\n            });\r\n\r\n            // Log Activity\r\n            logActivity(\r\n                { ...currentUser, username: userData.username, photoURL: userData.profilePhoto },\r\n                'poster_updated',\r\n                {\r\n                    seriesId: Number(id),\r\n                    seriesName: seriesName,\r\n                    posterPath: posterPath\r\n                }\r\n            );\r\n\r\n            setSelectedPoster(posterPath);\r\n            setShowSuccess(true); // Show confirmation\r\n\r\n            // Success & Redirect\r\n            setTimeout(() => {\r\n                navigate(`/tv/${id}/season/${seasonNumber}`);\r\n            }, 1500); // 1.5s as requested\r\n\r\n        } catch (error) {\r\n            console.error('Error saving global poster:', error);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    if (loading) {\r\n        return (\r\n            <div style={{ background: '#000', minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff' }}>\r\n                <div>Loading posters...</div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div style={{ background: '#000', minHeight: '100vh', padding: '20px', color: '#fff', position: 'relative' }}>\r\n            {/* SUCCESS POPUP */}\r\n            {showSuccess && (\r\n                <div style={{\r\n                    position: 'fixed',\r\n                    top: 0, left: 0, right: 0, bottom: 0,\r\n                    zIndex: 9999,\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    background: 'rgba(0,0,0,0.8)',\r\n                    backdropFilter: 'blur(5px)',\r\n                    animation: 'fadeIn 0.3s ease'\r\n                }}>\r\n                    <div style={{\r\n                        background: '#1a1a1a',\r\n                        padding: '30px 50px',\r\n                        borderRadius: '16px',\r\n                        textAlign: 'center',\r\n                        border: '1px solid #333',\r\n                        boxShadow: '0 10px 40px rgba(0,0,0,0.5)'\r\n                    }}>\r\n                        <div style={{\r\n                            width: '60px', height: '60px', borderRadius: '50%', background: '#FFD600',\r\n                            display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px auto'\r\n                        }}>\r\n                            <MdCheck size={36} color=\"#000\" />\r\n                        </div>\r\n                        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: 'bold' }}>Poster updated successfully</h2>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Header */}\r\n            <div style={{ maxWidth: '1200px', margin: '0 auto 30px auto', paddingTop: '20px' }}>\r\n                <div\r\n                    onClick={() => navigate(`/tv/${id}/season/${seasonNumber}`)}\r\n                    style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', color: '#fff', cursor: 'pointer', marginBottom: '20px' }}\r\n                >\r\n                    <MdArrowBack size={24} />\r\n                    <span style={{ fontWeight: 'bold' }}>Back to Series</span>\r\n                </div>\r\n\r\n                <h1 style={{ fontSize: '24px', fontWeight: '900', margin: '0 0 5px 0' }}>Select Global Poster</h1>\r\n                <p style={{ color: '#888', margin: 0, fontSize: '14px' }}>\r\n                    {seriesName} â€¢ {unlockCount} / {posters.length} Unlocked\r\n                </p>\r\n            </div>\r\n\r\n            {/* Poster Grid - 2 cols mobile, 4 cols desktop */}\r\n            <div className=\"poster-grid-container\">\r\n                {posters.map((poster, index) => {\r\n                    const isLocked = index >= unlockCount;\r\n                    const isSelected = selectedPoster === poster.file_path;\r\n\r\n                    return (\r\n                        <div\r\n                            key={poster.file_path}\r\n                            onClick={() => !isLocked && !saving && handlePosterSelect(poster.file_path)}\r\n                            style={{\r\n                                position: 'relative',\r\n                                aspectRatio: '2/3',\r\n                                borderRadius: '14px',\r\n                                overflow: 'hidden',\r\n                                cursor: isLocked ? 'not-allowed' : 'pointer',\r\n                                border: isSelected ? '3px solid #FFD600' : 'none',\r\n                                opacity: isLocked ? 1 : 1, // Keep opacity 1 but use overlay\r\n                                transition: 'transform 0.2s',\r\n                                background: '#111'\r\n                            }}\r\n                        >\r\n                            <img\r\n                                src={`https://image.tmdb.org/t/p/w500${poster.file_path}`}\r\n                                alt=\"\"\r\n                                loading=\"lazy\"\r\n                                style={{\r\n                                    width: '100%',\r\n                                    height: '100%',\r\n                                    objectFit: 'cover',\r\n                                    display: 'block'\r\n                                }}\r\n                            />\r\n\r\n                            {/* Lock Overlay */}\r\n                            {isLocked && (\r\n                                <div style={{\r\n                                    position: 'absolute',\r\n                                    top: 0, left: 0, right: 0, bottom: 0,\r\n                                    background: 'rgba(0,0,0,0.6)', /* Grey overlay */\r\n                                    backdropFilter: 'blur(4px)',\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    justifyContent: 'center'\r\n                                }}>\r\n                                    <MdLock color=\"#fff\" size={32} />\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Checkmark */}\r\n                            {isSelected && (\r\n                                <div style={{\r\n                                    position: 'absolute',\r\n                                    top: '10px',\r\n                                    right: '10px',\r\n                                    background: '#FFD600',\r\n                                    borderRadius: '50%',\r\n                                    padding: '6px',\r\n                                    display: 'flex',\r\n                                    boxShadow: '0 2px 8px rgba(0,0,0,0.5)'\r\n                                }}>\r\n                                    <MdCheck color=\"#000\" size={20} />\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n\r\n            <style>{`\r\n                .poster-grid-container {\r\n                    max-width: 1200px;\r\n                    margin: 0 auto;\r\n                    display: grid;\r\n                    grid-template-columns: repeat(2, 1fr); /* 2 Columns Mobile */\r\n                    gap: 15px;\r\n                }\r\n                @media (min-width: 768px) {\r\n                    .poster-grid-container {\r\n                        grid-template-columns: repeat(4, 1fr); /* 4 Columns Desktop */\r\n                    }\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default PosterSelection;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Profile.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onSnapshot' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":9,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"onSnapshot"},"fix":{"range":[577,589],"text":""},"desc":"Remove unused variable 'onSnapshot'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'diaryService' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":22,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"diaryService"},"fix":{"range":[1213,1236],"text":""},"desc":"Remove unused variable 'diaryService'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'likesService' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":23,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"likesService"},"fix":{"range":[1261,1314],"text":""},"desc":"Remove unused variable 'likesService'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":240,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":240,"endColumn":19},{"ruleId":"no-unused-vars","severity":2,"message":"'logout' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":275,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":275,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"logout"},"fix":{"range":[11579,11587],"text":""},"desc":"Remove unused variable 'logout'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'activityItems' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":296,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":296,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"activityItems"},"fix":{"range":[12589,12602],"text":""},"desc":"Remove unused variable 'activityItems'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setActivityItems' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":296,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":296,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"setActivityItems"},"fix":{"range":[12602,12620],"text":""},"desc":"Remove unused variable 'setActivityItems'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'dbRatings' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":322,"column":79,"nodeType":"Identifier","messageId":"unusedVar","endLine":322,"endColumn":88,"suggestions":[{"messageId":"removeVar","data":{"varName":"dbRatings"},"fix":{"range":[13815,13835],"text":""},"desc":"Remove unused variable 'dbRatings'."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`setIsFollowing` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  359 |                     streak: userInfo.streak?.current || 0\n  360 |                 });\n> 361 |                 setIsFollowing(followedByMe);\n      |                 ^^^^^^^^^^^^^^ `setIsFollowing` accessed before it is declared\n  362 |             }\n  363 |\n  364 |             // 2. Set SSOT Data\n\n  532 |     };\n  533 |\n> 534 |     const [isFollowing, setIsFollowing] = useState(false);\n      |                         ^^^^^^^^^^^^^^ `setIsFollowing` is declared here\n  535 |\n  536 |     // Pull to Refresh State\n  537 |     const [refreshing, setRefreshing] = useState(false);","line":361,"column":17,"nodeType":null,"endLine":361,"endColumn":31},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'globalPosters'. Either include it or remove the dependency array.","line":387,"column":8,"nodeType":"ArrayExpression","endLine":387,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [targetUid, currentUser, globalPosters]","fix":{"range":[16745,16769],"text":"[targetUid, currentUser, globalPosters]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchReviews', 'hasMoreReviews', and 'reviews.length'. Either include them or remove the dependency array.","line":497,"column":8,"nodeType":"ArrayExpression","endLine":497,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [activeTab, fetchReviews, hasMoreReviews, reviews.length, targetUid]","fix":{"range":[22392,22414],"text":"[activeTab, fetchReviews, hasMoreReviews, reviews.length, targetUid]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleResetStars' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":521,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":521,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleResetStars"},"fix":{"range":[23204,23775],"text":""},"desc":"Remove unused variable 'handleResetStars'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'formatTimeAgo' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":679,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":679,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"formatTimeAgo"},"fix":{"range":[29932,30407],"text":""},"desc":"Remove unused variable 'formatTimeAgo'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'formatTime' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":689,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":689,"endColumn":21},{"ruleId":"no-unused-vars","severity":2,"message":"'formatDateShort' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":694,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":694,"endColumn":26},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":840,"column":21,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":840,"endColumn":53,"suggestions":[{"messageId":"addBrackets","fix":{"range":[38043,41247],"text":"{ const groups = getDiaryGroups();\n                    return (\n                        <div style={{ maxWidth: '100%', paddingBottom: '20px' }}>\n                            {Object.keys(groups).length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No entries yet.</p> : Object.keys(groups).map((group, i) => (\n                                <div key={i} style={{ marginBottom: '2rem' }}>\n                                    <h3 style={{ fontSize: '1rem', fontWeight: '900', color: '#888', marginBottom: '15px', textTransform: 'uppercase', letterSpacing: '1px' }}>{group}</h3>\n                                    <div className=\"diary-grid\">\n                                        {groups[group].map((item, idx) => {\n                                            const dateObj = new Date(item.date);\n                                            const dateBadge = `${dateObj.getDate()} ${dateObj.toLocaleString('default', { month: 'short' }).toUpperCase()}`;\n                                            const cleanTitle = item.name.replace(/\\s*\\(Season \\d+\\)$/, ''); // Strip season text if present\n\n                                            return (\n                                                <div key={idx} className=\"diary-card\">\n                                                    <Link\n                                                        to={item.seasonNumber ? `/tv/${item.tmdbId}/season/${item.seasonNumber}` : `/tv/${item.tmdbId}`}\n                                                        className=\"diary-poster-container\"\n                                                    >\n                                                        <img\n                                                            src={getResolvedPosterUrl(item.tmdbId, item.seasonPoster || item.poster_path, profilePosters, 'w342') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'}\n                                                            alt={item.name}\n                                                        />\n                                                        {/* DATE BADGE ONLY */}\n                                                        <div className=\"diary-poster-date\">\n                                                            {dateBadge}\n                                                        </div>\n                                                    </Link>\n\n                                                    <div className=\"diary-info\">\n                                                        <div className=\"diary-title\">{cleanTitle}</div>\n                                                        {item.seasonNumber && (\n                                                            <div className=\"diary-season\">Season {item.seasonNumber}</div>\n                                                        )}\n                                                    </div>\n                                                </div>\n                                            );\n                                        })}\n                                    </div>\n                                </div>\n                            ))}\n                        </div >\n                    ); }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":906,"column":21,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":906,"endColumn":72,"suggestions":[{"messageId":"addBrackets","fix":{"range":[41643,45900],"text":"{ if (activeTab === 'Liked') {\n                        return (\n                            <div className=\"watchlist-grid\" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px', padding: '10px' }}>\n                                {likes.filter(i => i.type !== 'like_review').map(item => (\n                                    <div key={item.id} style={{ position: 'relative', paddingTop: starSeriesIds.has(item.tmdbId || item.id) ? '0' : '0', paddingLeft: '0' }}>\n                                        <Link to={item.seasonNumber ? `/tv/${item.tmdbId}/season/${item.seasonNumber}` : `/tv/${item.tmdbId}`} style={{ display: 'block', border: 'none', aspectRatio: '2/3', position: 'relative', overflow: 'visible' }}>\n                                            <img src={getResolvedPosterUrl(item.tmdbId, item.seasonPoster || item.poster_path, profilePosters, 'w500') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'} style={{ width: '100%', height: '100%', objectFit: 'cover', display: 'block', position: 'relative', zIndex: 1 }} />\n                                        </Link>\n                                    </div>\n                                ))}\n                            </div>\n                        );\n                    }\n\n                    // Watchlist Case\n                    const watchlistItems = processWatchlist(watchlist);\n                    return (\n                        <div className=\"watchlist-grid\" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px', padding: '10px' }}>\n                            {watchlistItems.map((item, idx) => {\n                                if (item.type === 'basket') {\n                                    return (\n                                        <div key={idx} onClick={() => setBasketModalData(item)} style={{ cursor: 'pointer', display: 'block', width: '100%', border: '1px solid var(--border-color)', aspectRatio: '2/3', position: 'relative', overflow: 'hidden' }}>\n                                            <img src={getResolvedPosterUrl(item.tmdbId, item.poster_path, profilePosters, 'w500') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'} style={{ width: '100%', height: '100%', objectFit: 'cover', display: 'block', position: 'relative', zIndex: 1 }} />\n                                            {/* Basket Badges */}\n                                            <div className=\"diary-season-badge\" style={{ top: '6px', right: '6px', fontSize: '0.8rem', padding: '4px 6px' }}>S{item.seasonNumber}</div>\n                                            <div className=\"diary-eps-badge\" style={{ bottom: '6px', right: '6px', fontSize: '0.75rem' }}>{item.episodeCount} EPS</div>\n                                        </div>\n                                    );\n                                } else {\n                                    // Whole Series\n                                    return (\n                                        <div key={idx} style={{ position: 'relative', overflow: 'visible', paddingTop: starSeriesIds.has(item.tmdbId) ? '20px' : '0', paddingLeft: starSeriesIds.has(item.tmdbId) ? '20px' : '0' }}>\n                                            <Link to={`/tv/${item.tmdbId}`} style={{ display: 'block', border: 'none', aspectRatio: '2/3', position: 'relative', overflow: 'visible' }}>\n                                                <img src={getResolvedPosterUrl(item.tmdbId, item.poster_path, profilePosters, 'w500') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'} style={{ width: '100%', height: '100%', objectFit: 'cover', display: 'block', position: 'relative', zIndex: 1 }} />\n                                                {item.seasonNumber && (\n                                                    <div className=\"diary-season-badge\" style={{ top: '6px', right: '6px', fontSize: '0.8rem', padding: '4px 6px' }}>S{item.seasonNumber}</div>\n                                                )}\n                                            </Link>\n                                        </div>\n                                    );\n                                }\n                            })}\n                        </div>\n                    ); }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":15,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react';\nimport { MdSettings, MdEdit, MdPhotoCamera, MdGridOn, MdList, MdStar, MdAdd, MdMoreVert, MdCreate, MdClose, MdCheck, MdLocalFireDepartment } from 'react-icons/md';\nimport MobileIndicator from '../components/MobileIndicator';\nimport { FaInstagram, FaTwitter } from 'react-icons/fa';\nimport { Link, useNavigate, useParams } from 'react-router-dom';\nimport { useNotification } from '../context/NotificationContext';\nimport { useAuth } from '../context/AuthContext';\nimport { db } from '../firebase-config';\nimport { doc, getDoc, onSnapshot, collection, query, where, getDocs, updateDoc, arrayUnion, arrayRemove, limit, orderBy, startAfter } from 'firebase/firestore';\n\n\nimport './Home.css';\n\n// Simple Image Cropper Component\nimport { getResolvedPosterUrl } from '../utils/globalPosterResolver';\nimport BannerSearch from '../components/BannerSearch';\nimport BannerSelection from '../components/BannerSelection';\nimport BannerViewModal from '../components/BannerViewModal';\nimport BannerActionModal from '../components/BannerActionModal';\nimport ActivityFeed from '../components/ActivityFeed';\nimport * as watchlistService from '../utils/watchlistService';\nimport * as diaryService from '../utils/diaryService';\nimport { likesService } from '../utils/likesService';\nimport { getUserProfileData } from '../utils/profileService';\n\n// Helper for pinch distance\nconst getTouchDist = (touches) => {\n    const [t1, t2] = touches;\n    const dx = t1.pageX - t2.pageX;\n    const dy = t1.pageY - t2.pageY;\n    return Math.sqrt(dx * dx + dy * dy);\n};\n\nconst ImageCropper = ({ imageSrc, onCancel, onSave }) => {\n    const [position, setPosition] = useState({ x: 0, y: 0 });\n    const [zoom, setZoom] = useState(1);\n    const [isDragging, setIsDragging] = useState(false);\n    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });\n    const [pinchDist, setPinchDist] = useState(null);\n\n    const containerRef = useRef(null);\n    const imgRef = useRef(null);\n\n    // Ref to access latest state in non-passive event listeners without re-binding\n    const stateRef = useRef({\n        position: { x: 0, y: 0 },\n        zoom: 1,\n        isDragging: false,\n        dragStart: { x: 0, y: 0 },\n        pinchDist: null\n    });\n\n    // Sync state to ref\n    useEffect(() => {\n        stateRef.current = { position, zoom, isDragging, dragStart, pinchDist };\n    }, [position, zoom, isDragging, dragStart, pinchDist]);\n\n    // Attach non-passive listeners\n    useEffect(() => {\n        const container = containerRef.current;\n        if (!container) return;\n\n        const handleWheel = (e) => {\n            e.preventDefault();\n            e.stopPropagation();\n            const delta = -e.deltaY * 0.001;\n            const currentZoom = stateRef.current.zoom;\n            setZoom(Math.min(Math.max(0.2, currentZoom + delta), 5));\n        };\n\n        const handleTouchMove = (e) => {\n            e.preventDefault(); // Prevent page scroll\n            const { isDragging, dragStart, pinchDist, zoom } = stateRef.current;\n\n            if (e.touches.length === 1 && isDragging) {\n                setPosition({ x: e.touches[0].pageX - dragStart.x, y: e.touches[0].pageY - dragStart.y });\n            } else if (e.touches.length === 2 && pinchDist) {\n                const newDist = getTouchDist(e.touches);\n                const scaleFactor = newDist / pinchDist;\n                setZoom(Math.min(Math.max(0.2, zoom * scaleFactor), 5));\n                setPinchDist(newDist);\n            }\n        };\n\n        container.addEventListener('wheel', handleWheel, { passive: false });\n        container.addEventListener('touchmove', handleTouchMove, { passive: false });\n\n        return () => {\n            container.removeEventListener('wheel', handleWheel);\n            container.removeEventListener('touchmove', handleTouchMove);\n        };\n    }, []);\n\n    // --- MOUSE EVENTS ---\n    const onMouseDown = (e) => {\n        if (e.button !== 0) return;\n        setIsDragging(true);\n        setDragStart({ x: e.pageX - position.x, y: e.pageY - position.y });\n        e.stopPropagation();\n        e.preventDefault();\n    };\n\n    const onMouseMove = (e) => {\n        if (!isDragging) return;\n        setPosition({ x: e.pageX - dragStart.x, y: e.pageY - dragStart.y });\n        e.stopPropagation();\n        e.preventDefault();\n    };\n\n    const onMouseUp = () => setIsDragging(false);\n\n    const onTouchStart = (e) => {\n        if (e.touches.length === 1) {\n            setIsDragging(true);\n            setDragStart({ x: e.touches[0].pageX - position.x, y: e.touches[0].pageY - position.y });\n        } else if (e.touches.length === 2) {\n            setIsDragging(false);\n            setPinchDist(getTouchDist(e.touches));\n        }\n    };\n\n    const onTouchEnd = () => {\n        setIsDragging(false);\n        setPinchDist(null);\n    };\n\n    const handleSave = () => {\n        const canvas = document.createElement('canvas');\n        const size = 300;\n        canvas.width = size;\n        canvas.height = size;\n        const ctx = canvas.getContext('2d');\n        const img = imgRef.current;\n        if (!img) return;\n\n        // Fill black background first (for zoomed out fit)\n        ctx.fillStyle = '#000000';\n        ctx.fillRect(0, 0, size, size);\n\n        // Calculate rendered size to draw 1:1 with view\n        const renderWidth = img.offsetWidth;\n        const renderHeight = img.offsetHeight;\n\n        // Draw Image at current position with current size\n        ctx.drawImage(img, position.x, position.y, renderWidth, renderHeight);\n\n        onSave(canvas.toDataURL('image/jpeg', 0.9));\n    };\n\n    return (\n        <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.95)', zIndex: 3000, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', touchAction: 'none' }}>\n            <h3 style={{ color: 'white', marginBottom: '20px' }}>Adjust Profile Photo</h3>\n            <div\n                ref={containerRef}\n                style={{ width: '300px', height: '300px', border: '2px solid var(--accent-color)', position: 'relative', overflow: 'hidden', cursor: isDragging ? 'grabbing' : 'grab', background: '#000' }}\n                onMouseDown={onMouseDown}\n                onMouseMove={onMouseMove}\n                onMouseUp={onMouseUp}\n                onMouseLeave={onMouseUp}\n                onTouchStart={onTouchStart}\n                onTouchEnd={onTouchEnd}\n            >\n                {/* Guidelines */}\n                <div style={{ position: 'absolute', top: '33%', left: 0, right: 0, height: '1px', background: 'rgba(255,255,255,0.2)', pointerEvents: 'none', zIndex: 10 }}></div>\n                <div style={{ position: 'absolute', top: '66%', left: 0, right: 0, height: '1px', background: 'rgba(255,255,255,0.2)', pointerEvents: 'none', zIndex: 10 }}></div>\n                <div style={{ position: 'absolute', left: '33%', top: 0, bottom: 0, width: '1px', background: 'rgba(255,255,255,0.2)', pointerEvents: 'none', zIndex: 10 }}></div>\n                <div style={{ position: 'absolute', left: '66%', top: 0, bottom: 0, width: '1px', background: 'rgba(255,255,255,0.2)', pointerEvents: 'none', zIndex: 10 }}></div>\n\n                <img\n                    ref={imgRef}\n                    src={imageSrc}\n                    alt=\"Edit\"\n                    draggable={false}\n                    style={{\n                        position: 'absolute',\n                        top: position.y,\n                        left: position.x,\n                        // Flexible width based on zoom, allowing it to be smaller than container\n                        width: `${300 * zoom}px`,\n                        maxWidth: 'none',\n                        userSelect: 'none',\n                        transformOrigin: 'top left',\n                        willChange: 'width, top, left'\n                    }}\n                />\n            </div>\n\n            {/* Zoom Slider */}\n            <div style={{ width: '300px', margin: '20px 0 10px 0', display: 'flex', alignItems: 'center', gap: '10px' }}>\n                <span style={{ color: '#888', fontSize: '1.2rem' }}>-</span>\n                <input\n                    type=\"range\"\n                    min=\"0.2\"\n                    max=\"5\"\n                    step=\"0.01\"\n                    value={zoom}\n                    onChange={(e) => setZoom(parseFloat(e.target.value))}\n                    style={{ flex: 1, accentColor: 'var(--accent-color)', cursor: 'pointer' }}\n                />\n                <span style={{ color: '#888', fontSize: '1.2rem' }}>+</span>\n            </div>\n\n            <div style={{ marginTop: '10px', display: 'flex', gap: '20px' }}>\n                <button onClick={onCancel} style={{ padding: '10px 20px', background: '#333', color: '#fff', border: 'none', borderRadius: '4px', fontWeight: 'bold', cursor: 'pointer' }}>CANCEL</button>\n                <button onClick={handleSave} style={{ padding: '10px 20px', background: 'var(--accent-color)', color: '#000', border: 'none', borderRadius: '4px', fontWeight: 'bold', cursor: 'pointer' }}>SAVE</button>\n            </div>\n            <p style={{ color: '#666', marginTop: '10px', fontSize: '0.8rem', textAlign: 'center' }}>\n                Pinch/Scroll to Zoom â€¢ Drag to Move\n            </p>\n        </div>\n    );\n};\n\n// Helper: Robustly parses a TMDB ID, ensuring it's a number.\nconst parseTmdbId = (id) => {\n    if (!id) return null;\n    if (typeof id === 'number') return id;\n    if (typeof id === 'string' && id.includes('-S')) {\n        const numeric = parseInt(id.split('-S')[0]);\n        return isNaN(numeric) ? null : numeric;\n    }\n    const numeric = parseInt(id);\n    if (isNaN(numeric) || (typeof id === 'string' && id.match(/[a-z]/i) && !id.includes('-S'))) return null;\n    return numeric;\n};\n\n// Helper: Hydrate Likes with TMDB Data (Strict SSOT Rule: No metadata in DB)\nconst hydrateLikes = async (likesList) => {\n    if (!likesList || likesList.length === 0) return [];\n\n    const TMDB_API_KEY = import.meta.env.VITE_TMDB_API_KEY || '05587a49bd4890a9630d6c0e544e0f6f';\n    const uniqueIds = [...new Set(likesList.map(l => l.tmdbId))];\n\n    // Fetch detailed data for each show\n    const results = await Promise.all(uniqueIds.map(async (id) => {\n        try {\n            const res = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}`);\n            if (!res.ok) return null;\n            return await res.json();\n        } catch (e) { return null; }\n    }));\n\n    const seriesMap = results.reduce((acc, curr) => {\n        if (curr) acc[curr.id] = curr;\n        return acc;\n    }, {});\n\n    return likesList.map(item => {\n        const series = seriesMap[item.tmdbId];\n        let poster = null;\n        let name = 'Unknown Series';\n\n        if (series) {\n            poster = series.poster_path;\n            name = series.name;\n            // Use Season Poster if applicable\n            if (item.type === 'SEASON' && item.seasonNumber && series.seasons) {\n                const s = series.seasons.find(sea => sea.season_number === item.seasonNumber);\n                if (s && s.poster_path) poster = s.poster_path;\n            }\n        }\n\n        return {\n            ...item,\n            poster_path: poster,\n            seasonPoster: (item.type === 'SEASON') ? poster : null,\n            seriesName: name\n        };\n    });\n};\n\nconst Profile = () => {\n    const { uid } = useParams(); // Get uid from URL if present\n    const navigate = useNavigate();\n    const { currentUser, logout, globalPosters } = useAuth();\n\n    // Determine Target User (URL param > Current User)\n    const targetUid = uid || currentUser?.uid;\n    const isOwnProfile = !uid || (currentUser && targetUid === currentUser.uid);\n\n    const [user, setUser] = useState({});\n    const [stats, setStats] = useState({ thisYear: 0, following: 0, followers: 0 });\n    const [activeTab, setActiveTab] = useState('Profile');\n    const [profilePhoto, setProfilePhoto] = useState(null);\n    const [showMenu, setShowMenu] = useState(false);\n    const [editImageSrc, setEditImageSrc] = useState(null);\n    const [showFullPFP, setShowFullPFP] = useState(false);\n    const menuRef = useRef(null);\n\n    const isCollapsed = activeTab !== 'Profile';\n    const [favorites, setFavorites] = useState([null, null, null, null, null]);\n    const [watchlist, setWatchlist] = useState([]);\n    const [likes, setLikes] = useState([]);\n    const [reviews, setReviews] = useState([]);\n    const [watched, setWatched] = useState([]);\n    const [activityItems, setActivityItems] = useState([]);\n    const [starSeriesIds, setStarSeriesIds] = useState(new Set());\n\n    // Profile-specific Posters (Handles \\\"My View\\\" vs \\\"Friend View\\\")\n    const [profilePosters, setProfilePosters] = useState({});\n\n    // Banner Logic States\n    const [showBannerSearch, setShowBannerSearch] = useState(false);\n    const [showBannerSelection, setShowBannerSelection] = useState(false);\n    const [selectedBannerSeries, setSelectedBannerSeries] = useState(null);\n    const [showBannerView, setShowBannerView] = useState(false);\n    const [showBannerAction, setShowBannerAction] = useState(false);\n\n    // Activity Feed State\n    const [userActivityFeed, setUserActivityFeed] = useState([]);\n\n    // Fetch User Data (Optimized with ProfileService)\n    useEffect(() => {\n        // Determine if we need to fetch\n        // If targetUid is NOT currentUser, we must fetch.\n        // If targetUid IS currentUser, we still fetch to get latest SSOT data (diary, likes etc) but can seed with AuthContext.\n\n        const loadProfileData = async () => {\n            if (!targetUid) return;\n\n            // 1. Fetch Aggregated Data\n            const { userInfo, diary, watchlist: wl, likes: rawLikes, ratings: dbRatings, activityPreview, userPosters } = await getUserProfileData(targetUid);\n\n            // Set Posters (Own vs Other)\n            if (targetUid === currentUser?.uid) {\n                setProfilePosters(globalPosters || {});\n            } else if (userPosters) {\n                setProfilePosters(userPosters);\n            }\n\n            if (userInfo) {\n                // If own profile, merge with AuthContext if available for fresher UI state (optional, but good for perceived speed)\n                // Or typically just use the fetched data.\n                setUser(userInfo);\n                setProfilePhoto(userInfo.photoURL);\n\n                // Update Derived State\n                const starSeries = userInfo.starSeries || [];\n                setStarSeriesIds(new Set(starSeries.map(s => s.id)));\n\n                // Favorites\n                const loadedFavs = userInfo.favorites || [];\n                const limitedFavs = loadedFavs.slice(0, 5);\n                const paddedFavs = [...limitedFavs, ...Array(Math.max(0, 5 - limitedFavs.length)).fill(null)].map(f => {\n                    if (!f) return null;\n                    return { ...f, isStar: starSeries.some(s => s.id === f.id) };\n                });\n                setFavorites(paddedFavs);\n\n                // Stats\n                const currentYear = new Date().getFullYear();\n                const achievements = userInfo.achievements || [];\n                const followedByMe = userInfo.followers?.includes(currentUser?.uid);\n\n                setStats({\n                    thisYear: achievements.filter(a => a.type === 'season_finish' && new Date(a.date).getFullYear() === currentYear).length,\n                    following: userInfo.following?.length || 0,\n                    followers: userInfo.followers?.length || 0,\n                    streak: userInfo.streak?.current || 0\n                });\n                setIsFollowing(followedByMe);\n            }\n\n            // 2. Set SSOT Data\n            setWatchlist(wl);\n            setWatched(diary); // Diary\n            // Activity Feed (From Firebase Preview)\n            setUserActivityFeed(activityPreview);\n            // Ratings (Not explicitly used in state yet? Ah, Profile doesn't visualize ratings list directly, only uses them for stats/badges if needed. But service returns them.)\n\n            // 3. Hydrate Likes (SSOT Rule: Service returns Raw, UI Hydrates)\n            const hydratedLikes = await hydrateLikes(rawLikes);\n            setLikes(hydratedLikes);\n        };\n\n        loadProfileData();\n\n        // Menu Close Handler\n        const handleClickOutside = (event) => {\n            if (menuRef.current && !menuRef.current.contains(event.target)) setShowMenu(false);\n        };\n        document.addEventListener('mousedown', handleClickOutside);\n        return () => {\n            document.removeEventListener('mousedown', handleClickOutside);\n        };\n\n    }, [targetUid, currentUser]); // Removing 'globalPosters' dependency as hydration uses helper or internal logic? \n    // Wait, profilePosters state logic?\n    // The previous code had specific logic for profilePosters fetching.\n    // I should probably Keep the profilePosters logic separate if services don't handle it.\n    // The instructions said \"Replace them with ONE call ... profileService.getUserProfileData\".\n    // Does profileService return user posters? No.\n    // So I should keep the existing `profilePosters` useEffect logic found in lines 253-276?\n    // The prompt: \"No direct DB queries in Profile.jsx\".\n    // line 259: `supabase.from('user_posters')...`\n    // I should move this to profileService or a separate service call? \n    // Prompt says \"REMOVE ALL direct queries to: Supabase\".\n    // So I should have included 'user_posters' in profileService.\n    // BUT the prompt didn't list `user_posters` in \"Expected return shape\". \n    // \"Expected return shape: { userInfo, diary, watchlist, likes, ratings, activityPreview }\".\n    // AND \"NO new features\".\n\n    // I will KEEP the `profilePosters` fetch separate for now (or move to profileService if permissible, but risk breaking expected shape).\n    // Actually, `user_posters` table query IS a Supabase query.\n    // User Instructions: \"Replace them with ONE call ... profileService.getUserProfileData(uid)\".\n    // If I leave `user_posters` query, I fail \"No direct DB queries\".\n    // I should Add `userPosters` to `profileService` return? \n    // Or ignore? If I ignore, Profile Posters break.\n    // I will Add it to `profileService` implementation in a minute? \n    // Or just leave it as an exception?\n    // \"Phase 2.7 goal ... Reduce DB reads\".\n    // If I add it to `profileService`, I reduce network calls.\n    // I Will UPDATE `profileService.js` to include `user_posters` fetch.\n    // But first, let's look at the replacement block.\n    // I need to be careful not to delete the `profilePosters` logic if I don't have replacement.\n    // I will leave `profilePosters` logic for a separate tool call to move it to `profileService`? \n    // Step 2 is: \"Replace loadProfile and syncSelfData logic\". \n    // I will replace `loadProfile` and `syncSelfData`.\n    // I will leave `profilePosters` block (lines 253-276) alone for now, because it was separate.\n    // Wait, the block I am replacing spans 252-463. This INCLUDES `profilePosters`.\n    // If I overwrite valid logic with nothing, I break \"Profile loads correctly\".\n    // I MUST move `user_posters` fetching to `profileService` OR keep the logic.\n    // I will KEEP the logic by including it in the new `useEffect` but wrapped inline? \n    // No, \"Removes duplicated queries\".\n    // I WILL UPDATE `profileService.js` to fetch posters too.\n\n    // BUT I cannot update `profileService.js` in this `multi_replace`.\n    // Implementation Plan: \"Import and reuse existing services: diary, watchlist, likes, ratings\".\n    // Does not mention `userPosters`.\n    // I will assume `userPosters` is minor enough to fetch separately or inline via `supabase-config` import?\n    // But explicit rule: \"Remove ALL direct queries to Supabase\".\n    // Okay, I will add `user_posters` to `profileService` in a subsequent step (or previous step, but I already wrote it).\n    // I will perform the Profile update assuming I will FIX `profileService` to return posters.\n    // I will update `Profile.jsx` to USE `profilePosters` from service.\n\n    // Wait, line 253-276:\n    /*\n        if (targetUid === currentUser?.uid) {\n            setProfilePosters(globalPosters || {});\n        } else if (targetUid) {\n             // Fetch from Supabase\n        }\n    */\n    // This logic handles \"My View\" (Context) vs \"Friend View\" (DB).\n    // Service handles DB. \n    // So `getUserProfileData` should return `userPosters` (from DB).\n    // In `Profile.jsx`:\n    // if (targetUid === currentUser) setProfilePosters(globalPosters)\n    // else setProfilePosters(data.userPosters)\n\n    // Okay. Ready.\n\n    // Reviews Pagination Logic\n    const [lastReview, setLastReview] = useState(null);\n    const [loadingReviews, setLoadingReviews] = useState(false);\n    const [hasMoreReviews, setHasMoreReviews] = useState(true);\n\n    const fetchReviews = async (isInitial = false) => {\n        if (loadingReviews) return;\n        setLoadingReviews(true);\n        try {\n            let q = query(\n                collection(db, 'reviews'),\n                where('userId', '==', targetUid),\n                orderBy('createdAt', 'desc'), // Assuming 'createdAt' exists. Old code used 'date'? No, verify sort logic.\n                // Old code: sorted by new Date(b.createdAt) - new Date(a.createdAt). So field is createdAt.\n                limit(10)\n            );\n\n            if (!isInitial && lastReview) {\n                q = query(q, startAfter(lastReview));\n            }\n\n            const snap = await getDocs(q);\n            const fetched = snap.docs.map(d => ({ ...d.data(), id: d.id })); // .sort by desc usually handled by query\n\n            if (fetched.length < 10) setHasMoreReviews(false);\n\n            setLastReview(snap.docs[snap.docs.length - 1]);\n\n            if (isInitial) {\n                setReviews(fetched);\n            } else {\n                setReviews(prev => [...prev, ...fetched]);\n            }\n        } catch (e) {\n            console.error(\"Error fetching reviews:\", e);\n        }\n        setLoadingReviews(false);\n    };\n\n    // Trigger Fetch on Tab Change\n    useEffect(() => {\n        if (activeTab === 'Reviews' && reviews.length === 0 && hasMoreReviews) {\n            fetchReviews(true);\n        }\n    }, [activeTab, targetUid]);\n\n    // Activity Feed Fetch - REMOVED (Moved to ActivityFeed component)\n\n\n    const { alert } = useNotification();\n\n    const handleFileSelect = (e) => {\n        const file = e.target.files[0];\n        if (file) {\n            if (file.size > 5000000) return alert(\"File too large!\", \"Upload Error\");\n            const reader = new FileReader();\n            reader.onloadend = () => { setEditImageSrc(reader.result); setShowMenu(false); };\n            reader.readAsDataURL(file);\n        }\n    };\n\n    const handleSaveCropped = async (base64) => {\n        setProfilePhoto(base64);\n        setEditImageSrc(null);\n        try { await updateDoc(doc(db, 'users', currentUser.uid), { photoURL: base64 }); } catch (err) { console.error(err); }\n    };\n\n    // DEBUG: Reset Database function\n    const handleResetStars = async () => {\n        const isConfirmed = await confirm(\"This will remove ALL Star Badges properly. Are you sure? You can't undo this.\", \"Reset Star Badges\", \"YES, DUMP STARS\", \"CANCEL\");\n        if (isConfirmed) {\n            try {\n                await updateDoc(doc(db, 'users', currentUser.uid), { starSeries: [] });\n                alert(\"All Star Badges have been removed.\", \"Cleanup Successful\");\n            } catch (e) {\n                console.error(e);\n                alert(\"Failed to reset.\", \"Error\");\n            }\n        }\n    };\n\n    const [isFollowing, setIsFollowing] = useState(false);\n\n    // Pull to Refresh State\n    const [refreshing, setRefreshing] = useState(false);\n    const [pullStartY, setPullStartY] = useState(0);\n\n    const handleBoxClick = (index) => window.dispatchEvent(new CustomEvent('trigger-search-bar', { detail: { slotIndex: index } }));\n\n    const handleFollowToggle = async () => {\n        if (!currentUser || !targetUid) return;\n\n        const myRef = doc(db, 'users', currentUser.uid);\n        const targetRef = doc(db, 'users', targetUid);\n\n        try {\n            if (isFollowing) {\n                // Unfollow\n                await updateDoc(myRef, { following: arrayRemove(targetUid) });\n                await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });\n                setIsFollowing(false);\n            } else {\n                // Follow\n                await updateDoc(myRef, { following: arrayUnion(targetUid) });\n\n                // Notification Logic (Aggregated)\n                const targetDoc = await getDoc(targetRef);\n                if (targetDoc.exists()) {\n                    const data = targetDoc.data();\n                    const currentNotifs = data.notifications || [];\n\n                    // Check for existing \"new follower\" notification\n                    const existingFollowIndex = currentNotifs.findIndex(n => n.type === 'follow');\n\n                    if (existingFollowIndex !== -1) {\n                        // Aggregate\n                        const existing = currentNotifs[existingFollowIndex];\n                        let count = 1; // Default if plain message\n                        // Match \"follower(N)\" pattern\n                        const match = existing.message && existing.message.match(/follower\\((\\d+)\\)/);\n                        if (match) {\n                            count = parseInt(match[1]);\n                        }\n\n                        const newCount = count + 1;\n                        const newMessage = `HEY SERIEER, new follower(${newCount}) for you !`;\n\n                        // Update the existing item\n                        const updatedNotif = {\n                            ...existing,\n                            message: newMessage,\n                            timestamp: new Date().toISOString(),\n                            from: 'multiple' // or keep last sender\n                        };\n\n                        // Replace in array\n                        const newNotifs = [...currentNotifs];\n                        newNotifs[existingFollowIndex] = updatedNotif;\n\n                        await updateDoc(targetRef, {\n                            followers: arrayUnion(currentUser.uid),\n                            notifications: newNotifs\n                        });\n\n                    } else {\n                        // Create New\n                        const notifMsg = `HEY SERIEER , new follower for you!`;\n                        const notifObj = { message: notifMsg, type: 'follow', from: currentUser.uid, timestamp: new Date().toISOString() };\n\n                        await updateDoc(targetRef, {\n                            followers: arrayUnion(currentUser.uid),\n                            notifications: arrayUnion(notifObj)\n                        });\n                    }\n                } else {\n                    // Just add follower if issue reading\n                    await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });\n                }\n                setIsFollowing(true);\n            }\n        } catch (error) {\n            console.error(\"Error toggling follow:\", error);\n            if (error.code === 'permission-denied') {\n                alert(\"Permission Denied: Unable to update follower stats. Please check Firestore Security Rules to allow updating 'followers' array for other users.\", \"Backend Error\");\n            } else {\n                alert(\"Failed to update follow status.\", \"Error\");\n            }\n        }\n    };\n\n    // Refresh Logic (Simple Reload)\n    const handleTouchStart = (e) => {\n        if (window.scrollY === 0) setPullStartY(e.touches[0].clientY);\n    };\n\n    const handleTouchMove = (e) => {\n        const y = e.touches[0].clientY;\n        if (pullStartY && y > pullStartY + 50 && window.scrollY === 0) {\n            // Visual cue could go here\n        }\n    };\n\n    const handleTouchEnd = (e) => {\n        const y = e.changedTouches[0].clientY;\n        if (pullStartY && y > pullStartY + 100 && window.scrollY === 0) {\n            setRefreshing(true);\n            // Simulate refresh or reload\n            setTimeout(() => {\n                window.location.reload();\n            }, 800);\n        }\n        setPullStartY(0);\n    };\n\n    const getDiaryGroups = () => {\n        const groups = {};\n        const sorted = [...watched].sort((a, b) => new Date(b.date) - new Date(a.date));\n        const groupedItems = [];\n        let currentGroup = null;\n\n        sorted.forEach(item => {\n            const itemDateStr = new Date(item.date).toDateString();\n            if (item.isEpisode) {\n                if (currentGroup && currentGroup.tmdbId === item.tmdbId && currentGroup.seasonNumber === item.seasonNumber && new Date(currentGroup.date).toDateString() === itemDateStr) {\n                    currentGroup.episodes.push(item);\n                    currentGroup.episodeCount++;\n                } else {\n                    if (currentGroup) groupedItems.push(currentGroup);\n                    currentGroup = { ...item, isGroup: true, episodes: [item], episodeCount: 1 };\n                }\n            } else {\n                if (currentGroup) { groupedItems.push(currentGroup); currentGroup = null; }\n                groupedItems.push(item);\n            }\n        });\n        if (currentGroup) groupedItems.push(currentGroup);\n\n        groupedItems.forEach(item => {\n            const date = new Date(item.date);\n            const key = `${date.toLocaleString('default', { month: 'long' }).toUpperCase()} ${date.getFullYear()}`;\n            if (!groups[key]) groups[key] = [];\n            groups[key].push(item);\n        });\n        return groups;\n    };\n\n    const formatTimeAgo = (dateStr) => {\n        const date = new Date(dateStr);\n        if (isNaN(date.getTime())) return '';\n        const diffInSeconds = Math.floor((new Date() - date) / 1000);\n        if (diffInSeconds < 60) return `${diffInSeconds}s`;\n        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`;\n        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h`;\n        return `${Math.floor(diffInSeconds / 86400)}d`;\n    }\n\n    const formatTime = (dateStr) => {\n        const date = new Date(dateStr);\n        return isNaN(date.getTime()) ? '' : date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n    }\n\n    const formatDateShort = (dateStr) => {\n        const date = new Date(dateStr);\n        return isNaN(date.getTime()) ? '' : date.toLocaleDateString([], { month: 'short', day: 'numeric' });\n    }\n\n    // Banner Handlers\n    const handleBannerClick = () => {\n        if (isOwnProfile) {\n            setShowBannerAction(true);\n        } else if (user.bannerBackdropPath) {\n            setShowBannerView(true);\n        }\n    };\n\n    const handleSeriesForBanner = (series) => {\n        setSelectedBannerSeries(series);\n        setShowBannerSearch(false);\n        setShowBannerSelection(true);\n    };\n\n    const [basketModalData, setBasketModalData] = useState(null);\n\n    // Grouping Logic for Watchlist (Deduplicated)\n    const processWatchlist = (list) => {\n        const groups = {}; // Key: \"seriesId_SseasonNumber\"\n\n        // 1. Identify Episode Baskets\n        // Filter and process episodes first to build groups\n        list.forEach(item => {\n            if (item.seasonNumber !== undefined && item.seasonNumber !== null && item.episodeNumber !== undefined) {\n                const key = `${item.seriesId || item.id}_S${item.seasonNumber}`;\n                if (!groups[key]) {\n                    groups[key] = {\n                        type: 'basket',\n                        seriesId: item.seriesId || item.id,\n                        seasonNumber: item.seasonNumber,\n                        name: item.name,\n                        poster_path: item.poster_path,\n                        seasonPoster: item.seasonPoster,\n                        episodes: []\n                    };\n                }\n                groups[key].episodes.push(item);\n                if (!groups[key].seasonPoster && item.seasonPoster) groups[key].seasonPoster = item.seasonPoster;\n            }\n        });\n\n        const processed = [];\n\n        // 2. Add Whole Series/Seasons (Dedupe check)\n        list.forEach(item => {\n            // Skip episodes (already handled)\n            if (item.seasonNumber !== undefined && item.episodeNumber !== undefined) return;\n\n            // Check for duplicates\n            if (item.seasonNumber !== undefined) {\n                const basketKey = `${item.seriesId || item.id}_S${item.seasonNumber}`;\n                // If a basket already exists for this season, SKIP this Season Item\n                if (groups[basketKey]) return;\n            }\n\n            processed.push({ ...item, type: 'series', isSeason: item.seasonNumber !== undefined });\n        });\n\n        // 3. Add Baskets to Processed\n        Object.values(groups).forEach(basket => {\n            basket.episodeCount = basket.episodes.length;\n            basket.episodes.sort((a, b) => a.episodeNumber - b.episodeNumber);\n            if (basket.seasonPoster) basket.poster_path = basket.seasonPoster;\n\n            // Name cleanup\n            if (basket.episodes[0]) {\n                const parts = basket.episodes[0].name.split(' - ');\n                basket.name = parts[0] + (basket.seasonNumber ? ` (Season ${basket.seasonNumber})` : '');\n            }\n\n            processed.push(basket);\n        });\n\n        return processed;\n    };\n\n    const handleRemoveFromWatchlist = async (itemToRemove) => {\n        if (!currentUser) return;\n        try {\n            // OPTIMISTIC UPDATE: Update local state immediately\n            setWatchlist(prev => prev.filter(i => {\n                const isSameItem = (i.id || i.tmdb_id) === (itemToRemove.id || itemToRemove.tmdb_id);\n                return !isSameItem;\n            }));\n\n            // SUPABASE DELETE: Remove from SSOT\n            await watchlistService.removeFromWatchlist(currentUser.uid, itemToRemove.id || itemToRemove.tmdb_id);\n\n            // Update local basket state if open\n            if (basketModalData) {\n                const newBasketEps = basketModalData.episodes.filter(i => (i.id || i.tmdb_id) !== (itemToRemove.id || itemToRemove.tmdb_id));\n                if (newBasketEps.length === 0) setBasketModalData(null);\n                else setBasketModalData({ ...basketModalData, episodes: newBasketEps });\n            }\n        } catch (error) {\n            console.error(\"Error removing from watchlist:\", error);\n        }\n    };\n\n    const renderTabContent = () => {\n        const content = (() => {\n            switch (activeTab) {\n                case 'Profile':\n                    return (\n                        <div className=\"profile-content-col\">\n                            <div style={{ marginBottom: '3rem' }}>\n\n                                <h3 className=\"favorite-series-label\" style={{ marginTop: '30px', marginBottom: '20px' }}>FAVORITE SERIES</h3>\n                                <div className=\"favorites-grid\">\n                                    {favorites.map((fav, index) => (\n                                        <div key={index} className=\"favorite-box\" style={{ border: 'none', overflow: 'visible', margin: (fav && starSeriesIds.has(fav.id)) ? '20px 0 0 20px' : '0', transition: 'margin 0.3s' }}>\n                                            {fav ? (\n                                                <>\n                                                    {(() => {\n                                                        const validTmdbId = parseTmdbId(fav.tmdbId || fav.id);\n                                                        if (!validTmdbId) return null; // Don't link if ID is malformed\n\n                                                        return (\n                                                            <Link to={fav.seasonNumber ? `/tv/${validTmdbId}/season/${fav.seasonNumber}` : `/tv/${validTmdbId}`} style={{ display: 'block', width: '100%', height: '100%', position: 'relative', overflow: 'visible' }}>\n                                                                <img src={getResolvedPosterUrl(validTmdbId, fav.seasonPoster || fav.poster_path, profilePosters, 'w342') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'} alt={fav.name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />\n                                                            </Link>\n                                                        );\n                                                    })()}\n                                                    {isOwnProfile && <button onClick={(e) => { e.preventDefault(); handleBoxClick(index); }} using className=\"edit-fav-btn\"><MdCreate /></button>}\n                                                </>\n                                            ) : (\n                                                isOwnProfile ? (\n                                                    <div onClick={() => handleBoxClick(index)} style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>\n                                                        <MdAdd size={40} color=\"var(--accent-color)\" />\n                                                    </div>\n                                                ) : <div style={{ width: '100%', height: '100%', background: '#111' }} />\n                                            )}\n                                        </div>\n                                    ))\n                                    }\n                                </div>\n                            </div>\n                        </div>\n                    );\n                case 'Diary':\n                    const groups = getDiaryGroups();\n                    return (\n                        <div style={{ maxWidth: '100%', paddingBottom: '20px' }}>\n                            {Object.keys(groups).length === 0 ? <p style={{ color: 'var(--text-muted)' }}>No entries yet.</p> : Object.keys(groups).map((group, i) => (\n                                <div key={i} style={{ marginBottom: '2rem' }}>\n                                    <h3 style={{ fontSize: '1rem', fontWeight: '900', color: '#888', marginBottom: '15px', textTransform: 'uppercase', letterSpacing: '1px' }}>{group}</h3>\n                                    <div className=\"diary-grid\">\n                                        {groups[group].map((item, idx) => {\n                                            const dateObj = new Date(item.date);\n                                            const dateBadge = `${dateObj.getDate()} ${dateObj.toLocaleString('default', { month: 'short' }).toUpperCase()}`;\n                                            const cleanTitle = item.name.replace(/\\s*\\(Season \\d+\\)$/, ''); // Strip season text if present\n\n                                            return (\n                                                <div key={idx} className=\"diary-card\">\n                                                    <Link\n                                                        to={item.seasonNumber ? `/tv/${item.tmdbId}/season/${item.seasonNumber}` : `/tv/${item.tmdbId}`}\n                                                        className=\"diary-poster-container\"\n                                                    >\n                                                        <img\n                                                            src={getResolvedPosterUrl(item.tmdbId, item.seasonPoster || item.poster_path, profilePosters, 'w342') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'}\n                                                            alt={item.name}\n                                                        />\n                                                        {/* DATE BADGE ONLY */}\n                                                        <div className=\"diary-poster-date\">\n                                                            {dateBadge}\n                                                        </div>\n                                                    </Link>\n\n                                                    <div className=\"diary-info\">\n                                                        <div className=\"diary-title\">{cleanTitle}</div>\n                                                        {item.seasonNumber && (\n                                                            <div className=\"diary-season\">Season {item.seasonNumber}</div>\n                                                        )}\n                                                    </div>\n                                                </div>\n                                            );\n                                        })}\n                                    </div>\n                                </div>\n                            ))}\n                        </div >\n                    );\n                case 'Activity':\n                    // Uses Single Aggregated Feed\n                    return (\n                        <div className=\"activity-feed\">\n                            <ActivityFeed userId={targetUid} feed={userActivityFeed} />\n                        </div>\n                    );\n                case 'Watchlist':\n                case 'Liked':\n                    if (activeTab === 'Liked') {\n                        return (\n                            <div className=\"watchlist-grid\" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px', padding: '10px' }}>\n                                {likes.filter(i => i.type !== 'like_review').map(item => (\n                                    <div key={item.id} style={{ position: 'relative', paddingTop: starSeriesIds.has(item.tmdbId || item.id) ? '0' : '0', paddingLeft: '0' }}>\n                                        <Link to={item.seasonNumber ? `/tv/${item.tmdbId}/season/${item.seasonNumber}` : `/tv/${item.tmdbId}`} style={{ display: 'block', border: 'none', aspectRatio: '2/3', position: 'relative', overflow: 'visible' }}>\n                                            <img src={getResolvedPosterUrl(item.tmdbId, item.seasonPoster || item.poster_path, profilePosters, 'w500') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'} style={{ width: '100%', height: '100%', objectFit: 'cover', display: 'block', position: 'relative', zIndex: 1 }} />\n                                        </Link>\n                                    </div>\n                                ))}\n                            </div>\n                        );\n                    }\n\n                    // Watchlist Case\n                    const watchlistItems = processWatchlist(watchlist);\n                    return (\n                        <div className=\"watchlist-grid\" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '10px', padding: '10px' }}>\n                            {watchlistItems.map((item, idx) => {\n                                if (item.type === 'basket') {\n                                    return (\n                                        <div key={idx} onClick={() => setBasketModalData(item)} style={{ cursor: 'pointer', display: 'block', width: '100%', border: '1px solid var(--border-color)', aspectRatio: '2/3', position: 'relative', overflow: 'hidden' }}>\n                                            <img src={getResolvedPosterUrl(item.tmdbId, item.poster_path, profilePosters, 'w500') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'} style={{ width: '100%', height: '100%', objectFit: 'cover', display: 'block', position: 'relative', zIndex: 1 }} />\n                                            {/* Basket Badges */}\n                                            <div className=\"diary-season-badge\" style={{ top: '6px', right: '6px', fontSize: '0.8rem', padding: '4px 6px' }}>S{item.seasonNumber}</div>\n                                            <div className=\"diary-eps-badge\" style={{ bottom: '6px', right: '6px', fontSize: '0.75rem' }}>{item.episodeCount} EPS</div>\n                                        </div>\n                                    );\n                                } else {\n                                    // Whole Series\n                                    return (\n                                        <div key={idx} style={{ position: 'relative', overflow: 'visible', paddingTop: starSeriesIds.has(item.tmdbId) ? '20px' : '0', paddingLeft: starSeriesIds.has(item.tmdbId) ? '20px' : '0' }}>\n                                            <Link to={`/tv/${item.tmdbId}`} style={{ display: 'block', border: 'none', aspectRatio: '2/3', position: 'relative', overflow: 'visible' }}>\n                                                <img src={getResolvedPosterUrl(item.tmdbId, item.poster_path, profilePosters, 'w500') || 'https://placehold.co/200x300/141414/FFFF00?text=No+Image'} style={{ width: '100%', height: '100%', objectFit: 'cover', display: 'block', position: 'relative', zIndex: 1 }} />\n                                                {item.seasonNumber && (\n                                                    <div className=\"diary-season-badge\" style={{ top: '6px', right: '6px', fontSize: '0.8rem', padding: '4px 6px' }}>S{item.seasonNumber}</div>\n                                                )}\n                                            </Link>\n                                        </div>\n                                    );\n                                }\n                            })}\n                        </div>\n                    );\n                default: return null;\n            }\n        })();\n\n        return <div key={activeTab} className=\"slide-content-anim\">{content}</div>;\n    };\n\n    return (\n        <div style={{ paddingBottom: '80px', minHeight: '100vh', background: '#000' }}>\n            {/* Banner Section */}\n            <div\n                className=\"profile-banner-container\"\n                onClick={handleBannerClick}\n                style={{\n                    width: '100%',\n                    aspectRatio: '3.5/1', // Twitter-like ultra wide\n                    maxHeight: '400px',\n                    minHeight: '180px',\n                    background: user.bannerBackdropPath\n                        ? `url(https://image.tmdb.org/t/p/w1280${user.bannerBackdropPath}) center center/cover no-repeat`\n                        : '#1a1a1a', // Dark clean grey if empty\n                    position: 'relative',\n                    cursor: 'pointer',\n                    marginBottom: '-80px', // Avatar overlap\n                    maskImage: 'linear-gradient(to bottom, black 60%, transparent 100%)',\n                    WebkitMaskImage: 'linear-gradient(to bottom, black 60%, transparent 100%)'\n                }}\n            >\n                {/* Mobile Responsive Style Injection */}\n                <style>{`\n                    @media (max-width: 768px) {\n                        .profile-banner-container {\n                            aspect-ratio: 3/1 !important; /* Slightly taller on mobile for touch target */\n                            min-height: 150px !important;\n                        }\n                    }\n                `}</style>\n\n                {!user.bannerBackdropPath && isOwnProfile && (\n                    <div style={{\n                        position: 'absolute',\n                        top: '40%',\n                        left: '50%',\n                        transform: 'translate(-50%, -50%)',\n                        textAlign: 'center',\n                        color: '#666',\n                        zIndex: 2,\n                        pointerEvents: 'none' // Click passes to container\n                    }}>\n                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold', marginBottom: '5px' }}>Add profile banner</div>\n                        <div style={{ fontSize: '0.9rem' }}>Choose from your favorite series</div>\n                    </div>\n                )}\n\n                {/* Gradient Overlay for Readability - ALWAYS */}\n                <div style={{\n                    position: 'absolute',\n                    bottom: 0,\n                    left: 0,\n                    width: '100%',\n                    height: '100%',\n                    background: 'linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%)',\n                    pointerEvents: 'none'\n                }} />\n\n                {/* REMOVED: Edit Button/Badge */}\n            </div>\n\n            <div\n                className=\"profile-wrapper\"\n                style={{ width: '90%', margin: '0 auto', maxWidth: '1200px', padding: '2rem 0', color: 'var(--text-primary)', position: 'relative', zIndex: 10 }}\n                onTouchStart={handleTouchStart}\n                onTouchMove={handleTouchMove}\n                onTouchEnd={handleTouchEnd}\n            >\n                {refreshing && (\n                    <div style={{ position: 'fixed', top: '20%', left: '50%', transform: 'translateX(-50%)', zIndex: 9999 }}>\n                        <div className=\"loading-circle\" style={{ width: '40px', height: '40px', border: '4px solid #333', borderTop: '4px solid #FFCC00', borderRadius: '50%', animation: 'spin 1s linear infinite' }}></div>\n                        <style>{`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>\n                    </div>\n                )}\n\n                <style>\n                    {`\n                .profile-header-grid { display: grid; grid-template-columns: auto 1fr; column-gap: 2rem; row-gap: 1.5rem; margin-bottom: 2rem; position: relative; }\n                .collapsible-header-content { grid-column: 1 / 3; display: flex; gap: 2rem; transition: max-height 0.5s ease, opacity 0.4s ease; max-height: 500px; opacity: 1; overflow: hidden; }\n                .collapsible-header-content.collapsed { max-height: 0; opacity: 0; margin-bottom: 0; }\n                .profile-avatar-area { width: 120px; display: flex; flex-direction: column; align-items: center; gap: 15px; }\n                .profile-details-area { display: flex; flex-direction: column; gap: 15px; padding-top: 10px; flex: 1; }\n                .profile-actions-animated { position: absolute; top: 0; right: 0; transition: all 0.5s ease; z-index: 10; display: flex; gap: 10px; align-items: center; }\n                .profile-actions-animated.collapsed-menu { top: 10px; opacity: 0; pointer-events: none; visibility: hidden; }\n                .follow-btn {\n                    padding: 8px 24px;\n                    font-size: 1rem;\n                    font-weight: 900;\n                    text-transform: uppercase;\n                    cursor: pointer;\n                    border: 2px solid; /* Square border styling handled by border-radius 0 default or explicit */\n                    border-radius: 0px;\n                    transition: all 0.2s ease;\n                }\n                .follow-btn.not-following {\n                    background: #FFCC00;\n                    color: #000;\n                    border-color: #FFCC00;\n                }\n                .follow-btn.following {\n                    background: #fff;\n                    color: #000;\n                    border-color: #fff;\n                }\n\n                .stats-container { display: flex; gap: 40px; align-items: center; }\n                .social-icons { display: flex; gap: 15px; justify-content: center; }\n                .social-icon-link { color: #888; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }\n                .profile-username { font-size: 2rem; font-weight: 900; line-height: 1; color: var(--text-primary); }\n                .stats-number { font-size: 1.2rem; font-weight: 900; color: #FFFFFF; }\n                .stats-label { font-size: 0.75rem; font-weight: bold; color: #FFFFFF; letter-spacing: 1px; white-space: nowrap; margin-top: 2px; }\n                .profile-bio { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.4; max-width: 500px; white-space: pre-wrap; }\n\n                .nav-scroll-container { display: flex; overflow-x: auto; white-space: nowrap; scrollbar-width: none; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; margin-top: 1rem; }\n                .nav-tab-btn { padding: 15px 25px; font-size: 1rem; background: transparent; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }\n\n                /* Favorites */\n                .favorites-grid { display: flex; gap: 15px; }\n                .favorite-box { width: 140px; aspect-ratio: 2/3; background: var(--bg-secondary); border: none; position: relative; flex-shrink: 0; }\n                .edit-fav-btn { position: absolute; top: 5px; right: 5px; background: transparent; color: #fff; border: none; width: 24px; height: 24px; display: flex; alignItems: center; justifyContent: center; cursor: pointer; }\n                .badge-star-s { position: absolute; bottom: -5px; right: -5px; width: 30px; height: 30px; background: #FFCC00; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); display: flex; alignItems: center; justifyContent: center; fontWeight: 900; color: black; font-size: 0.8rem; z-index: 10; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); }\n\n                /* Menu */\n                .menu-dropdown { position: absolute; top: 100%; right: 0; background: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 180px; z-index: 100; display: flex; flex-direction: column; animation: menuPop 0.2s forwards; }\n                @keyframes menuPop { from {opacity: 0; transform: scale(0.8);} to {opacity: 1; transform: scale(1);} }\n                .menu-item { background: transparent; border: none; color: #fff; padding: 12px 16px; text-align: left; font-size: 0.9rem; font-weight: bold; cursor: pointer; display: block; width: 100%; }\n                .menu-item:hover { background: #222; }\n\n                /* Slide Anim */\n                .slide-content-anim { animation: slideInRight 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }\n                @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }\n\n                /* Diary Badges */\n                /* NEW DIARY GRID STYLES */\n                .diary-grid {\n                    display: grid;\n                    grid-template-columns: 1fr 1fr; /* 2 Column Mobile First */\n                    gap: 15px;\n                }\n\n                .diary-card {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 8px;\n                }\n\n                .diary-poster-container {\n                    display: block;\n                    width: 100%;\n                    aspect-ratio: 2/3;\n                    border-radius: 14px;\n                    overflow: hidden;\n                    position: relative;\n                    background: #222; /* Loading placeholder */\n                }\n\n                .diary-poster-container img {\n                    width: 100%;\n                    height: 100%;\n                    object-fit: cover;\n                }\n\n                /* DATE BADGE ON POSTER */\n                .diary-poster-date {\n                    position: absolute;\n                    bottom: 8px;\n                    right: 8px;\n                    background: rgba(0, 0, 0, 0.65);\n                    backdrop-filter: blur(4px);\n                    color: white;\n                    padding: 4px 8px;\n                    border-radius: 6px;\n                    font-size: 0.75rem;\n                    font-family: inherit;\n                    font-weight: 800;\n                    letter-spacing: 0.5px;\n                    z-index: 5;\n                    pointer-events: none;\n                }\n\n                .diary-info {\n                    display: flex;\n                    flex-direction: column;\n                }\n\n                .diary-title {\n                    color: #fff;\n                    font-weight: bold;\n                    font-size: 0.95rem;\n                    line-height: 1.2;\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    display: -webkit-box;\n                    -webkit-line-clamp: 1;\n                    -webkit-box-orient: vertical;\n                }\n\n                .diary-season {\n                    color: #888;\n                    font-size: 0.85rem;\n                    margin-top: 2px;\n                }\n\n                /* ACTIVITY FEED STYLES */\n                .activity-feed { display: flex; flex-direction: column; gap: 30px; }\n                .activity-item { display: flex; flex-direction: column; gap: 10px; }\n                .activity-header { font-size: 1rem; line-height: 1.4; }\n                .user-text { fontWeight: bold; color: #fff; }\n                .action-text { color: #888; }\n                .activity-title { fontWeight: 900; color: #fff; text-decoration: none; font-size: 1.1rem; }\n\n                .activity-body { display: flex; gap: 20px; align-items: flex-start; }\n                .activity-poster-wrapper { width: 110px; aspect-ratio: 2/3; position: relative; flex-shrink: 0; border-radius: 4px; overflow: hidden; display: block; }\n                .activity-poster-wrapper img { width: 100%; height: 100%; object-fit: cover; }\n\n                .activity-meta-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; }\n                .activity-review-content { background: #111; padding: 15px; border-radius: 6px; color: #ccc; font-size: 0.95rem; line-height: 1.5; margin-top: 10px; position: relative; }\n                .activity-review-content::before { content: ''; position: absolute; left: -6px; top: 15px; width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-right: 6px solid #111; }\n\n                .pfp-full-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 5000; display: flex; align-items: center; justify-content: center; }\n                .pfp-full-img-container { width: 280px; height: 280px; border-radius: 50%; overflow: hidden; border: 5px solid var(--accent-color); }\n\n                /* Watchlist Grid Default (Desktop) */\n                .watchlist-grid {\n                    display: grid;\n                    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));\n                    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));\n                    gap: 10px;\n                }\n\n                @media (max-width: 768px) {\n                    .profile-wrapper { width: 95% !important; padding: 1rem !important; }\n\n                    /* Mobile Header Grid - 3 Rows */\n                    .collapsible-header-content {\n                        display: grid;\n                        grid-template-columns: auto 1fr;\n                        column-gap: 15px;\n                        row-gap: 10px; /* Gap between rows */\n                        max-height: 1000px; /* Allow expansion */\n                    }\n\n                    /* 1. Avatar (Top Left) */\n                    .profile-avatar-area {\n                        grid-column: 1;\n                        grid-row: 1;\n                        width: 90px;\n                        margin-bottom: 0;\n                    }\n\n                    /* Flatten details area to allow children to be grid items */\n                    .profile-details-area { display: contents; }\n\n                    /* 2. Name & Follow Button (Top Right) */\n                    .user-info-row {\n                        grid-column: 2;\n                        grid-row: 1;\n                        align-self: center;\n                        gap: 10px !important;\n                    }\n\n                    /* 3. Stats (Row 2 - Full Width - Space Below) */\n                    .stats-container {\n                        grid-column: 1 / -1;\n                        grid-row: 2;\n                        width: 100%;\n                        display: grid;\n                        grid-template-columns: repeat(3, 1fr); /* Adjusted to 3 cols */\n                        justify-items: center;\n                        align-items: center;\n                        margin-top: 10px;\n                        margin-bottom: 10px; /* Space before Bio/Tabs */\n                        padding: 5px 0;\n                        background: rgba(255,255,255,0.05); /* Subtle separation */\n                        border-radius: 8px;\n                    }\n\n                    /* 4. Bio (Row 3 - Full Width) */\n                    .profile-bio {\n                        grid-column: 1 / -1;\n                        grid-row: 3;\n                        margin-top: 5px;\n                        text-align: center; /* Center bio on mobile */\n                    }\n\n                    .profile-username { font-size: 1.5rem; }\n\n\n                    .activity-poster-wrapper { width: 80px; }\n                    .activity-title { font-size: 1rem; }\n\n                    .favorites-grid { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 20px; scroll-interval: 150px; }\n                    .favorite-box { width: 110px; }\n                    .pfp-full-img-container { width: 70vw !important; height: 70vw !important; max-width: 300px !important; max-height: 300px !important; }\n\n                    /* Watchlist Grid - 3 Columns on Mobile for better view */\n                    .watchlist-grid {\n                        grid-template-columns: repeat(3, 1fr);\n                        gap: 8px;\n                    }\n\n                    .profile-actions-animated { top: 10px; right: 0; }\n                }\n\n                /* BASKET MODAL STYLES */\n                .basket-modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 6000; display: flex; alignItems: center; justifyContent: center; }\n                .basket-modal-content { background: #111; border: 1px solid #333; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; border-radius: 8px; padding: 20px; position: relative; }\n                .basket-header { font-size: 1.5rem; fontWeight: 900; color: #fff; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }\n                .basket-list { display: flex; flex-direction: column; gap: 10px; }\n                .basket-item { display: flex; gap: 15px; align-items: center; background: #000; padding: 10px; border: 1px solid #333; border-radius: 0px; } /* Pure Black & Square */\n                .basket-img-wrapper { width: 60px; height: 60px; border: 1px solid #333; position: relative; display: flex; alignItems: center; justifyContent: center; flex-shrink: 0; background: #222; overflow: hidden; }\n                .basket-img-wrapper img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }\n                .remove-watchlist-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: transparent; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }\n                .basket-info-col { display: flex; flex-direction: column; justify-content: center; }\n                .ep-title { font-weight: 900; color: #fff; font-size: 1rem; line-height: 1.2; }\n                `}\n                </style>\n\n                {editImageSrc && <ImageCropper imageSrc={editImageSrc} onCancel={() => setEditImageSrc(null)} onSave={handleSaveCropped} />}\n                {showFullPFP && profilePhoto && (\n                    <div className=\"pfp-full-modal\" onClick={() => setShowFullPFP(false)}>\n                        <div className=\"pfp-full-img-container\" onClick={e => e.stopPropagation()}>\n                            <img src={profilePhoto} alt=\"Full Profile\" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />\n                        </div>\n                        <button style={{ position: 'absolute', top: 20, right: 20, background: 'transparent', color: '#fff', border: 'none', fontSize: '2rem' }}><MdClose /></button>\n                    </div>\n                )}\n\n                {/* BASKET MODAL */}\n                {basketModalData && (\n                    <div className=\"basket-modal-overlay\" onClick={() => setBasketModalData(null)}>\n                        <div className=\"basket-modal-content\" onClick={e => e.stopPropagation()}>\n                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>\n                                <div className=\"basket-header\" style={{ marginBottom: 0 }}>SEASON {basketModalData.seasonNumber}</div>\n                                <button onClick={() => setBasketModalData(null)} style={{ background: 'transparent', border: 'none', color: '#888', fontSize: '1.5rem', cursor: 'pointer' }}><MdClose /></button>\n                            </div>\n\n                            <div className=\"basket-list\">\n                                {basketModalData.episodes.map(ep => {\n                                    let cleanTitle = ep.name;\n                                    if (cleanTitle.includes(': ')) cleanTitle = cleanTitle.split(': ').pop();\n                                    return (\n                                        <div key={ep.id} className=\"basket-item\">\n                                            <div className=\"basket-img-wrapper\">\n                                                <img src={`https://image.tmdb.org/t/p/w200${ep.still_path || ep.poster_path}`} alt=\"Ep\" />\n                                                <button className=\"remove-watchlist-btn\" onClick={() => handleRemoveFromWatchlist(ep)}>\n                                                    <MdCheck color=\"var(--accent-color)\" />\n                                                </button>\n                                            </div>\n                                            <div className=\"basket-info-col\">\n                                                <div className=\"ep-title\">{cleanTitle}</div>\n                                            </div>\n                                        </div>\n                                    );\n                                })}\n                            </div>\n                        </div>\n                    </div>\n                )}\n\n                <div className=\"profile-header-grid\" style={{ minHeight: isCollapsed ? '0px' : 'auto' }}>\n                    <div className={`collapsible-header-content ${isCollapsed ? 'collapsed' : ''}`}>\n                        <div className=\"profile-avatar-area\">\n                            <div onClick={() => setShowFullPFP(true)} style={{ width: '100%', aspectRatio: '1/1', borderRadius: '50%', overflow: 'hidden', border: '2px solid var(--accent-color)', background: 'var(--bg-tertiary)', cursor: 'pointer' }}>\n                                {profilePhoto ? <img src={profilePhoto} alt=\"Profile\" style={{ width: '100%', height: '100%', objectFit: 'cover' }} /> : <div style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '2rem', color: '#555' }}>{user.username ? user.username[0].toUpperCase() : 'U'}</div>}\n                            </div>\n                            <div className=\"social-icons\">\n                                {user.instaLink && <a href={user.instaLink} target=\"_blank\" rel=\"noopener noreferrer\" className=\"social-icon-link\"><FaInstagram /></a>}\n                                {user.twitterLink && <a href={user.twitterLink} target=\"_blank\" rel=\"noopener noreferrer\" className=\"social-icon-link\"><FaTwitter /></a>}\n                                {!user.instaLink && !user.twitterLink && <div style={{ display: 'flex', gap: 10 }}><FaInstagram className=\"social-icon-link\" /><FaTwitter className=\"social-icon-link\" /></div>}\n                            </div>\n                        </div>\n                        <div className=\"profile-details-area\">\n                            <div className=\"user-info-row\" style={{ display: 'flex', alignItems: 'center', gap: '20px', flexWrap: 'wrap' }}>\n                                <h1 className=\"profile-username\">{user.username || 'User'}</h1>\n                                {!isOwnProfile && (\n                                    <button\n                                        onClick={handleFollowToggle}\n                                        className={`follow-btn ${isFollowing ? 'following' : 'not-following'}`}\n                                        style={{ fontSize: '0.8rem', padding: '6px 16px' }}\n                                    >\n                                        {isFollowing ? 'UNFOLLOW' : 'FOLLOW'}\n                                    </button>\n                                )}\n                            </div>\n\n                            <div className=\"stats-container\">\n                                <div className=\"stats-div\" style={{ textAlign: 'center' }}><div className=\"stats-number\">{stats.thisYear}</div><div className=\"stats-label\">THIS YEAR</div></div>\n                                <Link to={`/profile/${targetUid}/followers`} className=\"stats-div\" style={{ textAlign: 'center', textDecoration: 'none', cursor: 'pointer' }}>\n                                    <div className=\"stats-number\">{stats.followers}</div>\n                                    <div className=\"stats-label\">FOLLOWERS</div>\n                                </Link>\n                                <Link to={`/profile/${targetUid}/following`} className=\"stats-div\" style={{ textAlign: 'center', textDecoration: 'none', cursor: 'pointer' }}>\n                                    <div className=\"stats-number\">{stats.following}</div>\n                                    <div className=\"stats-label\">FOLLOWING</div>\n                                </Link>\n                            </div>\n                            <style>{`\n                            @media (max-width: 768px) {\n                                .stats-label { font-size: 0.55rem !important; letter-spacing: 0px !important; }\n                                .stats-number { font-size: 1rem !important; }\n                            }\n                        `}</style>\n                            {user.bio && <div className=\"profile-bio\">{user.bio}</div>}\n                        </div>\n                    </div>\n                    {isOwnProfile && (\n                        <div className={`profile-actions-animated ${isCollapsed ? 'collapsed-menu' : ''}`} ref={menuRef}>\n                            <button onClick={() => setShowMenu(!showMenu)} style={{ background: 'transparent', border: 'none', color: 'var(--text-primary)', cursor: 'pointer', fontSize: '1.5rem', padding: '5px' }}><MdMoreVert /></button>\n                            {showMenu && (\n                                <div className=\"menu-dropdown\">\n                                    <label className=\"menu-item\" style={{ cursor: 'pointer' }}>Edit Profile PFP<input type=\"file\" hidden onChange={handleFileSelect} accept=\"image/*\" /></label>\n                                    <button className=\"menu-item\" onClick={() => navigate('/edit-profile')}>Edit Profile Details</button>\n                                    <button className=\"menu-item\" onClick={() => navigate('/settings')}>Settings</button>\n                                </div>\n                            )}\n                        </div>\n                    )}\n                </div>\n\n                <nav className=\"nav-scroll-container\">\n                    {['Profile', 'Diary', 'Activity', 'Watchlist', 'Liked'].map(tab => (\n                        <button key={tab} onClick={() => setActiveTab(tab)} className=\"nav-tab-btn\" style={{ position: 'relative', color: activeTab === tab ? '#FFFFFF' : 'var(--text-muted)', fontWeight: activeTab === tab ? 'bold' : 'normal', borderBottom: activeTab === tab ? '3px solid var(--accent-color)' : '3px solid transparent' }}>\n                            {tab}\n                            {tab === 'Diary' && <MobileIndicator id=\"diary-tab-tip\" message=\"Your watch history ðŸ“–\" position=\"bottom\" />}\n                        </button>\n                    ))}\n                </nav>\n\n                <main style={{ minHeight: '400px' }}>{renderTabContent()}</main>\n            </div>\n\n            {/* Modals */}\n            {editImageSrc && <ImageCropper imageSrc={editImageSrc} onCancel={() => setEditImageSrc(null)} onSave={handleSaveCropped} />}\n            {showFullPFP && <div className=\"full-pfp-modal\" onClick={() => setShowFullPFP(false)}><img src={profilePhoto} alt=\"Full PFP\" /></div>}\n\n            {/* Banner Modals */}\n            {showBannerSearch && (\n                <BannerSearch\n                    onClose={() => setShowBannerSearch(false)}\n                    onSelectSeries={handleSeriesForBanner}\n                />\n            )}\n            {showBannerSelection && selectedBannerSeries && (\n                <BannerSelection\n                    series={selectedBannerSeries}\n                    onClose={() => setShowBannerSelection(false)}\n                    onBack={() => { setShowBannerSelection(false); setShowBannerSearch(true); }}\n                />\n            )}\n            {showBannerView && user.bannerBackdropPath && (\n                <BannerViewModal\n                    src={`https://image.tmdb.org/t/p/original${user.bannerBackdropPath}`}\n                    onClose={() => setShowBannerView(false)}\n                />\n            )}\n            {showBannerAction && (\n                <BannerActionModal\n                    onClose={() => setShowBannerAction(false)}\n                    onSearch={() => { setShowBannerAction(false); setShowBannerSearch(true); }}\n                    lastUpdated={user.bannerUpdatedAt}\n                />\n            )}\n\n\n        </div >\n    );\n};\n\nexport default Profile;\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Search.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'starSeriesIds' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":31,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"starSeriesIds"},"fix":{"range":[1169,1182],"text":""},"desc":"Remove unused variable 'starSeriesIds'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":44,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":19},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`fetchSearch` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  57 |     useEffect(() => {\n  58 |         if (query) {\n> 59 |             fetchSearch();\n     |             ^^^^^^^^^^^ `fetchSearch` accessed before it is declared\n  60 |             addToRecent(query);\n  61 |         } else {\n  62 |             setResults([]);\n\n   88 |     };\n   89 |\n>  90 |     const fetchSearch = async () => {\n      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  91 |         setLoading(true);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^\n>  92 |         setGenreSearchData(null);\n      â€¦\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 135 |         }\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 136 |     };\n      | ^^^^^^^ `fetchSearch` is declared here\n  137 |\n  138 |     const fetchRelatedSeries = async (topItem) => {\n  139 |         if (!topItem || !topItem.genre_ids) return;","line":59,"column":13,"nodeType":null,"endLine":59,"endColumn":24},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`addToRecent` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  58 |         if (query) {\n  59 |             fetchSearch();\n> 60 |             addToRecent(query);\n     |             ^^^^^^^^^^^ `addToRecent` accessed before it is declared\n  61 |         } else {\n  62 |             setResults([]);\n  63 |         }\n\n  64 |     }, [query, storageKey]);\n  65 |\n> 66 |     const addToRecent = (term) => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 67 |         let recents = JSON.parse(localStorage.getItem(storageKey) || '[]');\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 68 |         if (!recents.includes(term)) {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 69 |             recents = [term, ...recents].slice(0, 5); // Keep last 5\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 70 |             localStorage.setItem(storageKey, JSON.stringify(recents));\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 71 |             setRecentSearches(recents);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 72 |         }\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 73 |     };\n     | ^^^^^^^ `addToRecent` is declared here\n  74 |\n  75 |     const [genreSearchData, setGenreSearchData] = useState(null); // { trending: [], underrated: [], genreName: '' }\n  76 |     // Related Series State","line":60,"column":13,"nodeType":null,"endLine":60,"endColumn":24},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'addToRecent' and 'fetchSearch'. Either include them or remove the dependency array.","line":64,"column":8,"nodeType":"ArrayExpression","endLine":64,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [addToRecent, fetchSearch, query, storageKey]","fix":{"range":[2333,2352],"text":"[addToRecent, fetchSearch, query, storageKey]"}}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { useLocation, Link, useNavigate } from 'react-router-dom';\r\nimport { MdHistory, MdCheck } from 'react-icons/md';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { db } from '../firebase-config';\r\nimport { doc, updateDoc } from 'firebase/firestore';\r\nimport { getResolvedPosterUrl } from '../utils/globalPosterResolver';\r\n\r\nimport './Home.css';\r\nimport './Search.css';\r\nimport PremiumLoader from '../components/PremiumLoader';\r\n\r\nconst Search = () => {\r\n    const location = useLocation();\r\n    const navigate = useNavigate();\r\n    const query = new URLSearchParams(location.search).get('q');\r\n\r\n    // Selection Mode Params\r\n    const selectForFavorite = location.state?.selectForFavorite;\r\n    const slotIndex = location.state?.slotIndex;\r\n\r\n    const [results, setResults] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Recent Searches\r\n    const [recentSearches, setRecentSearches] = useState([]);\r\n\r\n    // Success Animation State\r\n    const [showSuccess, setShowSuccess] = useState(false);\r\n    const [duplicateAlert, setDuplicateAlert] = useState(false);\r\n    const [starSeriesIds, setStarSeriesIds] = useState(new Set());\r\n\r\n    const TMDB_API_KEY = import.meta.env.VITE_TMDB_API_KEY || '05587a49bd4890a9630d6c0e544e0f6f'; // Fallback if env not loaded\r\n    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';\r\n\r\n    // Auth for unique storage\r\n    const { currentUser, userData, globalPosters } = useAuth();\r\n    const storageKey = currentUser ? `recentSearches_${currentUser.uid}` : 'recentSearches_guest';\r\n\r\n    useEffect(() => {\r\n        try {\r\n            const savedRecents = JSON.parse(localStorage.getItem(storageKey) || '[]');\r\n            setRecentSearches(Array.isArray(savedRecents) ? savedRecents : []);\r\n        } catch (e) {\r\n            setRecentSearches([]);\r\n        }\r\n    }, [currentUser, storageKey]);\r\n\r\n    useEffect(() => {\r\n        if (userData?.starSeries) {\r\n            setStarSeriesIds(new Set(userData.starSeries.map(s => s.id)));\r\n        } else {\r\n            setStarSeriesIds(new Set());\r\n        }\r\n    }, [userData]);\r\n\r\n    useEffect(() => {\r\n        if (query) {\r\n            fetchSearch();\r\n            addToRecent(query);\r\n        } else {\r\n            setResults([]);\r\n        }\r\n    }, [query, storageKey]);\r\n\r\n    const addToRecent = (term) => {\r\n        let recents = JSON.parse(localStorage.getItem(storageKey) || '[]');\r\n        if (!recents.includes(term)) {\r\n            recents = [term, ...recents].slice(0, 5); // Keep last 5\r\n            localStorage.setItem(storageKey, JSON.stringify(recents));\r\n            setRecentSearches(recents);\r\n        }\r\n    };\r\n\r\n    const [genreSearchData, setGenreSearchData] = useState(null); // { trending: [], underrated: [], genreName: '' }\r\n    // Related Series State\r\n    const [relatedSeries, setRelatedSeries] = useState([]);\r\n\r\n    const GENRES_MAP = {\r\n        'action': 10759, 'adventure': 10759,\r\n        'animation': 16, 'comedy': 35, 'crime': 80,\r\n        'documentary': 99, 'drama': 18, 'family': 10751,\r\n        'kids': 10762, 'mystery': 9648, 'news': 10763,\r\n        'reality': 10764,\r\n        'scifi': 10765, 'sci-fi': 10765, 'fantasy': 10765,\r\n        'soap': 10766, 'talk': 10767, 'war': 10768, 'western': 37,\r\n        'horror': 27, 'thriller': 9648\r\n    };\r\n\r\n    const fetchSearch = async () => {\r\n        setLoading(true);\r\n        setGenreSearchData(null);\r\n        setResults([]);\r\n        setRelatedSeries([]); // Reset\r\n\r\n        const lowerQ = query.toLowerCase().trim();\r\n        const genreId = GENRES_MAP[lowerQ];\r\n\r\n        try {\r\n            let currentResults = [];\r\n            if (genreId) {\r\n                // Genre Search\r\n                const [trending, underrated] = await Promise.all([\r\n                    fetch(`${TMDB_BASE_URL}/discover/tv?api_key=${TMDB_API_KEY}&with_genres=${genreId}&sort_by=popularity.desc`).then(r => r.json()),\r\n                    fetch(`${TMDB_BASE_URL}/discover/tv?api_key=${TMDB_API_KEY}&with_genres=${genreId}&sort_by=vote_average.desc&vote_count.gte=200`).then(r => r.json())\r\n                ]);\r\n                setGenreSearchData({\r\n                    genreName: lowerQ.toUpperCase(),\r\n                    trending: trending.results || [],\r\n                    underrated: underrated.results || []\r\n                });\r\n                // For genre search, we don't have a single \"Top Result\" in the same way, but let's assume standard behavior for now across search types if needed.\r\n                // But Prompt specifically implies \"Top Result\" from search results. \r\n                // If genre search, `results` stays empty in current logic? \r\n                // The current logic sets `results` only in \"Normal Search\".\r\n                // Let's stick to modifying the Normal Search flow mostly, or unify if needed.\r\n                // The Prompt says \"When screen width is mobile... Top Result card...\".\r\n                // Logic below handles \"Normal Search\" results.\r\n            } else {\r\n                // Normal Search\r\n                const response = await fetch(`${TMDB_BASE_URL}/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);\r\n                const data = await response.json();\r\n                currentResults = data.results || [];\r\n                setResults(currentResults);\r\n\r\n                // Fetch Related Series if we have a top result\r\n                if (currentResults.length > 0) {\r\n                    await fetchRelatedSeries(currentResults[0]);\r\n                }\r\n            }\r\n            setLoading(false);\r\n        } catch (error) {\r\n            console.error(\"Search failed\", error);\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const fetchRelatedSeries = async (topItem) => {\r\n        if (!topItem || !topItem.genre_ids) return;\r\n\r\n        try {\r\n            // Logic: \r\n            // 1. Genre IDs\r\n            let genreIds = topItem.genre_ids;\r\n            let sortBy = 'popularity.desc';\r\n\r\n            // Mood Filtering Logic\r\n            // Animation -> Animation Only\r\n            if (genreIds.includes(16)) {\r\n                genreIds = [16];\r\n            }\r\n\r\n            // High Rating (> 8) -> Serious Tone (? Use Rating Sort)\r\n            // Serious/Drama logic could be implied by rating sort.\r\n            if (topItem.vote_average >= 8) {\r\n                sortBy = 'vote_average.desc';\r\n            }\r\n\r\n            // Comedy -> Light Tone (Usually just Comedy genre is enough)\r\n\r\n            const genreQuery = genreIds.join(',');\r\n\r\n            const url = `${TMDB_BASE_URL}/discover/tv?api_key=${TMDB_API_KEY}&with_genres=${genreQuery}&sort_by=${sortBy}&vote_count.gte=100`;\r\n\r\n            const res = await fetch(url);\r\n            const data = await res.json();\r\n\r\n            if (data.results) {\r\n                // Filter out the top result\r\n                const filtered = data.results\r\n                    .filter(item => item.id !== topItem.id)\r\n                    .slice(0, 12); // Limit to 12\r\n                setRelatedSeries(filtered);\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Failed to fetch related\", e);\r\n        }\r\n    };\r\n\r\n    // const { currentUser } = useAuth(); // Moved up\r\n\r\n    const handleSeriesClick = async (e, item) => {\r\n        if (selectForFavorite) {\r\n            e.preventDefault();\r\n\r\n            if (!currentUser || !userData) return;\r\n\r\n            try {\r\n                // Use userData directly to save a read\r\n                const userRef = doc(db, 'users', currentUser.uid);\r\n                let currentFavs = userData.favorites || [null, null, null, null, null];\r\n\r\n                // Duplicate Check\r\n                const isDuplicate = currentFavs.some((fav, idx) => fav && fav.id === item.id && idx !== slotIndex);\r\n                if (isDuplicate) {\r\n                    setDuplicateAlert(true);\r\n                    setTimeout(() => setDuplicateAlert(false), 2000);\r\n                    return; // Stop processing\r\n                }\r\n\r\n                // Animation Trigger (Only if not duplicate)\r\n                setShowSuccess(true);\r\n\r\n                // Ensure standard length\r\n                if (currentFavs.length < 5) {\r\n                    currentFavs = [...currentFavs, ...Array(5 - currentFavs.length).fill(null)];\r\n                }\r\n\r\n                // Update specific slot\r\n                const newFavs = [...currentFavs];\r\n                newFavs[slotIndex] = item;\r\n\r\n                // Save back\r\n                await updateDoc(userRef, { favorites: newFavs });\r\n            } catch (err) {\r\n                console.error(\"Failed to save favorite\", err);\r\n            }\r\n\r\n            // Delay for Animation then Redirect\r\n            setTimeout(() => {\r\n                navigate('/profile');\r\n            }, 2000); // 2s delay\r\n        }\r\n    };\r\n\r\n    // Logic for Tiers\r\n    const topResult = results.length > 0 ? results[0] : null;\r\n\r\n    // Filter \"Exact Matches\" - loosely matches title or heavily related.\r\n    // Logic: Same words, excluding Top Result.\r\n    // Actually TMDB returns sorted by relevance. Let's just take next 5 as \"Close Matches\"\r\n    const exactMatches = results.length > 1\r\n        ? results.slice(1, 7) // Take 2nd to 7th items\r\n        : [];\r\n\r\n    // \"Related Discovery\" REPLACED by relatedSeries state\r\n\r\n    return (\r\n        <div className=\"section\" style={{ position: 'relative', minHeight: '100vh', background: '#000' }}>\r\n            {/* Background pure black enforced inline just in case */}\r\n            {showSuccess && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',\r\n                    background: 'rgba(0,0,0,0.8)', zIndex: 2000,\r\n                    display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',\r\n                    animation: 'fadeIn 0.3s ease-out'\r\n                }}>\r\n                    <div style={{\r\n                        width: '100px', height: '100px', borderRadius: '50%', background: '#fff',\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '20px',\r\n                        animation: 'popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)'\r\n                    }}>\r\n                        <MdCheck size={60} color=\"#000\" />\r\n                    </div>\r\n                    <h2 style={{ color: '#fff', fontSize: '1.5rem', fontWeight: 'bold' }}>Added to Favorites</h2>\r\n                </div>\r\n            )}\r\n            {duplicateAlert && (\r\n                <div style={{\r\n                    position: 'fixed', top: '100px', left: '50%', transform: 'translateX(-50%)',\r\n                    background: '#ff4444', color: 'white', padding: '15px 30px', borderRadius: '8px',\r\n                    zIndex: 2100, fontWeight: 'bold', boxShadow: '0 5px 20px rgba(0,0,0,0.3)',\r\n                    animation: 'fadeIn 0.2s ease-out', display: 'flex', alignItems: 'center', gap: '10px'\r\n                }}>\r\n                    <span>âš ï¸ This series is already in your favorites!</span>\r\n                </div>\r\n            )}\r\n\r\n            {!query ? (\r\n                // RECENT SEARCHES UI (Unchanged Layout, just ensured wrapper)\r\n                <div style={{ maxWidth: '600px', margin: '40px auto', padding: '0 20px' }}>\r\n                    <h3 style={{ color: '#666', marginBottom: '1rem', fontSize: '0.9rem', letterSpacing: '1px' }}>RECENT SEARCHES</h3>\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n                        {recentSearches.length > 0 ? recentSearches.map((term, i) => (\r\n                            <Link key={i} to={`/search?q=${encodeURIComponent(term)}`} style={{ display: 'flex', alignItems: 'center', gap: '10px', color: '#ccc', textDecoration: 'none', padding: '15px', background: '#111', border: '1px solid #222', borderRadius: '4px' }}>\r\n                                <MdHistory color=\"#666\" />\r\n                                {term}\r\n                            </Link>\r\n                        )) : (\r\n                            <div style={{ color: '#444', fontStyle: 'italic' }}>No recent searches</div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            ) : (\r\n                <div className=\"search-results-container\">\r\n                    {loading ? (\r\n                        <div style={{ position: 'relative', height: '400px' }}><PremiumLoader message=\"Searching series...\" /></div>\r\n                    ) : results.length === 0 && !genreSearchData ? (\r\n                        <div style={{ textAlign: 'center', marginTop: '100px', color: '#FFD600' }}>\r\n                            <h2 style={{ color: '#FFD600' }}>No results for \"{query}\"</h2>\r\n                            <p>Try searching for specific series like \"Breaking Bad\" or \"The Office\"</p>\r\n                        </div>\r\n                    ) : (\r\n                        <>\r\n                            {/* TIER 1: TOP RESULT */}\r\n                            {topResult && (\r\n                                <div className=\"search-tier-top\">\r\n                                    <div className=\"top-result-card\" onClick={(e) => handleSeriesClick(e, topResult)}>\r\n                                        <Link to={selectForFavorite ? '#' : `/tv/${topResult.id}`} style={{ display: 'flex', width: '100%', textDecoration: 'none', color: 'inherit' }}>\r\n                                            <div className=\"top-poster-wrapper\">\r\n\r\n                                                <img\r\n                                                    className=\"top-poster\"\r\n                                                    src={getResolvedPosterUrl(topResult.id, topResult.poster_path, globalPosters, 'w780')\r\n                                                        || 'https://via.placeholder.com/300x450'}\r\n                                                    alt={topResult.name}\r\n                                                />\r\n                                            </div>\r\n                                            <div className=\"top-info\">\r\n                                                <div className=\"top-label\">Top Result</div>\r\n                                                <h1 className=\"top-title\">{topResult.name}</h1>\r\n                                                <div className=\"top-meta\">\r\n                                                    <span>{topResult.first_air_date ? topResult.first_air_date.substring(0, 4) : 'Unknown'}</span>\r\n                                                    <span>â€¢</span>\r\n                                                    <span>{topResult.vote_average ? `${topResult.vote_average.toFixed(1)} Rating` : 'Mixed'}</span>\r\n                                                </div>\r\n                                                <div className=\"view-btn\">View Details</div>\r\n                                            </div>\r\n                                        </Link>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* TIER 2: EXACT MATCHES */}\r\n                            {exactMatches.length > 0 && (\r\n                                <div className=\"search-tier-section\">\r\n                                    <h3 className=\"tier-title\">More Matches</h3>\r\n                                    <div className=\"tier-row\">\r\n                                        {exactMatches.map(item => (\r\n                                            <div key={item.id} className=\"search-card\" onClick={(e) => handleSeriesClick(e, item)}>\r\n                                                <Link to={selectForFavorite ? '#' : `/tv/${item.id}`} style={{ display: 'block' }}>\r\n\r\n                                                    <img\r\n                                                        className=\"search-poster\"\r\n                                                        src={getResolvedPosterUrl(item.id, item.poster_path, globalPosters, 'w500')\r\n                                                            || 'https://via.placeholder.com/200x300'}\r\n                                                        alt={item.name}\r\n                                                    />\r\n                                                </Link>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* TIER 3: RELATED SERIES (Replacing Related Discovery) */}\r\n                            {relatedSeries.length > 0 && (\r\n                                <div className=\"search-tier-section\">\r\n                                    <h3 className=\"tier-title\">Related Series</h3>\r\n                                    <div className=\"tier-row\">\r\n                                        {relatedSeries.map(item => (\r\n                                            <div key={item.id} className=\"search-card\" onClick={(e) => handleSeriesClick(e, item)}>\r\n                                                <Link to={selectForFavorite ? '#' : `/tv/${item.id}`} style={{ display: 'block' }}>\r\n\r\n                                                    <img\r\n                                                        className=\"search-poster\"\r\n                                                        src={getResolvedPosterUrl(item.id, item.poster_path, globalPosters, 'w500')\r\n                                                            || 'https://via.placeholder.com/200x300'}\r\n                                                        alt={item.name}\r\n                                                    />\r\n                                                </Link>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Search;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\SeriesDetails.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[290,298],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'seasonProgress' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":17,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"seasonProgress"},"fix":{"range":[753,767],"text":""},"desc":"Remove unused variable 'seasonProgress'."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`fetchSeriesData` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  27 |\n  28 |   useEffect(() => {\n> 29 |     fetchSeriesData();\n     |     ^^^^^^^^^^^^^^^ `fetchSeriesData` accessed before it is declared\n  30 |   }, [id]);\n  31 |\n  32 |   const fetchSeriesData = async () => {\n\n  30 |   }, [id]);\n  31 |\n> 32 |   const fetchSeriesData = async () => {\n     |   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 33 |     try {\n     | ^^^^^^^^^\n> 34 |       const response = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}`);\n     | ^^^^^^^^^\n> 35 |       const data = await response.json();\n     | ^^^^^^^^^\n> 36 |       setSeries(data);\n     | ^^^^^^^^^\n> 37 |       setSeasons(data.seasons || []);\n     | ^^^^^^^^^\n> 38 |     } catch (error) {\n     | ^^^^^^^^^\n> 39 |       console.error('Error fetching series:', error);\n     | ^^^^^^^^^\n> 40 |     }\n     | ^^^^^^^^^\n> 41 |   };\n     | ^^^^^ `fetchSeriesData` is declared here\n  42 |\n  43 |   // Helper: Check if season is complete based on Firestore watched data\n  44 |   const isSeasonComplete = (seasonNumber, episodeCount) => {","line":29,"column":5,"nodeType":null,"endLine":29,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchSeriesData'. Either include it or remove the dependency array.","line":30,"column":6,"nodeType":"ArrayExpression","endLine":30,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [fetchSeriesData, id]","fix":{"range":[1219,1223],"text":"[fetchSeriesData, id]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'episodeCount' is defined but never used.","line":72,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":66,"suggestions":[{"messageId":"removeVar","data":{"varName":"episodeCount"},"fix":{"range":[2840,2854],"text":""},"desc":"Remove unused variable 'episodeCount'."}]},{"ruleId":"no-undef","severity":2,"message":"'progress' is not defined.","line":389,"column":26,"nodeType":"Identifier","messageId":"undef","endLine":389,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'progress' is not defined.","line":393,"column":45,"nodeType":"Identifier","messageId":"undef","endLine":393,"endColumn":53}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react';\nimport { useParams, useNavigate, Link } from 'react-router-dom';\nimport { MdEdit, MdStar, MdStarBorder, MdCelebration, MdMovie } from 'react-icons/md';\nimport { useAuth } from '../context/AuthContext';\nimport { doc, updateDoc, arrayUnion, getDoc } from 'firebase/firestore';\nimport { db } from '../firebase-config';\nimport { getResolvedPosterUrl } from '../utils/globalPosterResolver';\nimport { logActivity } from '../utils/activityLogger';\n\nconst SeriesDetails = () => {\n  const { id } = useParams();\n  const navigate = useNavigate();\n  const { currentUser, userData, globalPosters } = useAuth();\n\n  const [series, setSeries] = useState(null);\n  const [seasons, setSeasons] = useState([]);\n  const [seasonProgress, setSeasonProgress] = useState({});\n  const [popupVisible, setPopupVisible] = useState(false);\n  const [limitPopupVisible, setLimitPopupVisible] = useState(false);\n  const [completedSeason, setCompletedSeason] = useState(null);\n  const [showEditHint, setShowEditHint] = useState({});\n\n  // Refs for scrolling\n  const seasonRefs = useRef({});\n\n  const TMDB_API_KEY = '05587a49bd4890a9630d6c0e544e0f6f';\n\n  useEffect(() => {\n    fetchSeriesData();\n  }, [id]);\n\n  const fetchSeriesData = async () => {\n    try {\n      const response = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}`);\n      const data = await response.json();\n      setSeries(data);\n      setSeasons(data.seasons || []);\n    } catch (error) {\n      console.error('Error fetching series:', error);\n    }\n  };\n\n  // Helper: Check if season is complete based on Firestore watched data\n  const isSeasonComplete = (seasonNumber, episodeCount) => {\n    if (!userData?.watched) return false;\n    const seasonEps = userData.watched.filter(w => (w.seriesId === Number(id) || w.id === Number(id)) && w.seasonNumber === seasonNumber);\n    // Simple check: if we have roughly the same number of watched eps as total eps\n    // Note: episode_count from TMDB might mismatch slightly with aired (specials), but this is standard logic.\n    return seasonEps.length >= episodeCount && episodeCount > 0;\n  };\n\n  // Helper: Active Daily Limit Check with Strict 24h Window\n  const checkDailyLimit = () => {\n    if (!userData?.lastPosterEditAt) return false; // Not locked\n    const lastEdit = new Date(userData.lastPosterEditAt);\n    const now = new Date();\n    const diffHours = (now - lastEdit) / (1000 * 60 * 60);\n    return diffHours < 24; // TRUE if locked (less than 24h passed)\n  };\n\n  const handleEditPosterClick = (e, seasonNumber) => {\n    e.preventDefault();\n    if (checkDailyLimit()) {\n      // Locked\n      setLimitPopupVisible(true);\n    } else {\n      // Allowed\n      navigate(`/tv/${id}/season/${seasonNumber}/poster`);\n    }\n  };\n\n  const completeSeasonHandler = async (seasonNumber, episodeCount) => {\n    if (!currentUser) return;\n\n    // 1. Fetch all episodes for this season to mark them watched\n    try {\n      const res = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${seasonNumber}?api_key=${TMDB_API_KEY}`);\n      const data = await res.json();\n      const episodes = data.episodes || [];\n\n      const userRef = doc(db, 'users', currentUser.uid);\n\n      // Prepare simplified watched objects\n      const newWatchedItems = episodes.map(ep => ({\n        seriesId: Number(id),\n        seasonNumber: Number(seasonNumber),\n        episodeNumber: ep.episode_number, // Episode-independent tracking\n        id: Number(id), // For legacy compatibility\n        date: new Date().toISOString()\n      }));\n\n      // Firestore ArrayUnion (Chunk if necessary, but usually ok for one season)\n      // We need to avoid duplicates strictly, arrayUnion handles exact object match.\n      // But dates differ. So better to read-modify-write or just rely on the fact that existing logic usage filters by id/season/ep.\n      // For simplicity provided \"watched\" is array of objects, arrayUnion only works if objects are identical.\n      // If dates differ, they are new objects.\n      // OPTIMIZATION: Filter out existing local watched items to avoid DB bloat?\n      // Let's assume standard arrayUnion is fine for now or do a quick client-side filter.\n\n      // BETTER: Just update specific fields? No, \"Mark Entire Season Watched\".\n      // Let's rewrite the 'watched' array client side and push whole.\n      // Actually, just add them.\n\n      // NOTE: The prompt says \"Track completion using existing watched-episode records only\".\n      // So I must push these episodes to 'watched'.\n\n      const currentWatched = userData.watched || [];\n      const toAdd = newWatchedItems.filter(nw =>\n        !currentWatched.some(cw =>\n          (cw.seriesId === Number(id) || cw.id === Number(id)) &&\n          cw.seasonNumber === seasonNumber &&\n          cw.episodeNumber === nw.episodeNumber\n        )\n      );\n\n      if (toAdd.length > 0) {\n        await updateDoc(userRef, {\n          watched: arrayUnion(...toAdd)\n        });\n      }\n\n      // Log Activity: Season Completed\n      // Logic: The user pressed 'Mark as Completed' for the season.\n      logActivity(\n        { ...currentUser, username: userData.username, photoURL: userData.profilePhoto },\n        'completed_season',\n        {\n          seriesId: Number(id),\n          seriesName: series.name,\n          seasonNumber: Number(seasonNumber),\n          posterPath: series.poster_path\n        }\n      );\n\n      setCompletedSeason(seasonNumber);\n      setPopupVisible(true);\n\n    } catch (e) {\n      console.error(\"Error completing season\", e);\n    }\n  };\n\n  const closePopup = () => {\n    setPopupVisible(false);\n\n    // Auto scroll and highlight after popup closes\n    // STRICT FIX: Check against 'completedSeason' state directly\n    if (completedSeason) {\n      setTimeout(() => {\n        const targetRef = seasonRefs.current[completedSeason];\n        if (targetRef) {\n          targetRef.scrollIntoView({ behavior: 'smooth', block: 'center' });\n\n          // Show edit hint and glow\n          setShowEditHint(prev => ({ ...prev, [completedSeason]: true }));\n\n          // Remove hint after 5 seconds\n          setTimeout(() => {\n            setShowEditHint(prev => ({ ...prev, [completedSeason]: false }));\n          }, 5000);\n        }\n      }, 100);\n    }\n  };\n\n  const rateSeason = async (seasonNumber, rating) => {\n    if (!currentUser) return;\n    try {\n      const userRef = doc(db, 'users', currentUser.uid);\n      const seasonKey = `${id}_${seasonNumber}`;\n\n      // Save rating to Firestore (using a map for simple lookup)\n      await updateDoc(userRef, {\n        [`seasonRatings.${seasonKey}`]: rating\n      });\n\n      // Log Activity: Season Rated\n      logActivity(\n        { ...currentUser, username: userData.username, photoURL: userData.profilePhoto },\n        'rated_season',\n        {\n          seriesId: Number(id),\n          seriesName: series.name,\n          seasonNumber: Number(seasonNumber),\n          rating: rating,\n          posterPath: series.poster_path\n        }\n      );\n\n      // Update local state to reflect rating immediately (optional but good for UI)\n      setSeasonProgress(prev => ({\n        ...prev,\n        [seasonNumber]: { ...prev[seasonNumber], rated: true, ratingValue: rating }\n      }));\n\n    } catch (e) {\n      console.error(\"Error rating season:\", e);\n    }\n  };\n\n  const getSeasonPoster = (season) => {\n    // GLOBAL FIX: Resolve from globalPosters > Fallback to TMDB\n    return getResolvedPosterUrl(id, season.poster_path, globalPosters, 'w500') || 'https://via.placeholder.com/300x450/141414/FFFF00?text=No+Image';\n  };\n\n  if (!series) return <div className=\"loading\">Loading...</div>;\n\n  return (\n    <div className=\"series-details\">\n      {/* Completion Popup (Premium Design) */}\n      {popupVisible && (\n        <div\n          className=\"popup-overlay\"\n          onClick={closePopup}\n          style={{\n            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\n            zIndex: 10000,\n            background: 'rgba(0,0,0,0.8)',\n            backdropFilter: 'blur(10px)',\n            display: 'flex', alignItems: 'center', justifyContent: 'center',\n            animation: 'fadeIn 0.3s ease'\n          }}\n        >\n          <div\n            onClick={(e) => e.stopPropagation()}\n            style={{\n              background: '#000000',\n              border: '1px solid #333',\n              borderRadius: '16px',\n              padding: '40px 30px',\n              width: '85%',\n              maxWidth: '320px',\n              textAlign: 'center',\n              boxShadow: '0 20px 60px rgba(0,0,0,0.9)',\n              animation: 'scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'\n            }}\n          >\n            <MdCelebration style={{ fontSize: '3rem', marginBottom: '15px', color: '#FFD600' }} />\n            <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fff', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '1px' }}>\n              Season Completed\n            </h2>\n            <p style={{ fontSize: '1rem', color: '#ccc', lineHeight: '1.5', marginBottom: '25px' }}>\n              You unlocked poster customization\n            </p>\n            <button\n              onClick={closePopup}\n              style={{\n                background: '#fff',\n                color: '#000',\n                border: 'none',\n                borderRadius: '8px',\n                padding: '12px 0',\n                fontSize: '1rem',\n                fontWeight: 'bold',\n                cursor: 'pointer',\n                width: '100%',\n                textTransform: 'uppercase',\n                transition: 'transform 0.1s'\n              }}\n              onMouseDown={e => e.currentTarget.style.transform = 'scale(0.96)'}\n              onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}\n            >\n              OK\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* Daily Limit Popup */}\n      {limitPopupVisible && (\n        <div style={{\n          position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,\n          zIndex: 10000,\n          background: 'rgba(0,0,0,0.8)',\n          backdropFilter: 'blur(8px)',\n          display: 'flex', alignItems: 'center', justifyContent: 'center',\n          animation: 'fadeIn 0.3s ease'\n        }}>\n          <div style={{\n            background: '#000000',\n            border: '1px solid #333',\n            borderRadius: '16px',\n            padding: '30px',\n            maxWidth: '90%',\n            width: '320px',\n            textAlign: 'center',\n            boxShadow: '0 20px 50px rgba(0,0,0,0.5)'\n          }}>\n            <MdMovie style={{ fontSize: '3rem', marginBottom: '15px', color: '#FFD600' }} />\n            <div style={{ fontSize: '1.2rem', lineHeight: '1.4', color: '#fff', marginBottom: '20px', fontWeight: 'bold' }}>\n              Take it slow\n            </div>\n            <p style={{ color: '#aaa', fontSize: '0.95rem', marginBottom: '25px' }}>\n              You can change one poster per day.\n            </p>\n            <button\n              onClick={() => setLimitPopupVisible(false)}\n              style={{\n                background: '#FFD600',\n                color: '#000',\n                border: 'none',\n                borderRadius: '8px',\n                padding: '12px 30px',\n                fontSize: '16px',\n                fontWeight: 'bold',\n                cursor: 'pointer',\n                width: '100%'\n              }}\n            >\n              OK\n            </button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"series-header\">\n        <h1>{series.name}</h1>\n        <p>{series.overview}</p>\n      </div>\n\n      <div className=\"seasons-grid\">\n        {seasons.map((season) => {\n          const isCompleted = isSeasonComplete(season.season_number, season.episode_count);\n          // Removed local rated check as it was tied to local storage\n          const isRated = false; // Simplified for now as rating logic wasn't fully refactored yet, or rely on userData.reviews/ratings if needed.\n          // For now, keeping isRated false or implementing a check from userData if needed.\n          // Prompt didn't explicitly ask to refactor Rating, but \"Do NOT change existing UI unless...\"\n          // I will leave isRated as false to avoid errors, or implement a quick check.\n          // Let's stick to simple removal of local storage error.\n          const showHint = showEditHint[season.season_number];\n\n          return (\n            <div key={season.season_number} className=\"season-card\">\n              <div\n                className=\"season-poster-container\"\n                ref={el => seasonRefs.current[season.season_number] = el}\n              >\n                <img\n                  src={getSeasonPoster(season)}\n                  alt={`Season ${season.season_number}`}\n                  className=\"season-poster\"\n                />\n\n                {/* Edit Poster Button - Only show if completed */}\n                {isCompleted && (\n                  <Link\n                    to=\"#\"\n                    onClick={(e) => handleEditPosterClick(e, season.season_number)}\n                    className={`edit-poster-btn ${showHint ? 'highlight' : ''}`}\n                    title=\"Edit Series Poster\"\n                    style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', textDecoration: 'none', cursor: 'pointer' }}\n                  >\n                    <MdEdit />\n                  </Link>\n                )}\n\n                {/* Edit Hint - \"You earned a poster customisation...\" */}\n                {showHint && (\n                  <div className=\"edit-hint incoming\">\n                    You earned a poster customisation for this season\n                  </div>\n                )}\n              </div>\n\n              <div className=\"season-info\">\n                <h3>Season {season.season_number}</h3>\n                <p>{season.episode_count} episodes</p>\n\n                {/* Complete Season Button */}\n                {!isCompleted && (\n                  <button\n                    className=\"complete-btn\"\n                    onClick={() => completeSeasonHandler(season.season_number, season.episode_count)}\n                  >\n                    Mark as Completed\n                  </button>\n                )}\n\n                {/* Rating Section - Per Season */}\n                <div className=\"rating-section\">\n                  <span>Rate this season:</span>\n                  <div className=\"stars\">\n                    {[1, 2, 3, 4, 5].map((star) => (\n                      <button\n                        key={star}\n                        onClick={() => rateSeason(season.season_number, star)}\n                        className=\"star-btn\"\n                      >\n                        {progress.ratingValue >= star ? <MdStar /> : <MdStarBorder />}\n                      </button>\n                    ))}\n                  </div>\n                  {isRated && <span>Rated: {progress.ratingValue}/5</span>}\n                </div>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n};\n\nexport default SeriesDetails;","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\SeriesGraph.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":14,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"navigate"},"fix":{"range":[619,650],"text":""},"desc":"Remove unused variable 'navigate'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchCompletedSeries'. Either include it or remove the dependency array.","line":32,"column":8,"nodeType":"ArrayExpression","endLine":32,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [currentUser, fetchCompletedSeries]","fix":{"range":[1305,1318],"text":"[currentUser, fetchCompletedSeries]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { supabase } from '../supabase-config';\r\nimport { tmdbApi } from '../utils/tmdbApi';\r\nimport { getResolvedPosterUrl } from '../utils/globalPosterResolver';\r\nimport PremiumLoader from '../components/PremiumLoader';\r\nimport html2canvas from 'html2canvas';\r\nimport { MdInsertChart, MdClose, MdShare } from 'react-icons/md';\r\nimport './SeriesGraph.css';\r\n\r\nconst SeriesGraph = () => {\r\n    const { currentUser, userData, globalPosters } = useAuth();\r\n    const navigate = useNavigate();\r\n    const [loading, setLoading] = useState(true);\r\n    const [completedSeries, setCompletedSeries] = useState([]);\r\n    const [selectedSeries, setSelectedSeries] = useState(null);\r\n    const [graphData, setGraphData] = useState(null);\r\n    const [showConfirm, setShowConfirm] = useState(false);\r\n    const [generating, setGenerating] = useState(false);\r\n    const [exportMode, setExportMode] = useState(false);\r\n    const [scale, setScale] = useState(1);\r\n\r\n    // Refs\r\n    const graphRef = useRef(null);\r\n    const wrapperRef = useRef(null);\r\n\r\n    useEffect(() => {\r\n        if (currentUser) {\r\n            fetchCompletedSeries();\r\n        }\r\n    }, [currentUser]);\r\n\r\n    // Robust Scaling Logic for Mobile Preview\r\n    useEffect(() => {\r\n        const handleResize = () => {\r\n            if (!graphData || exportMode) return;\r\n            const windowWidth = window.innerWidth;\r\n            const targetWidth = 1080; // Fixed Canvas Width\r\n            const padding = 30; // Margin\r\n\r\n            // Scale to fit 1080px canvas\r\n            let newScale = (windowWidth - padding) / targetWidth;\r\n            if (newScale > 0.65) newScale = 0.65; // Desktop cap\r\n\r\n            setScale(newScale);\r\n        };\r\n\r\n        window.addEventListener('resize', handleResize);\r\n        handleResize();\r\n\r\n        return () => window.removeEventListener('resize', handleResize);\r\n    }, [graphData, exportMode]);\r\n\r\n    const fetchCompletedSeries = async () => {\r\n        try {\r\n            setLoading(true);\r\n            const { data: watchedData, error: watchedError } = await supabase\r\n                .from('watched_episodes')\r\n                .select('tmdb_id, season_number, episode_number')\r\n                .eq('user_id', currentUser.uid);\r\n\r\n            if (watchedError) throw watchedError;\r\n\r\n            const seriesMap = {};\r\n            watchedData.forEach(item => {\r\n                if (!seriesMap[item.tmdb_id]) {\r\n                    seriesMap[item.tmdb_id] = { tmdb_id: item.tmdb_id, watched: [] };\r\n                }\r\n                seriesMap[item.tmdb_id].watched.push(item);\r\n            });\r\n\r\n            const completed = [];\r\n\r\n            for (const id of Object.keys(seriesMap)) {\r\n                try {\r\n                    const details = await tmdbApi.getSeriesDetails(id);\r\n                    const regularSeasons = details.seasons.filter(s => s.season_number > 0);\r\n\r\n                    let isAllCompleted = true;\r\n                    for (const season of regularSeasons) {\r\n                        const watchedInSeason = seriesMap[id].watched.filter(w => w.season_number === season.season_number);\r\n                        if (watchedInSeason.length < season.episode_count) {\r\n                            isAllCompleted = false;\r\n                            break;\r\n                        }\r\n                    }\r\n\r\n                    if (isAllCompleted && regularSeasons.length > 0) {\r\n                        const logos = details.images?.logos || [];\r\n                        const enLogo = logos.filter(l => l.iso_639_1 === 'en').sort((a, b) => b.vote_average - a.vote_average)[0]?.file_path\r\n                            || logos.filter(l => !l.iso_639_1).sort((a, b) => b.vote_average - a.vote_average)[0]?.file_path\r\n                            || logos[0]?.file_path;\r\n\r\n                        completed.push({\r\n                            id: parseInt(id),\r\n                            name: details.name,\r\n                            poster_path: details.poster_path,\r\n                            logo_path: enLogo,\r\n                            seasons: regularSeasons\r\n                        });\r\n                    }\r\n                } catch (err) {\r\n                    console.error(`Skipping series ${id}:`, err);\r\n                }\r\n            }\r\n\r\n            setCompletedSeries(completed);\r\n        } catch (err) {\r\n            console.error(\"Error fetching completed series:\", err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handlePosterClick = (series) => {\r\n        setSelectedSeries(series);\r\n        setShowConfirm(true);\r\n    };\r\n\r\n    const generateGraph = async () => {\r\n        setGenerating(true);\r\n        setShowConfirm(false);\r\n        try {\r\n            const seriesId = selectedSeries.id;\r\n            const [epRatingsRes, watchedRes] = await Promise.all([\r\n                supabase.from('episode_ratings').select('season_number, episode_number, rating').eq('user_id', currentUser.uid).eq('tmdb_id', seriesId),\r\n                supabase.from('watched_episodes').select('season_number, episode_number').eq('user_id', currentUser.uid).eq('tmdb_id', seriesId)\r\n            ]);\r\n\r\n            const ratingsMap = {};\r\n            epRatingsRes.data?.forEach(r => {\r\n                ratingsMap[`${r.season_number}-${r.episode_number}`] = r.rating;\r\n            });\r\n\r\n            const watchedSet = new Set();\r\n            watchedRes.data?.forEach(w => {\r\n                watchedSet.add(`${w.season_number}-${w.episode_number}`);\r\n            });\r\n\r\n            setGraphData({ ratings: ratingsMap, watched: watchedSet });\r\n        } catch (err) {\r\n            console.error(\"Data gen error:\", err);\r\n        } finally {\r\n            setGenerating(false);\r\n        }\r\n    };\r\n\r\n    const getRatingClass = (rating, isWatched) => {\r\n        if (!isWatched) return 'locked';\r\n        if (rating === undefined || rating === null || rating === 0) return 'unrated';\r\n        if (rating >= 5.0) return 'green';\r\n        if (rating >= 4.0) return 'yellow';\r\n        if (rating >= 2.0) return 'orange';\r\n        return 'red';\r\n    };\r\n\r\n    const handleShare = async () => {\r\n        if (!graphRef.current) return;\r\n\r\n        setExportMode(true);\r\n        setGenerating(true);\r\n\r\n        setTimeout(async () => {\r\n            try {\r\n                window.scrollTo(0, 0);\r\n\r\n                const canvas = await html2canvas(graphRef.current, {\r\n                    backgroundColor: '#000000',\r\n                    scale: 3,\r\n                    useCORS: true,\r\n                    allowTaint: true,\r\n                    logging: false,\r\n                    width: 1080,\r\n                    height: graphRef.current.offsetHeight,\r\n                    scrollX: 0,\r\n                    scrollY: -window.scrollY\r\n                });\r\n\r\n                const image = canvas.toDataURL('image/png', 1.0);\r\n\r\n                if (navigator.share) {\r\n                    const blob = await (await fetch(image)).blob();\r\n                    const file = new File([blob], 'poster.png', { type: 'image/png' });\r\n                    await navigator.share({\r\n                        files: [file],\r\n                        title: 'Series Rating Graph',\r\n                        text: `Check out my ratings for ${selectedSeries.name} on SERIEE!`\r\n                    });\r\n                } else {\r\n                    const link = document.createElement('a');\r\n                    link.download = `seriee_graph_${Date.now()}.png`;\r\n                    link.href = image;\r\n                    link.click();\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Export failed:\", err);\r\n            } finally {\r\n                setExportMode(false);\r\n                setGenerating(false);\r\n            }\r\n        }, 800);\r\n    };\r\n\r\n    const getCacheBustedUrl = (url) => url ? `${url}${url.includes('?') ? '&' : '?'}t=${Date.now()}` : '';\r\n\r\n    if (loading) return <PremiumLoader message=\"Loading library...\" />;\r\n\r\n    if (graphData) {\r\n        const wrapperStyle = exportMode ? {} : { transform: `scale(${scale})` };\r\n        const wrapperClass = exportMode ? 'graph-export-wrapper' : 'graph-preview-wrapper';\r\n\r\n        return (\r\n            <div className=\"fullscreen-graph-overlay\">\r\n                {!exportMode && (\r\n                    <button className=\"graph-close-btn\" onClick={() => setGraphData(null)}>\r\n                        <MdClose size={32} />\r\n                    </button>\r\n                )}\r\n\r\n                <div className={`canvas-scroll-container ${exportMode ? 'hidden-scroll' : ''}`}>\r\n                    <div className={wrapperClass} ref={wrapperRef} style={wrapperStyle}>\r\n                        <div className=\"instagram-post-canvas\" ref={graphRef}>\r\n                            <div className=\"poster-inner-payload\">\r\n                                {/* Removed Top Center Strip */}\r\n\r\n                                {/* Poster (Left) + Grid (Right) */}\r\n                                <div className=\"poster-grid-axis\">\r\n\r\n                                    {/* Left Column: UserInfo + Poster + Title */}\r\n                                    <div className=\"poster-col-vessel\">\r\n                                        {/* 1. User Info (Moved Here) */}\r\n                                        <div className=\"user-info-stack\">\r\n                                            <span className=\"reviewed-by-label\">reviewed by</span>\r\n                                            <span className=\"handle-highlight\">@{userData?.username || currentUser.displayName || 'user'}</span>\r\n                                        </div>\r\n\r\n                                        {/* 2. Poster */}\r\n                                        <div className=\"hard-square-poster\">\r\n                                            <img\r\n                                                src={getCacheBustedUrl(getResolvedPosterUrl(selectedSeries.id, selectedSeries.poster_path, globalPosters, 'w780'))}\r\n                                                alt={selectedSeries.name}\r\n                                                className=\"raw-poster-img\"\r\n                                                crossOrigin=\"anonymous\"\r\n                                            />\r\n                                        </div>\r\n\r\n                                        {/* 3. Title Card */}\r\n                                        <div className=\"title-logo-anchor\">\r\n                                            {selectedSeries.logo_path ? (\r\n                                                <img\r\n                                                    src={getCacheBustedUrl(`https://image.tmdb.org/t/p/original${selectedSeries.logo_path}`)}\r\n                                                    alt=\"Logo\"\r\n                                                    className=\"official-title-card\"\r\n                                                    crossOrigin=\"anonymous\"\r\n                                                />\r\n                                            ) : (\r\n                                                <div className=\"title-text-fallback\">{selectedSeries.name}</div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Right Column: Branding + Grid */}\r\n                                    <div className=\"grid-col-vessel\">\r\n\r\n                                        {/* 1. Branding Header (With 'reviewed on' text) */}\r\n                                        <div className=\"branding-header-right\">\r\n                                            <span className=\"reviewed-on-label\">reviewed on</span>\r\n                                            <div className=\"brand-logo-heavy\">\r\n                                                <span className=\"logo-s-gold\">S</span>\r\n                                                <span className=\"logo-text-white\">ERIEE</span>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* 2. Grid Labels */}\r\n                                        <div className=\"header-labels-s\">\r\n                                            <div className=\"spacer-e-header\"></div>\r\n                                            {selectedSeries.seasons.map(s => (\r\n                                                <div key={s.season_number} className=\"s-label-fix\">S{s.season_number}</div>\r\n                                            ))}\r\n                                        </div>\r\n\r\n                                        {/* 3. Grid Rows */}\r\n                                        <div className=\"grid-body-stack\">\r\n                                            {Array.from({ length: Math.max(...selectedSeries.seasons.map(s => s.episode_count)) }).map((_, eIdx) => (\r\n                                                <div key={eIdx} className=\"grid-row-flex\">\r\n                                                    <div className=\"e-label-fix column-e\">E{eIdx + 1}</div>\r\n                                                    {selectedSeries.seasons.map(s => {\r\n                                                        const epNum = eIdx + 1;\r\n                                                        if (epNum > s.episode_count) return <div key={s.season_number} className=\"square-cell-unit empty\"></div>;\r\n\r\n                                                        const rating = graphData.ratings[`${s.season_number}-${epNum}`];\r\n                                                        const isWatched = graphData.watched.has(`${s.season_number}-${epNum}`);\r\n                                                        const ratingClass = getRatingClass(rating, isWatched);\r\n\r\n                                                        return (\r\n                                                            <div key={s.season_number} className={`square-cell-unit rating-fill-${ratingClass}`}>\r\n                                                                {rating > 0 ? rating.toFixed(1) : (isWatched ? '0.0' : '')}\r\n                                                            </div>\r\n                                                        );\r\n                                                    })}\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {!exportMode && !generating && (\r\n                    <div className=\"graph-action-pills\">\r\n                        <button className=\"pill-btn share\" onClick={handleShare}>\r\n                            <MdShare size={20} /> Share on Story\r\n                        </button>\r\n                    </div>\r\n                )}\r\n\r\n                {generating && (\r\n                    <div className=\"generating-overlay\">\r\n                        <PremiumLoader message=\"Preparing Story...\" />\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"series-graph-container\">\r\n            <div className=\"series-graph-header\">\r\n                <h1 className=\"graph-page-title\">SERIES GRAPH</h1>\r\n                <p className=\"graph-page-subtitle\">Select a completed series</p>\r\n            </div>\r\n\r\n            {completedSeries.length === 0 ? (\r\n                <div className=\"empty-state\">\r\n                    <MdInsertChart size={64} style={{ opacity: 0.5 }} />\r\n                    <p style={{ marginTop: 20 }}>No completed series found.</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"completed-grid\">\r\n                    {completedSeries.map(series => (\r\n                        <div key={series.id} className=\"completed-card\" onClick={() => handlePosterClick(series)}>\r\n                            <div className=\"poster-container\">\r\n                                <img\r\n                                    src={`${getResolvedPosterUrl(series.id, series.poster_path, globalPosters, 'w342') || ''}?t=${Date.now()}`}\r\n                                    alt={series.name}\r\n                                    className=\"completed-poster\"\r\n                                    crossOrigin=\"anonymous\"\r\n                                />\r\n                            </div>\r\n                            <h3 className=\"series-name\">{series.name}</h3>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {showConfirm && (\r\n                <div className=\"premium-modal-overlay\">\r\n                    <div className=\"premium-confirm-modal\">\r\n                        <div className=\"modal-text\">\r\n                            <h3>Generate Graph?</h3>\r\n                            <h4 className=\"series-highlight\">{selectedSeries.name}</h4>\r\n                        </div>\r\n                        <div className=\"modal-pill-actions\">\r\n                            <button className=\"generate-pill\" onClick={generateGraph}>Generate</button>\r\n                            <button className=\"cancel-pill\" onClick={() => setShowConfirm(false)}>Cancel</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {generating && !graphData && <PremiumLoader message=\"Analyzing...\" />}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SeriesGraph;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Settings.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'theme' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"theme"},"fix":{"range":[368,374],"text":""},"desc":"Remove unused variable 'theme'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'toggleTheme' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":10,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"toggleTheme"},"fix":{"range":[373,386],"text":""},"desc":"Remove unused variable 'toggleTheme'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { MdSettings, MdLogout, MdDeleteForever, MdLightMode, MdDarkMode } from 'react-icons/md';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useTheme } from '../context/ThemeContext';\r\nimport { useNotification } from '../context/NotificationContext';\r\nimport './Home.css';\r\n\r\nconst Settings = () => {\r\n    const navigate = useNavigate();\r\n    const { theme, toggleTheme } = useTheme();\r\n    const { confirm } = useNotification();\r\n\r\n    const handleLogout = () => {\r\n        localStorage.removeItem('currentUser');\r\n        navigate('/login');\r\n    };\r\n\r\n    const handleDeleteAccount = async () => {\r\n        const isConfirmed = await confirm(\"Are you sure you want to delete your account? This action cannot be undone.\", \"Delete Account\", \"Delete\", \"Cancel\");\r\n        if (isConfirmed) {\r\n            localStorage.clear();\r\n            navigate('/login');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div style={{ maxWidth: '800px', margin: '0 auto', padding: '2rem', color: 'var(--text-primary)' }}>\r\n            <h1 style={{ fontSize: '2.5rem', fontWeight: '900', marginBottom: '40px', color: 'var(--text-primary)' }}>Settings</h1>\r\n\r\n            <div style={{ display: 'flex', flexDirection: 'column', gap: '30px' }}>\r\n                <div style={{ padding: '20px', background: 'var(--bg-secondary)', borderRadius: '8px', border: '1px solid var(--border-color)' }}>\r\n                    <h3 style={{ borderBottom: '1px solid var(--border-color)', paddingBottom: '10px', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px', color: 'var(--text-primary)' }}>\r\n                        <MdSettings /> Account Actions\r\n                    </h3>\r\n\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>\r\n                        <button\r\n                            onClick={handleLogout}\r\n                            style={{\r\n                                padding: '12px 20px',\r\n                                borderRadius: '6px',\r\n                                border: '1px solid var(--border-color)',\r\n                                background: 'transparent',\r\n                                color: 'var(--text-primary)',\r\n                                cursor: 'pointer',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '10px',\r\n                                fontWeight: 'bold',\r\n                                fontSize: '1rem',\r\n                                transition: 'background 0.2s'\r\n                            }}\r\n                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}\r\n                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}\r\n                        >\r\n                            <MdLogout size={20} /> Log Out\r\n                        </button>\r\n\r\n                        <button\r\n                            onClick={handleDeleteAccount}\r\n                            style={{\r\n                                padding: '12px 20px',\r\n                                borderRadius: '6px',\r\n                                border: 'none',\r\n                                background: '#dc3545',\r\n                                color: '#fff',\r\n                                cursor: 'pointer',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '10px',\r\n                                fontWeight: 'bold',\r\n                                fontSize: '1rem',\r\n                                transition: 'background 0.2s'\r\n                            }}\r\n                            onMouseEnter={(e) => e.currentTarget.style.background = '#bb2d3b'}\r\n                            onMouseLeave={(e) => e.currentTarget.style.background = '#dc3545'}\r\n                        >\r\n                            <MdDeleteForever size={20} /> Delete Account\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Settings;\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\Watchlist.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'db' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":12,"suggestions":[{"messageId":"removeVar","data":{"varName":"db"},"fix":{"range":[219,259],"text":""},"desc":"Remove unused variable 'db'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'doc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"doc"},"fix":{"range":[270,274],"text":""},"desc":"Remove unused variable 'doc'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDoc"},"fix":{"range":[273,281],"text":""},"desc":"Remove unused variable 'getDoc'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateDoc"},"fix":{"range":[281,292],"text":""},"desc":"Remove unused variable 'updateDoc'."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\nimport { MdStarBorder, MdRemoveCircleOutline, MdClose } from 'react-icons/md';\r\nimport { Link } from 'react-router-dom';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { db } from '../firebase-config';\r\nimport { doc, getDoc, updateDoc } from 'firebase/firestore';\r\nimport * as watchlistService from '../utils/watchlistService';\r\nimport './Home.css';\r\nimport '../pages/Home.css'; // Ensure CSS is loaded\r\n\r\nconst Watchlist = () => {\r\n    const { currentUser } = useAuth();\r\n    const [watchlist, setWatchlist] = useState([]);\r\n    const [basketData, setBasketData] = useState(null); // Replaces viewingSeriesId\r\n\r\n    useEffect(() => {\r\n        if (!currentUser) return;\r\n        const fetchWatchlist = async () => {\r\n            const wl = await watchlistService.getWatchlist(currentUser.uid);\r\n            setWatchlist(wl);\r\n        };\r\n        fetchWatchlist();\r\n    }, [currentUser]);\r\n\r\n    // Profile-style Grouping Logic (Season Baskets)\r\n    const processWatchlist = (list) => {\r\n        let processed = [];\r\n        const groups = {}; // Key: \"seriesId_SseasonNumber\"\r\n\r\n        // 1. Identify Episode Baskets\r\n        list.forEach(item => {\r\n            const itemId = item.id || item.tmdb_id;\r\n            const seriesId = item.seriesId || item.series_id || itemId;\r\n            if (item.seasonNumber && item.episodeNumber) {\r\n                const key = `${seriesId}_S${item.seasonNumber}`;\r\n                if (!groups[key]) {\r\n                    groups[key] = {\r\n                        type: 'basket',\r\n                        seriesId: seriesId,\r\n                        seasonNumber: item.seasonNumber,\r\n                        name: item.name,\r\n                        poster_path: item.poster_path,\r\n                        pluginPoster: item.seasonPoster,\r\n                        episodes: []\r\n                    };\r\n                }\r\n                groups[key].episodes.push(item);\r\n                if (!groups[key].pluginPoster && item.seasonPoster) groups[key].pluginPoster = item.seasonPoster;\r\n            }\r\n        });\r\n\r\n        // 2. Add Whole Series/Seasons (Dedupe check)\r\n        list.forEach(item => {\r\n            if (item.seasonNumber && item.episodeNumber) return; // Handled\r\n\r\n            const tmdbId = item.tmdb_id || item.id;\r\n            const seriesId = item.seriesId || item.series_id || tmdbId;\r\n            const basketKey = `${seriesId}_S${item.seasonNumber}`;\r\n            if (item.seasonNumber && groups[basketKey]) return; // Deduplicate: specific season exists as basket\r\n\r\n            processed.push({\r\n                ...item,\r\n                tmdbId: tmdbId,\r\n                seriesId: seriesId,\r\n                type: 'series',\r\n                isSeason: !!item.seasonNumber\r\n            });\r\n        });\r\n\r\n        // 3. Add Baskets to Processed\r\n        Object.values(groups).forEach(basket => {\r\n            basket.tmdbId = basket.seriesId; // Baskets are keyed by seriesId\r\n            basket.episodeCount = basket.episodes.length;\r\n            basket.episodes.sort((a, b) => a.episodeNumber - b.episodeNumber);\r\n            if (basket.pluginPoster) basket.poster_path = basket.pluginPoster;\r\n\r\n            if (basket.episodes[0]) {\r\n                const parts = basket.episodes[0].name.split(' - ');\r\n                basket.name = parts[0] + (basket.seasonNumber ? ` (Season ${basket.seasonNumber})` : '');\r\n            }\r\n\r\n            processed.push(basket);\r\n        });\r\n\r\n        return processed;\r\n    };\r\n\r\n    const removeFromWatchlist = async (e, id) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        if (!currentUser) return;\r\n\r\n        // Optimistic Update\r\n        const updated = watchlist.filter(item => (item.id || item.tmdb_id) !== id);\r\n        setWatchlist(updated);\r\n\r\n        try {\r\n            await watchlistService.removeFromWatchlist(currentUser.uid, id);\r\n        } catch (error) { console.error(error); }\r\n\r\n        // Close modal if item removed was inside\r\n        if (basketData && basketData.episodes.some(i => (i.id || i.tmdb_id) === id)) {\r\n            const newBasketEps = basketData.episodes.filter(i => (i.id || i.tmdb_id) !== id);\r\n            if (newBasketEps.length === 0) setBasketData(null);\r\n            else setBasketData({ ...basketData, episodes: newBasketEps });\r\n        }\r\n    };\r\n\r\n    const items = processWatchlist(watchlist);\r\n\r\n    return (\r\n        <div className=\"section\" style={{ padding: '20px' }}>\r\n            <h2 className=\"section-title\">Your Watchlist <span style={{ fontSize: '1rem', color: '#666', fontWeight: 'normal' }}>({watchlist.length} items)</span></h2>\r\n\r\n            {watchlist.length === 0 ? (\r\n                <div style={{ textAlign: 'center', padding: '3rem', color: '#666' }}>\r\n                    <p>Your watchlist is empty.</p>\r\n                    <Link to=\"/\" style={{ color: '#00cc33', textDecoration: 'none' }}>Browse popular titles</Link>\r\n                </div>\r\n            ) : (\r\n                <div className=\"watchlist-grid\">\r\n                    {items.map((item, idx) => (\r\n                        <div key={idx} style={{ position: 'relative' }}>\r\n                            {item.type === 'basket' ? (\r\n                                <div onClick={() => setBasketData(item)} style={{ cursor: 'pointer', display: 'block', border: 'none', aspectRatio: '2/3', position: 'relative' }}>\r\n                                    <img src={`https://image.tmdb.org/t/p/w500${item.poster_path}`} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />\r\n                                    <div style={{\r\n                                        position: 'absolute', bottom: '10px', right: '10px',\r\n                                        background: '#FFCC00', color: '#000',\r\n                                        padding: '4px 8px', borderRadius: '4px',\r\n                                        fontWeight: 'bold', fontSize: '0.8rem'\r\n                                    }}>\r\n                                        {item.episodeCount} EPS\r\n                                    </div>\r\n                                </div>\r\n                            ) : (\r\n                                <Link to={item.seasonNumber ? `/tv/${item.tmdbId}/season/${item.seasonNumber}` : `/tv/${item.tmdbId}`} style={{ display: 'block', border: 'none', aspectRatio: '2/3', position: 'relative' }}>\r\n                                    <img src={`https://image.tmdb.org/t/p/w500${item.poster_path}`} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />\r\n                                    {item.seasonNumber && !item.episodeNumber && (\r\n                                        <div style={{\r\n                                            position: 'absolute', bottom: '10px', right: '10px',\r\n                                            background: 'rgba(0,0,0,0.8)', color: '#fff',\r\n                                            padding: '4px 8px', borderRadius: '4px',\r\n                                            fontWeight: 'bold', fontSize: '0.8rem'\r\n                                        }}>\r\n                                            S{item.seasonNumber}\r\n                                        </div>\r\n                                    )}\r\n                                </Link>\r\n                            )}\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* Basket Modal/Overlay for Episodes */}\r\n            {basketData && (\r\n                <div className=\"basket-modal-overlay\" style={{\r\n                    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',\r\n                    background: 'rgba(0,0,0,0.9)', zIndex: 1000,\r\n                    display: 'flex', justifyContent: 'center', alignItems: 'center'\r\n                }}>\r\n                    <div className=\"basket-content\" style={{\r\n                        width: '90%', maxWidth: '800px', maxHeight: '80vh',\r\n                        background: '#111', overflowY: 'auto', padding: '20px',\r\n                        borderRadius: '8px', border: '1px solid #333'\r\n                    }}>\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\r\n                            <h2 style={{ margin: 0, color: '#fff' }}>{basketData.name}</h2>\r\n                            <button onClick={() => setBasketData(null)} style={{ background: 'transparent', border: 'none', color: '#fff', cursor: 'pointer' }}><MdClose size={24} /></button>\r\n                        </div>\r\n                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '20px' }}>\r\n                            {basketData.episodes.map(ep => (\r\n                                <div key={ep.id} style={{ position: 'relative' }}>\r\n                                    <Link to={`/tv/${ep.seriesId}/season/${ep.seasonNumber}/episode/${ep.episodeNumber}`}>\r\n                                        <img src={`https://image.tmdb.org/t/p/w300${ep.still_path || ep.poster_path}`} style={{ width: '100%', borderRadius: '4px' }} />\r\n                                    </Link>\r\n                                    <button onClick={(e) => removeFromWatchlist(e, ep.id)} style={{ position: 'absolute', top: 5, right: 5, background: 'rgba(0,0,0,0.7)', color: 'red', border: 'none', borderRadius: '50%', cursor: 'pointer', padding: '4px' }}>\r\n                                        <MdRemoveCircleOutline />\r\n                                    </button>\r\n                                    <div style={{ marginTop: '5px', fontSize: '0.8rem', color: '#ccc' }}>\r\n                                        S{ep.seasonNumber} E{ep.episodeNumber}\r\n                                    </div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Watchlist;\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\mernstack_internship\\letterboard\\client\\src\\pages\\user_review.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'collection' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"collection"},"fix":{"range":[292,303],"text":""},"desc":"Remove unused variable 'collection'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'query' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"query"},"fix":{"range":[302,309],"text":""},"desc":"Remove unused variable 'query'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'where' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"where"},"fix":{"range":[309,316],"text":""},"desc":"Remove unused variable 'where'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'getDocs' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":6,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"getDocs"},"fix":{"range":[316,325],"text":""},"desc":"Remove unused variable 'getDocs'."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  79 |     useEffect(() => {\n  80 |         if (stickerModalOpen && stickerData && stickerStatus === 'idle') {\n> 81 |             generateSticker();\n     |             ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  82 |         }\n  83 |     }, [stickerModalOpen, stickerData, stickerStatus]);\n  84 |","line":81,"column":13,"nodeType":null,"endLine":81,"endColumn":28},{"ruleId":"no-unused-vars","severity":2,"message":"'isSeries' is assigned a value but never used.","line":104,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"isSeries"},"fix":{"range":[4479,4496],"text":""},"desc":"Remove unused variable 'isSeries'."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react';\r\nimport { MdStar, MdDelete, MdShare, MdEdit } from 'react-icons/md';\r\nimport { useNotification } from '../context/NotificationContext';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport { db } from '../firebase-config';\r\nimport { collection, query, where, getDocs, deleteDoc, doc, updateDoc, getDoc } from 'firebase/firestore';\r\nimport * as reviewService from '../utils/reviewService';\r\n\r\nimport { Link } from 'react-router-dom';\r\nimport StorySticker from '../components/StorySticker';\r\nimport ShareModal from '../components/ShareModal';\r\nimport ReviewModal from '../components/ReviewModal';\r\nimport LoadingPopup from '../components/LoadingPopup';\r\nimport html2canvas from 'html2canvas';\r\nimport { getResolvedPosterUrl } from '../utils/globalPosterResolver';\r\nimport './Home.css';\r\n\r\nconst UserReview = () => {\r\n    const { currentUser, userData, globalPosters } = useAuth();\r\n    const [reviews, setReviews] = useState([]);\r\n    const [editModal, setEditModal] = useState({ isOpen: false, review: null });\r\n    const [deleteModal, setDeleteModal] = useState({ isOpen: false, reviewId: null, tmdbId: null, isSeries: false });\r\n\r\n\r\n    // Sticker Logic\r\n    const [stickerModalOpen, setStickerModalOpen] = useState(false);\r\n    const [stickerStatus, setStickerStatus] = useState('idle');\r\n    const [stickerData, setStickerData] = useState(null);\r\n    const [generatedStickerImage, setGeneratedStickerImage] = useState(null);\r\n    const stickerRef = useRef(null);\r\n\r\n    const generateSticker = async () => {\r\n        if (!stickerRef.current) return;\r\n        setStickerStatus('preparing');\r\n\r\n        // CRITICAL FIX: Wait for images to load before capture\r\n        await new Promise(r => setTimeout(r, 100));\r\n\r\n        // Wait for both images\r\n        const waitForImages = async () => {\r\n            const maxWait = 4000;\r\n            const startTime = Date.now();\r\n\r\n            while (Date.now() - startTime < maxWait) {\r\n                const posterLoaded = stickerRef.current?.getAttribute('data-poster-loaded') === 'true';\r\n                const pfpLoaded = stickerRef.current?.getAttribute('data-pfp-loaded') === 'true';\r\n\r\n                if (posterLoaded && pfpLoaded) return true;\r\n                await new Promise(r => setTimeout(r, 50));\r\n            }\r\n\r\n            console.warn('Image load timeout');\r\n            return false;\r\n        };\r\n\r\n        await waitForImages();\r\n        await new Promise(r => setTimeout(r, 400)); // Mobile font/layout delay\r\n\r\n        try {\r\n            const canvas = await html2canvas(stickerRef.current, {\r\n                useCORS: true, scale: 2, backgroundColor: null, width: 1080, height: 1920,\r\n                logging: false, allowTaint: false,\r\n                onclone: (clonedDoc) => {\r\n                    const el = clonedDoc.getElementById('story-sticker-element');\r\n                    if (el) { el.style.display = 'flex'; el.style.transform = 'none'; }\r\n                }\r\n            });\r\n            canvas.toBlob((blob) => {\r\n                if (!blob) return;\r\n                setGeneratedStickerImage(URL.createObjectURL(blob));\r\n                setStickerStatus('ready');\r\n            }, 'image/png');\r\n        } catch (e) {\r\n            console.error(e);\r\n            setStickerStatus('idle');\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (stickerModalOpen && stickerData && stickerStatus === 'idle') {\r\n            generateSticker();\r\n        }\r\n    }, [stickerModalOpen, stickerData, stickerStatus]);\r\n\r\n    const handleShareSticker = async () => {\r\n        if (!generatedStickerImage) return;\r\n        try {\r\n            const blob = await fetch(generatedStickerImage).then(r => r.blob());\r\n            const file = new File([blob], `Share_${Date.now()}.png`, { type: 'image/png' });\r\n            if (navigator.canShare && navigator.canShare({ files: [file] })) {\r\n                await navigator.share({ files: [file] });\r\n            } else {\r\n                const a = document.createElement('a');\r\n                a.href = generatedStickerImage; a.download = file.name;\r\n                document.body.appendChild(a); a.click(); document.body.removeChild(a);\r\n            }\r\n        } catch (e) { console.error(e); }\r\n    };\r\n\r\n    const closeStickerModal = () => {\r\n        setStickerModalOpen(false); setStickerStatus('idle'); setGeneratedStickerImage(null); setStickerData(null);\r\n    };\r\n\r\n    const handleShare = (reviewItem, isSeries = true) => {\r\n        setStickerData({\r\n            movie: {\r\n                name: reviewItem.name,\r\n                poster_path: reviewItem.poster_path, // Fallback if needed\r\n                seasonEpisode: reviewItem.isEpisode ? `S${reviewItem.seasonNumber} E${reviewItem.episodeNumber}` : (reviewItem.isSeason ? `S${reviewItem.seasonNumber}` : null)\r\n            },\r\n            rating: reviewItem.rating ? parseFloat(reviewItem.rating) * 2 : 0,\r\n            user: {\r\n                username: userData?.username || 'User',\r\n                photoURL: currentUser?.photoURL,\r\n                uid: currentUser?.uid\r\n            },\r\n            isEpisodes: reviewItem.isEpisode\r\n        });\r\n        setStickerModalOpen(true);\r\n        setStickerStatus('idle');\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (!currentUser) return;\r\n        const fetchReviews = async () => {\r\n            const fetched = await reviewService.getUserReviews(currentUser.uid);\r\n            setReviews(fetched.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));\r\n        };\r\n        fetchReviews();\r\n    }, [currentUser]);\r\n\r\n    const handleEdit = (review) => {\r\n        setEditModal({\r\n            isOpen: true,\r\n            review: review\r\n        });\r\n    };\r\n\r\n    const handleUpdateReview = async (data) => {\r\n        if (!editModal.review) return;\r\n        const reviewId = editModal.review.id;\r\n        try {\r\n            const reviewRef = doc(db, 'reviews', reviewId);\r\n            await updateDoc(reviewRef, {\r\n                rating: data.rating,\r\n                review: data.review,\r\n                updatedAt: new Date().toISOString()\r\n            });\r\n\r\n            // Update Local State\r\n            setReviews(prev => prev.map(r => r.id === reviewId ? { ...r, rating: data.rating, review: data.review } : r));\r\n            setEditModal({ isOpen: false, review: null });\r\n        } catch (error) {\r\n            console.error(\"Error updating review:\", error);\r\n        }\r\n    };\r\n\r\n    const { confirm } = useNotification();\r\n\r\n    const initiateDelete = (review, isSeries) => {\r\n        if (isSeries) {\r\n            // Open Custom Modal for Series\r\n            setDeleteModal({\r\n                isOpen: true,\r\n                reviewId: review.id,\r\n                tmdbId: review.tmdbId, // Needed to find series in user doc\r\n                isSeries: true\r\n            });\r\n        } else {\r\n            // Standard delete for episodes\r\n            handleStandardDelete(review.id);\r\n        }\r\n    };\r\n\r\n    const handleStandardDelete = async (id) => {\r\n        const isConfirmed = await confirm(\"Are you sure you want to delete this review?\", \"Delete Review\", \"Delete\", \"Cancel\");\r\n        if (isConfirmed) {\r\n            await performDelete(id);\r\n        }\r\n    };\r\n\r\n    const performDelete = async (id) => {\r\n        try {\r\n            await deleteDoc(doc(db, 'reviews', id));\r\n            const updated = reviews.filter(r => r.id !== id);\r\n            setReviews(updated);\r\n        } catch (err) {\r\n            console.error(\"Error deleting review:\", err);\r\n        }\r\n    };\r\n\r\n    const confirmSeriesDelete = async () => {\r\n        if (!deleteModal.reviewId) return;\r\n\r\n        try {\r\n            // 1. Delete the review document\r\n            await deleteDoc(doc(db, 'reviews', deleteModal.reviewId));\r\n\r\n            // 2. Remove Star Badge logic\r\n            if (currentUser && deleteModal.tmdbId) {\r\n                const userRef = doc(db, 'users', currentUser.uid);\r\n                const userSnap = await getDoc(userRef);\r\n                if (userSnap.exists()) {\r\n                    const userData = userSnap.data();\r\n                    // Filter out the series from starSeries based on ID\r\n                    // Assuming starSeries is array of objects { id, ... }\r\n                    const updatedStars = (userData.starSeries || []).filter(s => String(s.id) !== String(deleteModal.tmdbId));\r\n                    await updateDoc(userRef, { starSeries: updatedStars });\r\n                }\r\n            }\r\n\r\n            // 3. Update Local State\r\n            const updated = reviews.filter(r => r.id !== deleteModal.reviewId);\r\n            setReviews(updated);\r\n\r\n            // Close Modal\r\n            setDeleteModal({ isOpen: false, reviewId: null, isSeries: false });\r\n\r\n        } catch (err) {\r\n            console.error(\"Error deleting full review:\", err);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"section\">\r\n            <h2 className=\"section-title\">Your Reviews <span style={{ fontSize: '1rem', color: '#666', fontWeight: 'normal' }}>({reviews.length})</span></h2>\r\n\r\n            {reviews.length === 0 ? (\r\n                <div style={{ textAlign: 'center', padding: '3rem', color: '#666' }}>\r\n                    <p>You haven't reviewed anything yet.</p>\r\n                </div>\r\n            ) : (\r\n                <div className=\"reviews-list\" style={{ maxWidth: '800px' }}>\r\n                    {Object.values(reviews.reduce((acc, review) => {\r\n                        const key = review.tmdbId;\r\n                        if (!acc[key]) {\r\n                            acc[key] = {\r\n                                ...review,\r\n                                episodes: []\r\n                            };\r\n                        }\r\n                        if (review.isEpisode) {\r\n                            acc[key].episodes.push(review);\r\n                        } else {\r\n                            acc[key].seriesReview = review;\r\n                        }\r\n                        return acc;\r\n                    }, {})).map((group) => (\r\n                        <div key={group.tmdbId} style={{ background: '#222', padding: '1rem', borderRadius: '8px', marginBottom: '1rem' }}>\r\n                            <div style={{ display: 'flex', gap: '1rem' }}>\r\n                                <Link to={`/${group.type || 'tv'}/${group.tmdbId}`}>\r\n                                    {group.poster_path ? (\r\n                                        <img\r\n                                            src={getResolvedPosterUrl(group.tmdbId, group.poster_path, globalPosters, 'w92')}\r\n                                            alt={group.name}\r\n                                            style={{ borderRadius: '4px', width: '60px' }}\r\n                                        />\r\n                                    ) : (\r\n                                        <div style={{ width: '60px', height: '90px', background: '#333', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '4px' }}>\r\n                                            <span style={{ fontSize: '2rem', color: '#555' }}>?</span>\r\n                                        </div>\r\n                                    )}\r\n                                </Link>\r\n\r\n                                <div style={{ flex: 1 }}>\r\n                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>\r\n                                        <Link to={`/${group.type || 'tv'}/${group.tmdbId}`} style={{ color: 'white', textDecoration: 'none', fontWeight: 'bold', fontSize: '1.2rem' }}>\r\n                                            {group.name}\r\n                                        </Link>\r\n                                    </div>\r\n\r\n                                    {/* Main Series Review if exists */}\r\n                                    {group.seriesReview && !group.seriesReview.isEpisode && (\r\n                                        <div style={{ marginBottom: '1rem', borderBottom: group.episodes.length ? '1px solid #333' : 'none', paddingBottom: '1rem' }}>\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>\r\n                                                <div style={{ color: '#FFCC00', fontWeight: 'bold', fontSize: '0.9rem', marginBottom: '5px' }}>SERIES REVIEW</div>\r\n                                                <div style={{ display: 'flex', gap: '8px' }}>\r\n                                                    <button onClick={() => handleEdit(group.seriesReview)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer' }} title=\"Edit Review\">\r\n                                                        <MdEdit />\r\n                                                    </button>\r\n                                                    <button onClick={() => handleShare(group.seriesReview, true)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer' }} title=\"Share Story\">\r\n                                                        <MdShare />\r\n                                                    </button>\r\n                                                    <button onClick={() => initiateDelete(group.seriesReview, true)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer' }}><MdDelete /></button>\r\n                                                </div>\r\n                                            </div>\r\n                                            <div style={{ display: 'flex', color: '#00cc33', marginBottom: '5px' }}>\r\n                                                {[...Array(5)].map((_, i) => (\r\n                                                    <MdStar key={i} color={i < group.seriesReview.rating ? \"#00cc33\" : \"#444\"} />\r\n                                                ))}\r\n                                            </div>\r\n                                            <p style={{ color: '#ccc', fontSize: '0.9rem' }}>{group.seriesReview.review}</p>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Episode Reviews List */}\r\n                                    {group.episodes.length > 0 && (\r\n                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n                                            {group.episodes.map(ep => (\r\n                                                <div key={ep.id} style={{ background: '#1a1a1a', padding: '10px', borderRadius: '4px' }}>\r\n                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '5px' }}>\r\n                                                        <div style={{ fontWeight: 'bold', color: '#fff', fontSize: '0.95rem' }}>S{ep.seasonNumber}E{ep.episodeNumber} - {ep.episodeName}</div>\r\n                                                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>\r\n                                                            <button onClick={() => handleEdit(ep)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer', fontSize: '0.8rem' }} title=\"Edit Review\">\r\n                                                                <MdEdit size={14} />\r\n                                                            </button>\r\n                                                            <button onClick={() => handleShare(ep, false)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer', fontSize: '0.8rem' }} title=\"Share Story\">\r\n                                                                <MdShare size={14} />\r\n                                                            </button>\r\n                                                            <button onClick={() => initiateDelete(ep, false)} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer', fontSize: '0.8rem' }}>Delete</button>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                    <div style={{ display: 'flex', color: '#FFCC00', marginBottom: '5px' }}>\r\n                                                        {[...Array(5)].map((_, i) => (\r\n                                                            <MdStar key={i} size={14} color={i < ep.rating ? \"#FFCC00\" : \"#444\"} />\r\n                                                        ))}\r\n                                                    </div>\r\n                                                    <p style={{ color: '#aaa', fontSize: '0.9rem', margin: 0 }}>{ep.review}</p>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                </div>\r\n            )}\r\n\r\n            {/* NEW STORY STICKER MODAL */}\r\n            {stickerModalOpen && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',\r\n                    background: 'rgba(0,0,0,0.95)', zIndex: 10000,\r\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                    flexDirection: 'column'\r\n                }}>\r\n                    {stickerStatus === 'preparing' && <LoadingPopup />}\r\n                    {stickerStatus === 'ready' && generatedStickerImage && (\r\n                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', width: '100%', height: '100%' }}>\r\n                            <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', maxWidth: '400px' }}>\r\n                                <img src={generatedStickerImage} style={{ width: '100%', borderRadius: '16px' }} />\r\n                            </div>\r\n                            <div style={{ padding: '30px', display: 'flex', gap: '20px', width: '100%', justifyContent: 'center', background: '#000' }}>\r\n                                <button onClick={closeStickerModal} style={{ background: '#333', color: 'white', padding: '16px 32px', borderRadius: '50px', border: 'none' }}>Close</button>\r\n                                <button onClick={handleShareSticker} style={{ background: '#FFD600', color: 'black', padding: '16px 32px', borderRadius: '50px', border: 'none', fontWeight: 'bold' }}>Share</button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                    {/* Hidden Render Target (Using opacity 0 to ensure images load) */}\r\n                    <div style={{ position: 'absolute', top: 0, left: 0, opacity: 0, pointerEvents: 'none', zIndex: -1000, width: '1080px', height: '1920px', overflow: 'hidden' }}>\r\n                        {stickerData && (\r\n                            <StorySticker\r\n                                ref={stickerRef}\r\n                                movie={stickerData.movie}\r\n                                rating={stickerData.rating}\r\n                                user={stickerData.user}\r\n                                isEpisodes={stickerData.isEpisodes}\r\n                                globalPosters={globalPosters}\r\n                            />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <ReviewModal\r\n                isOpen={editModal.isOpen}\r\n                onClose={() => setEditModal({ isOpen: false, review: null })}\r\n                onSubmit={handleUpdateReview}\r\n                initialRating={editModal.review?.rating || 0}\r\n                initialReview={editModal.review?.review || ''}\r\n                modalTitle=\"Edit Review\"\r\n                movieName={editModal.review?.name || 'Review'}\r\n            />\r\n\r\n            {/* Custom Delete Confirmation Modal */}\r\n            {deleteModal.isOpen && (\r\n                <div style={{\r\n                    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',\r\n                    background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                    zIndex: 20000, backdropFilter: 'blur(4px)', padding: '20px'\r\n                }} onClick={() => setDeleteModal({ ...deleteModal, isOpen: false })}>\r\n                    <div style={{\r\n                        background: '#191919', // Prime Dark\r\n                        padding: '30px',\r\n                        width: '100%',\r\n                        maxWidth: '400px',\r\n                        textAlign: 'center',\r\n                        borderRadius: '8px',\r\n                        border: 'none',\r\n                        boxShadow: '0 10px 30px rgba(0,0,0,0.5)',\r\n                        fontFamily: '\"Amazon Ember\", Arial, sans-serif'\r\n                    }} onClick={e => e.stopPropagation()}>\r\n                        <h3 style={{\r\n                            color: '#ffffff',\r\n                            fontSize: '1.2rem',\r\n                            fontWeight: '700',\r\n                            marginBottom: '15px',\r\n                            textTransform: 'uppercase',\r\n                            letterSpacing: '0.5px',\r\n                            fontFamily: '\"Amazon Ember\", Arial, sans-serif'\r\n                        }}>\r\n                            Are you sure you want to delete this full review?\r\n                        </h3>\r\n                        <p style={{\r\n                            color: '#bbbbbb',\r\n                            fontSize: '0.95rem',\r\n                            marginBottom: '25px',\r\n                            lineHeight: '1.5'\r\n                        }}>\r\n                            You will lose the Star Badge for this series.\r\n                        </p>\r\n                        <div style={{ display: 'flex', justifyContent: 'center', gap: '15px' }}>\r\n                            <button onClick={() => setDeleteModal({ ...deleteModal, isOpen: false })} style={{\r\n                                background: 'transparent',\r\n                                color: '#f2f2f2',\r\n                                border: '1px solid #555',\r\n                                padding: '10px 30px',\r\n                                fontSize: '0.9rem',\r\n                                fontWeight: '600',\r\n                                cursor: 'pointer',\r\n                                textTransform: 'uppercase',\r\n                                borderRadius: '4px',\r\n                                fontFamily: '\"Amazon Ember\", Arial, sans-serif'\r\n                            }}>\r\n                                No\r\n                            </button>\r\n                            <button onClick={confirmSeriesDelete} style={{\r\n                                background: '#EDF1F3', // Prime White\r\n                                color: '#0F1111',\r\n                                border: '1px solid #EDF1F3',\r\n                                padding: '10px 30px',\r\n                                fontSize: '0.9rem',\r\n                                fontWeight: '700',\r\n                                cursor: 'pointer',\r\n                                textTransform: 'uppercase',\r\n                                borderRadius: '4px',\r\n                                fontFamily: '\"Amazon Ember\", Arial, sans-serif',\r\n                                boxShadow: '0 2px 5px rgba(0,0,0,0.1)'\r\n                            }}>\r\n                                Yes, Delete\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n        </div>\r\n    );\r\n};\r\nexport default UserReview;\r\n","usedDeprecatedRules":[]}]